//account.js
var account={loginProvider:null,loginToken:null,providers:{google:{signIn:function(){var a=window.gapi.auth2.getAuthInstance();a.isSignedIn&&(a=a.currentUser.get(),account.loginToken=a.getAuthResponse().id_token,$.ajax({type:"POST",url:"/webservices/UserAdmin.asmx/ProviderSignIn",data:JSON.stringify({provider:"google",token:account.loginToken}),contentType:"application/json; charset=utf-8",dataType:"json",success:function(b){b=agent.helpers.translate;editing.helpers.setStatus(b("LoginSuccessful"));
editing.ui.teardown(!0);agent.helpers.loadConfig();account.loginProvider=account.providers.google},failure:function(){editing.helpers.setStatus(t("LoginFailed"))}}))},signOut:function(a){var b=gapi.auth2.getAuthInstance();b.disconnect();b.signOut().then(a)}}},showAccountMenu:function(){var a=agent.helpers.translate,b=agent.config.accountDetails.shortName;""===b&&(b="Local");b={page:"render_simple",OKOnly:!0,isMenu:!0,data:{header:b,okResult:"",items:[]}};b.data.items.push({value:a("Account"),type:"Header"});
b.data.items.push({value:editing.helpers.buttonIcon2("fa-user",a("AccountSettings")),type:"ButtonIcon",action:"editAccount"});agent.server&&agent.server.isAccess||(b.data.items.push({value:editing.helpers.buttonIcon2("fa-credit-card",a("ChangeSubscription")),type:"ButtonIcon",action:"subscribe"}),b.data.items.push({value:editing.helpers.buttonIcon2("fa-comments",a("PurchaseCredits")+" ("+agent.config.smsCredits+")"),type:"ButtonIcon",action:"purchaseCredits"}),b.data.items.push({value:editing.helpers.buttonIcon2("fa-history",
a("PaymentHistory")),type:"ButtonIcon",action:"paymentHistory"}));b.data.items.push({value:editing.helpers.buttonIcon2("fa-users",a("Permissions")),type:"ButtonIcon",action:"permissions"});window.isLocal?b.data.items.push({value:editing.helpers.buttonIcon2("fa-plug",a("RemoteAccess")),type:"ButtonIcon",action:"remoteAccess"}):b.data.items.push({value:editing.helpers.buttonIcon2("fa-sign-out",a("SignOut")),type:"ButtonIcon",action:"logout"});b.data.items.push({value:a("UserInterface"),type:"Header"});
b.data.items.push({value:editing.helpers.buttonIcon2("fa-font",a("ChangeTheme")),type:"ButtonIcon",action:"changeTheme"});b.data.items.push({value:editing.helpers.buttonIcon2("fa-language",a("Language")),type:"ButtonIcon",action:"selectLanguage"});b.data.items.push({value:editing.helpers.buttonIcon2("fa-flag",a("NotificationSettings")),type:"ButtonIcon",action:"notificationSettings"});agent.isApp||agent.isPWA||!agent.deferredPrompt||b.data.items.push({value:editing.helpers.buttonIcon2("fa-expand",
a("InstallPWA")),type:"ButtonIcon",action:"installPWA"});b.data.items.push({value:a("Server"),type:"Header"});b.data.items.push({value:editing.helpers.buttonIcon2("fa-server",a("ChangeServer")),type:"ButtonIcon",action:"changeServer"});b.data.items.push({value:editing.helpers.buttonIcon2("fa-map-signs",a("ChangePlatform")),type:"ButtonIcon",action:"changePlatform"});a=ko.mapping.fromJS(b);editing.renderObjects.push(a);editing.helpers.renderPage()},showNotificationSettings:function(){var a=agent.helpers.translate,
b={page:"render_simple",OKOnly:!0,data:{header:a("NotificationSettings"),okResult:"setNotifications",items:[{text:a("NewRecording"),value:"true"===agent.storage.get("notify_recordings","true"),type:"Boolean"},{text:a("Alerts"),value:"true"===agent.storage.get("notify_alerts","true"),type:"Boolean"},{text:a("AlertAlarm"),value:"true"===agent.storage.get("notify_alarm","false"),type:"Boolean"}]}};window.isLocal?b.data.items.push({value:a("PushAlerts"),type:"Button",action:"remoteAccess"}):b.data.items.push({text:a("PushAlerts"),
value:"none"!==agent.config.pushPlatform,type:"Boolean",help:a("PushAlerts_help")});a=ko.mapping.fromJS(b);editing.renderObjects.push(a);editing.helpers.renderPage()},setNotifications:function(a){a=ko.mapping.toJS(a).data.items;agent.storage.set("notify_recordings",a[0].value);agent.storage.set("notify_alerts",a[1].value);agent.storage.set("notify_alarm",a[2].value);window.isLocal||(a[3].value?agent.isApp?account.pushNotifications.checkApps():agent.isAndroid||agent.isIOS||agent.notifications.setNativeNotifications():
account.pushNotifications.disable())},resetEmailBlock:function(){$.ajax({type:"POST",url:"/webservices/UserAdmin.asmx/RemoveBlock",contentType:"application/json; charset=utf-8",dataType:"json",success:function(a){var b=agent.helpers.translate;"OK"===a.d?editing.helpers.setStatus(b("BlockRemoved")):editing.helpers.setStatus(a.d)},failure:account.failed})},showLoginChoice:function(){var a=agent.helpers.translate;a={page:"render_simple",hideFooter:!0,name:"loginChoice",data:{header:"Agent",okResult:"",
items:[{text:a("Language"),value:agent.language.current,type:"Select",options:[],action:"changeLanguage"},{text:"",type:"Button",value:a("Login"),action:"showLogin",index:0},{text:"",type:"Button",value:a("NewAccount"),action:"showLogin",index:2},{text:"",type:"HTML",value:'<div id="goog-signin2"></div>'}]}};for(var b in agent.language.available)a.data.items[0].options.push({text:agent.language.available[b],value:b});b=ko.mapping.fromJS(a);b.generator=account.showLoginChoice;editing.renderObjects.push(b);
editing.helpers.renderPage("sm");window.gapi.signin2.render("goog-signin2",{width:120,onsuccess:account.providers.google.signIn})},showLanguageChoice:function(){var a=agent.helpers.translate;a={page:"render_simple",name:"languageChoice",OKOnly:!0,data:{header:a("Language"),okResult:"",items:[{text:a("Language"),value:agent.language.current,type:"Select",options:[],action:"changeLanguage"}]}};for(var b in agent.language.available)a.data.items[0].options.push({text:agent.language.available[b],value:b});
b=ko.mapping.fromJS(a);b.generator=account.showLanguageChoice;editing.renderObjects.push(b);editing.helpers.renderPage("sm")},showLogin:function(a){a||(a=0);var b=agent.helpers.readCookie("un",""),c=agent.helpers.translate,d=c("Login"),f="Login";switch(a){case 1:d=c("ForgottenPassword");f="Forgotten Password";break;case 2:d=c("NewAccount"),f="New Account"}a={page:"render",suppressClose:!1,OKOnly:!1,name:"login",currentSection:d,currentTab:f,data:{header:c("Account"),okResult:"RunAccountForm",sections:[{header:c("Login"),
displayType:"Form",tabActive:0===a,name:"Login",items:[{text:c("Username"),value:b,type:"String"},{text:c("Password"),value:"",type:"Password"},{text:c("Remember"),value:!1,type:"Boolean"}]},{header:c("ForgottenPassword"),displayType:"Form",tabActive:1===a,name:"Forgotten Password",items:[{text:c("Email"),value:"",type:"String",help:c("Email_help")}]},{header:c("NewAccount"),displayType:"Form",tabActive:2===a,name:"New Account",items:[{text:c("Username"),value:"",type:"String"},{text:c("Email"),value:"",
type:"String"},{text:c("Password"),value:"",type:"Password"},{text:c("ConfirmPassword"),value:"",type:"Password"},{text:c("MobileNumber"),value:"",type:"String",help:c("MobileNumber_help")},{text:c("Remember"),value:!1,type:"Boolean"}]}]}};a=ko.mapping.fromJS(a);editing.renderObjects.push(a);editing.helpers.renderPage("md");agent.menuCanvas.lastDraw=0},signOut:function(){function a(){agent.helpers.eraseCookie("pwd");$.ajax({type:"POST",url:"/webservices/UserAdmin.asmx/SignOut",data:"{}",contentType:"application/json; charset=utf-8",
dataType:"json",success:null,failure:null});comms.deinit();agent.helpers.setState("failed");editing.ui.teardown();agent.config=null;agent.server=null;setTimeout(account.showLoginChoice,account.loginProvider?3E3:0);account.loginProvider=null}account.loginProvider?account.loginProvider.signOut(a):a()},processAccountForm:function(a){var b=ko.mapping.toJS(a);a=b.data.sections[0];switch(b.currentTab){case "Login":b=a.items[0].value;var c=a.items[1].value;(a=a.items[2].value)?(agent.helpers.createCookie("un",
b,30),agent.helpers.createCookie("pwd",c,30)):(agent.helpers.eraseCookie("un"),agent.helpers.eraseCookie("pwd"));$.ajax({type:"POST",url:"/webservices/UserAdmin.asmx/Login2",data:JSON.stringify({username:b,password:c}),contentType:"application/json; charset=utf-8",dataType:"json",success:function(g){var h=agent.helpers.translate;switch(g.d){case "OK":editing.helpers.setStatus(h("LoginSuccessful"));editing.ui.teardown(!0);account.loginProvider=null;agent.helpers.loadConfig();break;case "NOK":editing.helpers.setStatus(h("LoginFailed"));
break;default:editing.helpers.setStatus(agent.helpers.translate(g.d))}},failure:account.failed});break;case "Forgotten Password":a=b.data.sections[1];var d=a.items[0].value;$.ajax({type:"POST",url:"/webservices/UserAdmin.asmx/Recover",data:JSON.stringify({email:d}),contentType:"application/json; charset=utf-8",dataType:"json",success:function(g){var h=agent.helpers.translate;"OK"===g.d?editing.helpers.setStatus(h("LinkSent")):editing.helpers.setStatus(agent.helpers.translate(g.d))},failure:account.failed});
break;case "New Account":a=b.data.sections[2];b=a.items[0].value;d=a.items[1].value;c=a.items[2].value;var f=a.items[3].value;var e=a.items[4].value;(a=a.items[5].value)?(agent.helpers.createCookie("un",b,30),agent.helpers.createCookie("pwd",c,30)):(agent.helpers.eraseCookie("un"),agent.helpers.eraseCookie("pwd"));$.ajax({type:"POST",url:"/webservices/UserAdmin.asmx/Register2",data:JSON.stringify({username:b,password:c,passwordConfirm:f,email:d,phoneNumber:e}),contentType:"application/json; charset=utf-8",
dataType:"json",success:function(g){var h=agent.helpers.translate;"OK"===g.d?(editing.helpers.setStatus(h("AccountCreated")),editing.ui.teardown(!0),account.loginProvider=null,agent.helpers.loadConfig()):editing.helpers.setStatus(agent.helpers.translate(g.d))},failure:account.failed})}},failed:function(){var a=agent.helpers.translate;editing.helpers.setStatus(a("ConnectionFailed"))},showEdit:function(){if(window.isLocal)editing.goRemote();else{var a=agent.config.accountDetails;"undefined"===typeof a.newsletter&&
(a.newsletter=!1);var b=agent.helpers.translate;a={page:"render",suppressClose:!0,data:{header:"Account Details",okResult:"UpdateAccount",sections:[{header:"Account Details",displayType:"Form",tabActive:!0,items:[{text:b("Username"),value:a.username,type:"String"},{text:b("Email"),value:a.email,type:"String"},{text:b("Password"),value:"NOTCHANGED",type:"Password"},{text:b("ConfirmPassword"),value:"NOTCHANGED",type:"Password"},{text:b("MobileNumber"),value:a.mobileNumber,type:"String",help:b("MobileNumber_help")},
{text:b("GMTOffset"),value:a.timeZone,type:"Int32",min:-14,max:14},{text:b("EnableReset"),value:a.enablePasswordReset,type:"Boolean"},{text:b("Newsletter"),value:a.newsletter,type:"Boolean"}]}]}};a=ko.mapping.fromJS(a);editing.renderObjects.push(a);editing.helpers.renderPage()}},update:function(a){a=ko.toJS(a);var b=a.data.sections[0].items;$.ajax({arr:a.data.sections[0].items,type:"POST",url:"/webservices/UserAdmin.asmx/Update",data:JSON.stringify({username:b[0].value,password:b[2].value,passwordConfirm:b[3].value,
email:b[1].value,phoneNumber:b[4].value,timeZone:b[5].value,enableReset:b[6].value,newsletter:b[7].value,useSSL:!1}),contentType:"application/json; charset=utf-8",dataType:"json",success:function(c){"OK"===c.d?(c=agent.helpers.translate,editing.helpers.setStatus(c("AccountUpdated")),c=agent.config.accountDetails,c.username=this.arr[0].value,c.shortName=agent.helpers.shorten(c.username,14),c.email=this.arr[1].value,c.mobileNumber=this.arr[4].value,c.timeZone=this.arr[5].value,c.enablePasswordReset=
this.arr[6].value,c.newsletter=this.arr[7].value,editing.ui.teardown()):editing.helpers.setStatus(agent.helpers.translate(c.d))},failure:account.failed})},paymentHistory:{load:function(){if(window.isLocal)editing.goRemote();else{var a=agent.helpers.translate;editing.helpers.setStatus(a("Loading"));$.ajax({type:"GET",url:"script/config.aspx?subset=paymentHistory",dataType:"json",success:function(b){var c=agent.helpers.translate;editing.helpers.setStatus("");b.configuration&&b.configuration.failed?
account.signOut():(c={page:"payment_history",data:{header:c("PaymentHistory"),okResult:"",items:[]}},c.data.items=b,b=ko.mapping.fromJS(c),b.translate=function(d){return agent.helpers.translate(d)},b.genLink=function(d){return"/userguide/receipt.aspx?tid="+d.id()},editing.renderObjects.push(b),editing.helpers.renderPage())},failure:account.failed})}}},permissions:{list:null,save:function(){for(var a="",b=account.permissions.list,c=0;c<b.length;c++){var d=b[c];a+=d.id+"|"+d.email+"|"+d.readOnly+"|"+
d.ptz+"|"+d.accessMask+"|true\n"}$.ajax({type:"POST",url:"/webservices/UserAdmin.asmx/SavePermissions",data:JSON.stringify({permissions:a}),contentType:"application/json; charset=utf-8",dataType:"json",success:function(f){var e=agent.helpers.translate;"OK"===f.d?(editing.helpers.setStatus(e("AccountUpdated")),editing.ui.teardown()):editing.helpers.setStatus(e(f.d))},failure:account.failed})},"delete":function(a){account.permissions.list.splice(a,1);editing.renderObjects.pop();account.permissions.show()},
add:function(){account.permissions.showEdit({id:-1,email:"",readOnly:!1,ptz:!0,accessMask:agent.server.name,index:-1})},edit:function(a){account.permissions.showEdit(account.permissions.list[a])},update:function(a){if(-1===a.index){var b={id:-1,email:"",readOnly:!1,ptz:!0,accessMask:agent.server.name,index:account.permissions.list.length};account.permissions.list.push(b)}else b=account.permissions.list[a.index];b.email=a.items[0].value;b.ptz=a.items[1].value;b.readOnly=a.items[2].value;b.accessMask=
a.items[3].value;editing.renderObjects.pop();account.permissions.show()},showEdit:function(a){var b=agent.helpers.translate;a={page:"render_simple",data:{header:b("Permissions"),okResult:"updatePermission",id:a.id,index:a.index,items:[{text:b("Email"),value:a.email,type:"String"},{text:"PTZ",value:a.ptz,type:"Boolean"},{text:b("ReadOnly"),value:a.readOnly,type:"Boolean"},{text:b("Groups"),value:a.accessMask,type:"String"}]}};a=ko.mapping.fromJS(a);editing.renderObjects.push(a);editing.helpers.renderPage("md")},
load:function(){if(window.isLocal)editing.goRemote();else{var a=agent.helpers.translate;editing.helpers.setStatus(a("Loading"));$.ajax({type:"GET",url:"script/config.aspx?subset=accessPermissions",dataType:"json",success:function(b){b.configuration&&b.configuration.failed?account.signout():(account.permissions.list=b,account.permissions.show())},failure:account.failed})}},formatPermission:function(a,b){var c=agent.helpers.translate;a.text=a.email;var d="";a.readOnly&&(d+=c("ReadOnly"));a.ptz&&(d+=
" PTZ");""!==d&&(a.text+=" ("+d+")");a.text+="<br/>"+a.accessMask;a.index=b},show:function(){var a=agent.helpers.translate;a={page:"render",name:"editPermissions",suppressClose:!0,data:{header:a("Permissions"),okResult:"savePermissions",sections:[{header:a("Permissions"),displayType:"TableEdit",tabActive:!0,editJSON:"editPermission",deleteJSON:"deletePermission",addJSON:"addPermission",items:[]}]}};for(var b=account.permissions.list,c=0;c<b.length;c++)account.permissions.formatPermission(b[c],c);
a.data.sections[0].items=account.permissions.list;a=ko.mapping.fromJS(a);editing.renderObjects.push(a);editing.helpers.renderPage("md")},reload:function(){}},smsCredits:{load:function(){if(window.isLocal)editing.goRemote();else{var a=agent.helpers.translate;editing.helpers.setStatus(a("Loading"));$.ajax({type:"GET",url:"script/config.aspx?subset=rechargeList",dataType:"json",success:function(b){b.configuration&&b.configuration.failed?account.signout():(agent.config.rechargeList=b,account.smsCredits.show())},
failure:account.failed})}},show:function(){var a=agent.helpers.translate;a={page:"render_simple",data:{header:a("PurchaseCredits"),okResult:"",items:[]}};for(var b=0;b<agent.config.rechargeList.length;b++){var c=agent.config.rechargeList[b];a.data.items.push({value:c.credits+" SMS: $"+c.price,type:"Button",action:"recharge",index:b})}a=ko.mapping.fromJS(a);editing.renderObjects.push(a);editing.helpers.renderPage()},purchase:function(a){var b=agent.helpers.translate;editing.helpers.setStatus(b("Loading"));
a=agent.config.rechargeList[a];b=$("#pp_purchase").contents();b.find("#amount").val(a.price);b.find("#notify_url").val(agent.config.URL.replace("http:","https:")+"/IPN.aspx?rechargeid="+a.id);b.find("#item_name").val("Agent SMS Credits");b.find("#item_number").val(agent.config.accountDetails.id);b.find("#currency_code").val(agent.config.currency);b.find("#paypalForm").submit()}},subscriptions:{unsubscribe:function(){var a=agent.helpers.translate;editing.helpers.setStatus(a("Loading"));$.ajax({type:"POST",
url:"/webservices/UserAdmin.asmx/CancelSubscription",data:"",contentType:"application/json; charset=utf-8",dataType:"json",success:function(b){var c=agent.helpers.translate;"OK"===b.d?editing.helpers.setStatus(c("SubscriptionCancelled"),6E3,null,!0):editing.helpers.setStatus(b.d)},failure:account.failed})},showCancel:function(){var a=agent.helpers.translate;a={page:"render_simple",data:{header:a("Subscriptions"),okResult:"",items:[{value:a("CancelInfo"),type:"Info"},{text:a("Expires"),value:agent.config.subscriptionDateString,
type:"Info"},{value:a("CancelSubscription"),type:"Button",action:"unsubscribe"},{value:a("Skip"),type:"Button",action:"forceSubscribe"}]}};a=ko.mapping.fromJS(a);editing.renderObjects.push(a);editing.helpers.renderPage()},load:function(){if(agent.config.subscriptionTypes)return account.subscriptions.show();var a=agent.helpers.translate;editing.helpers.setStatus(a("Loading"));$.ajax({type:"GET",url:"script/config.aspx?subset=subscriptions",dataType:"json",success:function(b){b.configuration&&b.configuration.failed?
account.signout():(agent.config.subscriptionTypes=b.sort(function(c,d){return c.servers===d.servers?c.months-d.months:c.servers-d.servers}),account.subscriptions.show())},failure:account.failed})},show:function(){for(var a=agent.helpers.translate,b={page:"render",name:"subscriptions",OKOnly:!0,data:{header:a("Subscriptions"),okResult:"",sections:[]}},c=null,d=0,f=0;f<agent.config.subscriptionTypes.length;f++){var e=agent.config.subscriptionTypes[f];if(null===c||e.servers>c.servers)null!==c&&b.data.sections.push(c),
1===d&&(b.currentSection=e.displayName),c={header:e.displayName,displayType:"Form",tabActive:1===d,items:[],servers:e.servers},c.items.push({type:"Header",text:e.displayName,help:a("Subscribe_help")}),c.items.push({type:"Info",value:e.servers+" "+(1===e.servers?a("ServerConnected"):a("ServersConnected"))}),1===e.servers?c.items.push({type:"Info",value:a("SDStreaming")}):(c.items.push({type:"Info",value:a("HDStreaming")}),c.items.push({type:"Info",value:a("Permissions")})),c.items.push({type:"Info",
value:a("SoftwareUpdates")}),d++;switch(e.months){case 1:c.items.push({text:"Monthly",type:"Button",value:"$"+e.price+" - "+a("BuyNow"),action:"chooseSubscription",index:f});c.items.push({type:"Header",text:"PrePay:"});break;default:c.items.push({text:e.months+" Months",type:"Button",value:"$"+e.price+" - "+a("BuyNow"),action:"chooseSubscription",index:f})}0<e.smsCredits&&c.items.push({type:"Info",value:e.smsCredits+" "+a("CreditsIncluded")})}b.data.sections.push(c);a=ko.mapping.fromJS(b);editing.renderObjects.push(a);
editing.helpers.renderPage("md")},purchase:function(a){var b=agent.helpers.translate;editing.helpers.setStatus(b("Loading"));a=agent.config.subscriptionTypes[a];b=$("#pp_subscribe").contents();a.isPrePay?(b.find("#btnCMD").val("_xclick"),b.find("#amount").val(a.price)):(b.find("#btnCMD").val("_xclick-subscriptions"),b.find("#amt_sub").val(a.price));b.find("#item_name").val(a.description.replace("iSpy","Agent"));b.find("#currency_code").val(agent.config.currency);b.find("#notify_url").val(agent.config.URL.replace("http:",
"https:")+"/IPN.aspx?subtypeid="+a.id);b.find("#item_number").val(agent.config.accountDetails.id);b.find("#paypalForm").submit()}},plugins:{check:function(a,b){$.ajax({type:"POST",url:"/webservices/UserAdmin.asmx/CheckPlugin",data:JSON.stringify({plugin:a.name}),contentType:"application/json; charset=utf-8",dataType:"json",success:function(c){var d=agent.helpers.translate;c=JSON.parse(c.d);if(c.error)editing.helpers.setStatus(c.error);else{if(!c.paid){if(c.expired){editing.helpers.setStatus(d("Expired"));
return}""!==c.msg&&editing.helpers.setStatus(c.msg)}b()}},failure:account.failed})}},pushNotifications:{checkApps:function(){console.log("Checking Apps");agent.isAndroidApp&&(console.log("Android"),"function"===typeof window.ANDROID_Notifications.GetToken&&account.pushNotifications.setupPlatform("mobile",window.ANDROID_Notifications.GetToken()));agent.isIOSApp&&(location.href="myapp://interface?action=registerfcm")},setWebPush:function(a){a=JSON.stringify(a);account.pushNotifications.setupPlatform("web",
a)},disable:function(){account.pushNotifications.setupPlatform("none","")},setupPlatform:function(a,b){$.ajax({type:"POST",url:"/webservices/UserAdmin.asmx/SetPushNotifications",data:JSON.stringify({platform:a,data:b}),contentType:"application/json; charset=utf-8",dataType:"json",success:function(c){"OK"===c.d?agent.config.pushPlatform=a:editing.helpers.setStatus(c.d)},failure:account.failed})}}},iSpy={helper:{firebase:{setToken:function(a){account.pushNotifications.setupPlatform("mobile",a)}}}};

//agent.js
var agent={config:null,mainCanvas:null,inited:!1,preloader:null,errorMessage:null,vrRunning:!1,viewIndex:0,ctx:null,docTitle:"Agent DVR",minWindowWidthForSidebar:700,minWindowWidthForFullTopMenu:600,maxFileOperations:150,FontAwesome:function(a){return a+'px "FontAwesome"'},swipeInterval:500,size:{w:0,h:0},server:null,tooltips:!0,menu:{autoHide:!1,timestamp:null,show:function(){agent.menu.timestamp=new Date},shouldShow:function(){return agent.playback.active?!1:agent.screen===agent.screens.live&&agent.menu.autoHide?
null===agent.timestamp||3E3<new Date-agent.menu.timestamp?!1:!0:!0}},labels:!1,shortcutKeys:!0,theme:null,servicesConnected:!0,applyFPSLimiter:!0,deferredPrompt:null,firstClick:!0,suppressLiveUpdates:!1,promptedNotifications:!1,applicationServerKey:"BHHHZ3yjh4yjOWYqUEjq78LAq5uzYdi4D_qSs9t7JdNz3IbIC3oWP7rQtifFZVJF00uDb0uERHJDnhMbFl2r9g8",swRegistration:null,language:{current:"en",available:{en:"English",cs:"\u010ce\u0161tina",de:"Deutsche",es:"Espa\u00f1ol",fr:"Fran\u00e7ais",it:"Italiano",nl:"Nederlands",
pl:"Polskie",pt:"Portugu\u00eas",ru:"\u0420\u0443\u0441\u0441\u043a\u0438\u0439",zh:"\u4e2d\u6587",zh_TW:"\u7e41\u4f53\u4e2d\u6587"}},scrollbars:{minHeight:50,width:32},menuCanvas:null,timeFormat:"MMM dd yyyy hh:mm:ss t",playback:null,alarmSound:null,screen:null,state:"loading",currentObject:null,canAutoPlay:!0,videoPlayer:null,scriptVersion:"1.0.3",touchClickRadius:20,promptedClaim:!1,maxHeight:0,maxWidth:0,isPWA:!1,storage:{get:function(a,b){var c=window.localStorage;if(c){var e=c.getItem(a);if(e)return e;
c.setItem(a,b)}return b},set:function(a,b){var c=window.localStorage;c&&c.setItem(a,b)}},sizes:null,search:{from:null,to:null,tags:"",timelapse:!1,activity:[0,100],apply:!1,filter:function(){function a(k){var l=agent.search;if(l.from&&l.to){var m=k.date.getTime();if(m<l.from||m>l.to)return!1}if("Event"===k.type&&(k.maxalarm<l.activity[0]||k.maxalarm>l.activity[1]||!k.timelapse&&l.timelapse))return!1;if(0<d.length){for(l=0;l<d.length;l++)if(-1!==k.tags.toLowerCase().indexOf(d[l]))return!0;return!1}return!0}
var b,c,e=agent.server,d=[];if(""!==agent.search.tags)for(d=agent.search.tags.split(","),b=0;b<d.length;b++)d[b]=d[b].trim().toLowerCase();for(var f=0;f<e.objectList.length;f++){var g=e.objectList[f];if(null!==g.grabs&&0<g.grabs.length)for(b=g.grabs.length,c=0;c<b;c++){var h=g.grabs[c];h.filtered=!a(h);h.filtered&&(h.selected=!1)}if(0<g.events.length)for(b=g.events.length,c=0;c<b;c++)h=g.events[c],h.filtered=!a(h),h.filtered&&(h.selected=!1)}}},themes:{sizes:{standard:{mode:"standard",fixed:11,bottomBar:36,
topBar:30,font:11,fontLarge:14,padding:15,normalPadding:15,icon:18,minLive:320,compact:!1},large:{mode:"large",fixed:11,bottomBar:42,topBar:40,font:16,fontLarge:20,padding:26,normalPadding:26,icon:26,minLive:380,compact:!1}},list:[{name:"Dark",backColor:"#222222",themecss:"css/themes/slate.min.css",font:"Verdana",background:"#222222",toolbar:"#333333",menu:"rgba(51,51,51,0.7)",foreground:"#C8C8C8",controlBackground:"#282828",controlForeground:"#E6E6E6",highlight:"#73B9FF",prompt:"#73B9FF",alertbar:"#C80000",
selected:"#73B9FF",locationMember:"#40FF00",grid:"#444444",foregroundToolbar:"#E6E6E6",alertCounter:"#3394FF",overlay:"#141414",ptz:"rgba(20,20,20,0.5)",bars:"#444444",scrollbar:"rgba(51,51,51,0.8)",logoDisarmed:"#5F9C35",logoArmed:"#BF5920",logoBack:"#222222",vr:{background:"#222222",grid:"#222222",monitorBox:"#222222",text:"#8DC3F8",buttons:"#93F88D",ptz:"#ECF095",controlBox:"#222222",cursor:"#8DC3F8",laser:"#8DC3F8",alert:"#ff0000",reticule:"#FF9326",skybox:"DarkStorm.png"}},{name:"Light",backColor:"#EEEEEE",
themecss:"css/themes/cosmo.min.css",font:"Source Sans Pro",background:"#EEEEEE",toolbar:"rgb(39,128,227)",menu:"rgb(39,128,227)",foreground:"rgb(20,20,20)",controlBackground:"#1457A0",controlForeground:"rgb(20,20,20)",highlight:"#36D900",prompt:"#36D900",alertbar:"rgb(200,0,0)",selected:"#36D900",locationMember:"rgb(64,255,0)",grid:"rgb(215,215,215)",foregroundToolbar:"rgb(255,255,255)",alertCounter:"#3394FF",overlay:"rgb(255,255,255)",ptz:"rgba(255,255,255,0.3)",bars:"#DDDDDD",scrollbar:"rgba(39,128,227,0.8)",
logoDisarmed:"#5F9C35",logoArmed:"#BF5920",logoBack:"#DDDDDD",vr:{background:"#DDDDDD",grid:"#CCCCCC",monitorBox:"#DDDDDD",text:"#222222",buttons:"#93F88D",ptz:"#ECF095",controlBox:"#AAAAAA",cursor:"#8DC3F8",laser:"#8DC3F8",alert:"#ff0000",reticule:"#FF9326",skybox:"AmbienceExposure.png"}},{name:"Auto"}],setTheme:function(a){isNaN(a)&&(a=0);agent.storage.set("themeIndex",a);"2"===a.toString()&&(a=0,agent.themes.switcher&&!agent.themes.switcher.matches&&(a=1));a=agent.themes.list[Math.max(0,Math.min(agent.themes.list.length-
1,a))];agent.theme=a;agent.sizes="true"===agent.storage.get("large","false")?agent.themes.sizes.large:agent.themes.sizes.standard;agent.tooltips="true"===agent.storage.get("tooltips","true");agent.labels="true"===agent.storage.get("labels","false");agent.menu.autoHide="true"===agent.storage.get("autohide","false");agent.shortcutKeys="true"===agent.storage.get("shortcutkeys","true");agent.applyFPSLimiter="true"===agent.storage.get("fpslimiter","true");$("head link#theme").attr("href",a.themecss+"?v="+
boot.version);agent.mainCanvas.css("background-color",a.background);$("#snackbar").css({"background-color":a.background,color:a.foreground,border:"solid 1px "+a.foreground});agent.menuCanvas.lastDraw=0;agent.screen&&"Live"===agent.screen.name&&agent.screens.live.startview()}},hoverText:{text:"",timestamp:null,key:""},images:{},fullscreenElement:null,screens:{},talk:{active:!1},init:function(){if(!agent.inited&&(agent.inited=!0,agent.docTitle=document.title,"undefined"!==typeof window.TextDecoder))if(window.isLocal||
"https:"===location.protocol){agent.helpers.serviceWorker.check();var a=navigator.userAgent.toLowerCase();agent.isAndroid=-1<a.indexOf("android");agent.isIOS=/ipad|iphone|ipod/.test(a);agent.isIOSApp=-1<a.indexOf("iosapp");agent.isAndroidApp=-1<a.indexOf("nativeapp");agent.isApp=agent.isIOSApp||agent.isAndroidApp;agent.isMobile=agent.isApp||agent.isIOS||agent.isAndroid||/mobi/i.test(a);agent.isSafari=/^((?!chrome|android).)*safari/i.test(a);agent.isFirefox=/firefox/.test(a);agent.mainCanvas=$("#mainApp");
agent.preloader=$("#preloader");0===agent.preloader.length&&(agent.preloader=null);agent.mainCanvas.focus();agent.menuCanvas=$("<canvas/>",{height:0,width:0});agent.menuCanvas.lastDraw=0;if(window.matchMedia)try{agent.themes.switcher=window.matchMedia("(prefers-color-scheme: dark)"),agent.themes.switcher.addEventListener&&agent.themes.switcher.addEventListener("change",function(){"2"===agent.storage.get("themeIndex",2)&&agent.themes.setTheme(2)})}catch(f){console.log(f)}agent.themes.setTheme(agent.storage.get("themeIndex",
0));editing.init("#editor","#snackbar");agent.ctx=agent.mainCanvas[0].getContext("2d");agent.ctx.translate(.5,.5);agent.ctx.imageSmoothingQuality="medium";a=new Date;a.setDate(a.getDate()-7);agent.search.from=a;agent.search.to=(new Date).addHours(24);$(window).on("resize orientationchange",agent.helpers.resize);agent.language.current=agent.storage.get("language","en");agent.screens.live=new live;a=parseInt(agent.storage.get("cycleDelay",0));isNaN(a)&&(a=0);agent.screens.live.cycleDelay=a;agent.screens.timeline=
new timeline;agent.screens.recordings=new recordings;agent.screens.photos=new photos;agent.screens.vr=new vr;agent.playback=new playback;a=agent.storage.get("start","Live");agent.screen=agent.screens.live;for(var b in agent.screens){var c=agent.screens[b];if(c.name===a){agent.screen=c;break}}document.body.scrollTop=0;document.body.style.overflow="hidden";agent.CanDownload=!agent.isIOS;agent.canFullScreen=!agent.isIOS&&!agent.isApp;agent.isDesktop=!agent.isAndroid&&!agent.isApp&&!agent.isIOS;navigator.getUserMedia||
(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia);agent.mainCanvas.on("click",agent.canvas.click);agent.mainCanvas.on("mousemove",agent.canvas.mousemove);agent.mainCanvas.on("touchstart",agent.canvas.touchstart);agent.mainCanvas.on("touchend",agent.canvas.touchend);agent.mainCanvas.on("keyup",agent.canvas.keyup);agent.videoPlayer=document.createElement("video");agent.videoPlayer.setAttribute("playsinline","playsinline");
agent.videoPlayer.setAttribute("muted",!0);agent.videoPlayer.setAttribute("autoplay",!0);agent.videoPlayer.setAttribute("controls",!0);agent.videoPlayer.muted=!0;agent.videoPlayer.addEventListener("error",function(f){console.log("error during playback:");console.error(f)},!0);Object.defineProperty(HTMLMediaElement.prototype,"playing",{get:function(){return!!(0<this.currentTime&&!this.paused&&!this.ended&&2<this.readyState)}});agent.helpers.loadImages();agent.helpers.resize();agent.canvas.renderController.start();
agent.helpers.language.load(agent.language.current,function(){agent.helpers.setAppStatus("Loading Configuration");agent.helpers.loadConfig();agent.helpers.handleQueryString()});$(document).contextmenu(function(){return!1});window.history.pushState(null,"",window.location.href);window.onpopstate=function(){agent.playback.active&&agent.playback.close();window.history.pushState(null,"",window.location.href)};$(document).keydown(function(f){switch(f.which){case 27:editing.ui.close()}});if("undefined"!==
typeof document.hidden){var e="hidden";var d="visibilitychange"}else"undefined"!==typeof document.msHidden?(e="msHidden",d="msvisibilitychange"):"undefined"!==typeof document.webkitHidden&&(e="webkitHidden",d="webkitvisibilitychange");void 0!==e&&document.addEventListener(d,function(){!document[e]&&comms.hasConnected&&comms.webRTC.checkConnection()},!1);agent.isPWA=window.matchMedia("(display-mode: standalone)").matches;agent.isApp||agent.isPWA||window.addEventListener("beforeinstallprompt",function(f){agent.deferredPrompt=
f})}else location.protocol="https:"},helpers:{handleQueryString:function(){if(URL){var a=(new URL(location.href)).searchParams;if(a&&(a=a.get("sub")))switch(a){case "complete":editing.helpers.setStatus("Your account has been upgraded",null,null,!0)}}},loadScript:function(a,b,c,e){$.ajax({type:"GET",url:a,success:c,fail:e,dataType:"script",cache:b})},changeServer:function(){window.isLocal?editing.goRemote():(comms.deinit(),editing.ui.teardown(!0),agent.helpers.loadConfig(!0))},serviceWorker:{check:function(){"serviceWorker"in
navigator&&!window.isLocal&&navigator.serviceWorker.register("sw.js").then(function(a){agent.swRegistration=a;console.log("service worker running")})["catch"](function(a){console.log("Service worker failed:",a)})},initPush:function(a){function b(c){var e="=".repeat((4-c.length%4)%4);c=(c+e).replace(/\-/g,"+").replace(/_/g,"/");c=window.atob(c);e=new Uint8Array(c.length);for(var d=0;d<c.length;++d)e[d]=c.charCodeAt(d);return e}!window.isLocal&&"Notification"in window&&"granted"===Notification.permission&&
a.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:b(agent.applicationServerKey)}).then(function(c){null!==c&&account.pushNotifications.setWebPush(c)})["catch"](function(c){"denied"===Notification.permission?console.warn("Permission for notifications was denied"):console.error("Unable to subscribe to push",c)})}},installPWA:function(){agent.deferredPrompt.prompt();agent.deferredPrompt.userChoice.then(function(a){"accepted"===a.outcome?console.log("User accepted the A2HS prompt"):console.log("User dismissed the A2HS prompt");
agent.deferredPrompt=null})},hslToRgb:function(a,b,c){if(0===b)c=b=a=c;else{var e=function(g,h,k){0>k&&(k+=1);1<k&&--k;return k<1/6?g+6*(h-g)*k:.5>k?h:k<2/3?g+(h-g)*(2/3-k)*6:g},d=.5>c?c*(1+b):c+b-c*b,f=2*c-d;c=e(f,d,a+1/3);b=e(f,d,a);a=e(f,d,a-1/3)}return"rgb("+Math.round(255*c)+","+Math.round(255*b)+","+Math.round(255*a)+")"},centerText:function(a,b){var c=a.font;a.font=agent.sizes.font+"px "+agent.theme.font;var e=a.measureText(b).width,d=agent.size.w/2-e/2,f=agent.size.h/2-agent.sizes.font/2;
a.fillStyle=agent.theme.overlay;a.fillRect(d-agent.sizes.padding,f-agent.sizes.font,e+2*agent.sizes.padding,2*agent.sizes.font);a.fillStyle=agent.theme.foreground;a.fillText(b,d,f+agent.sizes.font/2-2);a.font=c},checkViews:function(){var a=agent.server,b;if(!a.views||0===a.views.length)for(a.views=[],a.views.cycle=!1,b=0;9>b;b++)a.views.push({name:b.toString(),mode:"grid",objects:[]});for(b=0;b<a.views.length;b++){for(var c=a.views[b],e=[],d="",f=0;f<c.objects.length;f++){var g=c.objects[f];-1===
d.indexOf(g.ot+"_"+g.oid+",")&&(d+=g.ot+"_"+g.oid+",",null!==agent.helpers.findObject(g.ot,g.oid)&&e.push(g))}c.objects=e}},setAppStatus:function(a){if(agent.isAndroidApp)try{ANDROID_Navigation.SetStatus(a)}catch(b){console.error(b)}agent.isIOSApp&&(location.href="myapp://interface?status="+a)},downloadFile:function(a,b){var c=-5;b&&(b.attr("disabled","disabled"),b.text("..."));var e=agent.helpers.findObject(a.ot,a.oid),d={type:"download",filename:a.filename};e?(d.ot=e.typeID,d.oid=e.id):e=agent.server;
comms.api.downloadFile(e,d,function(f){var g=window.URL||window.webkitURL||window||{};f=g.createObjectURL(f);if(navigator.platform&&navigator.platform.match(/iPhone|iPod|iPad/))window.location.href=f;else{var h=document.createElement("a");h.href=f;h.download=a.filename;document.body.appendChild(h);h.click();document.body.removeChild(h)}g.revokeObjectURL(f);b&&b.html("&#10004;");agent.notifications.notify("Broadcast","Agent",agent.helpers.translate("DownloadComplete"))},function(f){f>c+5&&b&&(b.text(parseInt(f)+
"%"),c=f)},b)},playback:function(a){agent.screen.deinit();agent.playback.init(a)},alarm:function(){if(null===agent.alarmSound){agent.alarmSound=$('<audio hidden="hidden" autoplay="autoplay" preload="none"></audio>');var a=$('<source type="audio/mpeg; codecs=mp3" src="audio/woop.mp3"/>'),b=$('<source type="audio/wave" src="audio/woop.wav"/>');a.appendTo(agent.alarmSound);b.appendTo(agent.alarmSound);agent.alarmSound[0].load()}agent.alarmSound[0].play()},drawToolbar:function(a,b,c){a.fillStyle=agent.theme.toolbar;
var e=agent.sizes.bottomBar,d=agent.size.h-e;a.fillRect(0,d,agent.size.w,e);a.font=agent.FontAwesome(agent.sizes.icon);for(var f=agent.sizes.padding,g=agent.size.h-e/2+agent.sizes.icon/2-2,h=f/2,k=agent.size.w-agent.sizes.icon-f,l=0;l<b.length;l++){var m=b[l],p=0;if(m.right){a.fillStyle=agent.theme.foregroundToolbar;m.highlight&&(a.fillStyle=agent.theme.prompt);c&&c.cmd===m.cmd&&(a.fillStyle=agent.theme.highlight);m.prompt&&(agent.helpers.centerText(a,m.prompt),a.fillStyle=agent.theme.prompt);var n=
k;a.fillText(m.icon,k+f/2,g);p+=agent.sizes.icon+f;k-=agent.sizes.icon+f}else a.fillStyle=agent.theme.controlBackground,a.fillRect(h,agent.size.h-e+4,agent.sizes.icon+f,e-8),a.fillStyle=c&&c.cmd===m.cmd?agent.theme.highlight:agent.theme.foregroundToolbar,a.fillText(m.icon,h+f/2,g),n=h,p=agent.sizes.icon+f,h+=agent.sizes.icon+f;m.bounds={x:n,y:d,x2:n+p,y2:d+e}}k<agent.size.w-agent.sizes.icon-1.5*f&&(k+=agent.sizes.icon+f);h>f/2&&(h-=agent.sizes.icon+f);return{left:h,right:k}},drawCommandMenu:function(a,
b,c){a.fillStyle=agent.theme.menu;var e=b.list.length*(agent.sizes.icon+agent.sizes.padding/2)+agent.sizes.padding,d=agent.size.h-agent.sizes.bottomBar-e,f=b.maxWidth+agent.sizes.icon+2*agent.sizes.padding,g=agent.size.w-f;a.fillRect(g,d,f,e);a.fillStyle=agent.theme.foregroundToolbar;e=d+agent.sizes.icon+4;for(d=0;d<b.list.length;d++){var h=b.list[d];a.fillStyle=c&&c.cmd===h.cmd?agent.theme.highlight:agent.theme.foregroundToolbar;h.bounds={x:g,y:e-agent.sizes.icon,x2:g+f,y2:e+agent.sizes.padding/
2-4};a.font=agent.FontAwesome(agent.sizes.icon);a.fillText(h.icon,g+agent.sizes.padding/2,e+1);a.font=agent.sizes.font+"px "+agent.theme.font;a.fillStyle=agent.theme.foregroundToolbar;var k=h.translated;a.fillText(k,g+agent.sizes.padding+agent.sizes.icon,e-1);""!==h.key&&agent.shortcutKeys&&(k="("+h.key+")",h=a.measureText(k).width,a.fillText(k,g+f-h-4,e-1));e+=agent.sizes.icon+agent.sizes.padding/2}},createCookie:function(a,b,c){var e="";c&&(e=new Date,e.setTime(e.getTime()+864E5*c),e="; expires="+
e.toGMTString());document.cookie=a+"="+b+e+"; path=/"},readCookie:function(a,b){for(var c=a+"=",e=document.cookie.split(";"),d=0;d<e.length;d++){for(var f=e[d];" "===f.charAt(0);)f=f.substring(1,f.length);if(0===f.indexOf(c))return f.substring(c.length,f.length)}return b},eraseCookie:function(a){agent.helpers.createCookie(a,"",-1)},shorten:function(a,b){a.length>b&&(a=a.substr(0,b-2)+"..");return a},shortenURL:function(a,b){if(a.length>b){var c=a.indexOf("://"),e=a.substr(0,c+3)+"...",d=a.substr(c+
3);d=d.substr(d.indexOf("/")+1);d=d.substr(Math.max(0,d.length-(b-(c+3))));a=e+d}return a},loadImages:function(){},reinit:function(){comms.deinit();agent.helpers.loadConfig()},getChar:function(a){switch(a){case 191:return"?";case 46:return"DEL";case 27:return"ESC";case 188:return">";case 190:return"<";case 107:return"+";case 109:return"-";default:return String.fromCharCode(a)}},hoverCommand:function(a,b){agent.helpers.setCursor(a,"pointer");if(!b.isMenu&&!agent.isMobile){var c="tt."+b.cmd;"goScreen"===
b.cmd&&(c=b.tag);c=agent.helpers.translate(c);var e="";b.keyCode&&(e=agent.helpers.getChar(b.keyCode));var d=b.bounds.y;d=d>agent.size.h/2?d-17:d+agent.sizes.topBar+2;agent.hoverText={x:b.bounds.x,y:d,text:c,key:e,timestamp:new Date}}},setCursor:function(a,b){a=window.event||a;var c=a.target||a.srcElement;null!==c&&(c.style?c.style.cursor=b:c.cursor=b)},language:{translations:null,load:function(a,b){$.getJSON("langs/"+a+".json?v="+boot.version,function(c){agent.helpers.language.translations=c;agent.language.current=
a;b&&b()}).fail(function(c){console.log("could not load "+a+":"+c);"en"!==a?agent.helpers.language.load("en",b):(agent.helpers.setState("initError"),agent.helpers.setAppStatus("Failed"))})}},goFullscreen:function(){var a=document.documentElement;a.requestFullscreen?a.requestFullscreen():a.mozRequestFullScreen?a.mozRequestFullScreen():a.webkitRequestFullscreen?a.webkitRequestFullscreen():a.msRequestFullscreen&&a.msRequestFullscreen();agent.fullscreenElement=a},exitFullscreen:function(){document.exitFullscreen?
document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen();agent.fullscreenElement=null},translate:function(a){function b(c,e){return c.split(".").reduce(function(d,f){return d?d[f]:null},e||self)}if(null===agent.helpers.language.translations)return a;try{return b(a,agent.helpers.language.translations)}catch(c){return console.log("missing: "+a),""}},initObject:function(a){var b=
agent.server;a.parent=b;a.events=[];a.grabs=[];a.grabsInited=!1;a.hasPermission=!0;a.selected=!1;a.type="Device";a.groups=a.groups.toLowerCase();if(null!==b.Permissions){var c=b.Permissions.accessMask;if(""!==a.groups){a.hasPermission=!1;b=c.toLowerCase().split(",");var e=a.groups.split(",");if(-1===e.indexOf("exclude"))if(""===c)a.hasPermission=!0;else a:for(c=0;c<b.length;c++)for(var d=b[c].trim(),f=0;f<e.length;f++){var g=e[f].trim();if(""!==d&&d===g){a.hasPermission=!0;break a}}}}},reloadObjectList:function(a){var b=
agent.server,c,e,d=!1;for(c=0;c<a.length;c++){var f=a[c];var g=null;for(e=0;e<b.objectList.length;e++){var h=b.objectList[e];if(h.typeID===f.typeID&&h.id===f.id){g=h;break}}if(null===g)agent.helpers.initObject(f),f.hasPermission&&(d=!0,b.objectList.push(f));else for(var k in f)f.hasOwnProperty(k)&&(g[k]=f[k])}for(c=0;c<b.objectList.length;c++){f=b.objectList[c];g=!1;for(e=0;e<a.length;e++)if(h=a[e],h.typeID===f.typeID&&h.id===f.id){g=!0;break}if(!g){b.objectList.splice(c,1);for(e=0;e<agent.server.views.length;e++)for(h=
agent.server.views[e],vi=0;vi<h.objects.length;vi++)if(d=h.objects[vi],d.oid===f.id&&d.ot===f.typeID){h.objects.splice(vi,1);break}d=!0;c--}}editing.objectsUpdated();d&&agent.server&&"Live"===agent.screen.name&&agent.screens.live.startview()},reload:function(){agent.isIOSApp?location.href="myapp://interface?action=website":agent.isAndroidApp?ANDROID_Navigation.Navigate("https://www.ispyconnect.com/app/"):location.reload(!0)},setState:function(a){var b=agent.state;agent.state=a;b!==a&&("ok"===a&&agent.helpers.changeScreen(agent.screen),
"ok"===b&&agent.screen.deinit())},changeScreen:function(a){agent.screen.deinit();agent.screen=a;a.init();agent.menuCanvas.lastDraw=0},pointIsInPoly:function(a,b){for(var c=a.x,e=a.y,d=!1,f=0,g=b.length-1;f<b.length;g=f++){var h=b[f].x,k=b[f].y,l=b[g].x;g=b[g].y;k>e!==g>e&&c<(l-h)*(e-k)/(g-k)+h&&(d=!d)}return d},calcDist:function(a,b){return Math.sqrt(Math.pow(a.x-b.x,2)+Math.pow(a.y-b.y,2))},stopEvent:function(a){a.preventDefault&&a.preventDefault();a.stopPropagation&&a.stopPropagation();a.returnValue&&
(a.returnValue=!1);a.cancelBubble&&(a.cancelBubble=!0);return!1},setLoadError:function(a){agent.errorMessage=a;agent.helpers.setState("error")},resize:function(){var a=$(window);a.width()<agent.minWindowWidthForSidebar&&null!==editing.sidebar?editing.helpers.closeSideBar():(agent.mainCanvas[0].width=a.width()-agent.mainCanvas.offset().left,agent.mainCanvas[0].height=$(window)[0].innerHeight,agent.size={w:agent.mainCanvas[0].width,h:agent.mainCanvas[0].height},agent.menuCanvas.lastDraw=0,agent.screen.resize(),
agent.playback.resize())},loadConfig:function(a){agent.playback.active&&agent.playback.close();agent.helpers.setState("loading");agent.errorMessage="";var b=Math.random();if(window.isLocal){b=window.localConfig;agent.mainCanvas.show();agent.config={email:"",emailBlockCode:0,locked:!1,accountDetails:{username:b.Username,shortName:agent.helpers.shorten(b.Username,14),email:"",enablePasswordReset:!0,mobileNumber:"",timeZone:8,id:0,ident:"",prePay:!1,mustSubscribe:!1,newsletter:!1},subscribed:!1,subscriptionDate:0,
warning:"",smsCredits:0,maxServers:1,accountType:"Local",newsletters:!1,connectedServers:[{name:b.MachineName,connectionID:"local",userID:0,isRTC:!0,version:b.Version,unique:"",auth:"",iSpyAccessID:-1,subscribed:!0,platform:"Agent",latestVersion:b.LatestVersion,updateAvailable:b.UpdateAvailable,notify:!1,sessionID:"c44dc6c5-4e64-4045-86b8-86ea2e6d4659",productID:27,turnServer:""}],otherServers:[],accessServers:[],accessPermissions:[],currency:"USD",otherPortalLink:"",URL:"https://www.ispyconnect.com",
plugins:[],firebase:"",pushPlatform:"web",loginProvider:"",pictureURL:"",userID:0,neighbourhoodWatch:[],thirdParty:!1,trialWarning:""};agent.config.RTCServers=b.ICE;for(var c=0;c<b.ICE.iceServers.length;c++)b.ICE.iceServers[c].urls=b.ICE.iceServers[c].urls.replace("SERVER",window.location.hostname);agent.servicesConnected=""!==b.Username;agent.config.connectedServers[0].versionNumeric=parseInt(b.Version.replace(/\./g,""));agent.helpers.processCommand("goServer",0);"no"===agent.storage.get("promptedLang",
"no")&&(agent.storage.set("promptedLang","yes"),account.showLanguageChoice())}else $.getJSON("script/config.aspx?r="+b,function(e){null!==agent.preloader&&agent.preloader.hide();agent.mainCanvas.show();agent.config=e.configuration;agent.helpers.setAppStatus("complete");agent.menuCanvas.lastDraw=0;if(agent.config.failed)agent.helpers.setState("failed"),account.showLoginChoice();else if(""!==agent.config.warning&&(e=agent.helpers.translate(agent.config.warning),editing.helpers.setStatus(e)),agent.config.subscribed?
(agent.config.subscriptionDate=new Date(agent.config.subscriptionDate),agent.config.subscriptionDateString=agent.config.subscriptionDate.toDateString()):agent.config.subscriptionDateString="N/A",agent.config.accountDetails.shortName=agent.helpers.shorten(agent.config.accountDetails.username,14),agent.config.accountDetails.mustSubscribe)account.subscriptions.load(),agent.helpers.setState("mustSubscribe");else if(agent.config.trialWarning&&""!==agent.config.trialWarning&&window.setTimeout(function(){agent.config&&
agent.config.trialWarning&&editing.helpers.setStatus(agent.config.trialWarning,8E3,account.subscriptions.load,!0)},3E4),0!==agent.config.emailBlockCode&&setTimeout(function(){var g="Email to "+agent.config.email+" has been blocked due to:",h="";switch(agent.config.emailBlockCode){case 1:h="Permanent Failure";break;case 2:h="Out of Office";break;case 3:h="Spam Complaint";break;case 4:h="Stop Request"}editing.helpers.setStatus(g+h,4E3,account.resetEmailBlock)},4E3),e=agent.config.connectedServers,e=
e.concat(agent.config.otherServers),agent.config.connectedServers=e,agent.currentObject=null,agent.server=null,$.urlParam("code")&&!agent.promptedClaim)agent.promptedClaim=!0,editing.addServer(),agent.helpers.setState("selectServer");else{var d=!1;if($.urlParam("unique"))for(var f=0;f<e.length;f++)e[f].unique===$.urlParam("unique")&&(agent.helpers.processCommand("goServer",f),d=!0,window.history.replaceState&&window.history.replaceState({},document.title,"/app/"));if(!d)switch(e.length){case 0:agent.helpers.setState("selectServer");
editing.popServers();break;case 1:a?(agent.helpers.setState("selectServer"),editing.popServers()):agent.helpers.processCommand("goServer",0);break;default:agent.helpers.setState("selectServer"),editing.popServers()}}}).fail(function(e){null!==agent.preloader&&agent.preloader.hide();console.log(e);agent.helpers.setState("initError");agent.helpers.setAppStatus("Failed")})},processCommand:function(a,b){b=void 0===b?0:b;switch(a){case "goRemote":editing.goRemote();break;case "goServer":agent.server=agent.config.connectedServers[b];
agent.server.armed=!0;agent.server.shortName=agent.helpers.shorten(agent.server.name,14);agent.server.versionNumeric=parseInt(agent.server.version.replace(/\./g,""));agent.helpers.setState("connecting");comms.bulkCandidates=2350<agent.server.versionNumeric;null!==agent.preloader&&agent.preloader.show();comms.connect();break;case "popServers":editing.popServers();break;case "reinit":agent.helpers.reinit();break;case "startVR":agent.screens.vr.start("immersive-vr");break;case "startVRInline":agent.screens.vr.start("inline");
break;case "updateAgent":editing.updateAgent();break;case "stopVR":agent.screens.vr.stop();break;case "subscribe":account.subscriptions.load();break;case "addServer":editing.addServer();break;case "serverMenu":editing.showServerMenu(agent.server);break;case "toggleAlarm":!agent.server||agent.server.Permissions&&agent.server.Permissions.readOnly||(2780>agent.server.versionNumeric?comms.api.command(agent.server,"toggleArm"):agent.server.armed?comms.api.command(agent.server,"disarm"):editing.showArmMenu());
break;case "goScreen":agent.helpers.changeScreen(agent.screens[b.toLowerCase()]);break;case "screenMenu":editing.showScreenMenu();break;case "alertMenu":editing.showAlerts();break;case "accountMenu":account.showAccountMenu();break;case "help":editing.showHelp();break;case "fullscreen":agent.helpers.goFullscreen();break;case "cancelfullscreen":agent.helpers.exitFullscreen();break;case "close":window.close()}},findObject:function(a,b){for(var c=0;c<agent.server.objectList.length;c++){var e=agent.server.objectList[c];
if(e.typeID===a&&e.id===b)return e}return null},findID:function(a,b,c){var e=[],d;for(d in a)a.hasOwnProperty(d)&&("object"===typeof a[d]?e=e.concat(agent.helpers.findID(a[d],b,c)):d===b&&a[b]===c&&e.push(a));return e},mouseXY:function(a,b){b||(b=agent.mainCanvas);var c=b.offset().left;var e=b.offset().top;var d={x:0,y:0};d.x=a.pageX;d.y=a.pageY;d.timestamp=new Date;a.originalEvent&&a.originalEvent.touches&&(0<a.originalEvent.touches.length?(d.x=a.originalEvent.touches[0].pageX,d.y=a.originalEvent.touches[0].pageY):
a.originalEvent.changedTouches&&0<a.originalEvent.changedTouches.length&&(d.x=a.originalEvent.changedTouches[0].pageX,d.y=a.originalEvent.changedTouches[0].pageY));d.x-=c;d.y-=e;return d},mouseXYRel:function(a,b){return agent.helpers.mouseXY(b,$(a))}},canvas:{hitTests:[],click:function(a){agent.firstClick&&"false"===agent.storage.get("muted","false")&&(agent.videoPlayer.muted=!1);agent.firstClick=!1;if(!agent.playback.active){var b=agent.canvas.getHitTest(a);null!==b&&(agent.helpers.processCommand(b.cmd,
b.tag),agent.helpers.stopEvent(a))}agent.mainCanvas.focus()},mousemove:function(a){var b=agent.canvas.getHitTest(a);null!==b?agent.playback.active||agent.helpers.hoverCommand(a,b):agent.helpers.setCursor(a,"default")},touchstart:function(a){touchstarttime=new Date;agent.oxy=agent.helpers.mouseXY(a)},touchend:function(a){agent.mxy=agent.helpers.mouseXY(a);agent.helpers.calcDist(agent.oxy,agent.mxy)<agent.touchClickRadius&&agent.canvas.click(a)},keyup:function(a){if(agent.shortcutKeys&&agent.server){for(var b in agent.screens)if(agent.screens[b].shortcutKey===
a.which){agent.helpers.changeScreen(agent.screens[b]);return}for(b=0;b<agent.canvas.hitTests.length;b++){var c=agent.canvas.hitTests[b];c.keyCode===a.which&&agent.helpers.processCommand(c.cmd)}}},getHitTest:function(a){var b=agent.canvas.hitTests;b&&agent.canvas.messages&&(b=b.concat(agent.canvas.messages));if(b){a=agent.helpers.mouseXY(a);for(var c=0;c<b.length;c++){var e=b[c],d=e.bounds;if(d.x<a.x&&d.x2>a.x&&d.y<a.y&&d.y2>a.y)return e}}return null},drawMessage:function(a){agent.canvas.messages=
[];agent.ctx.font=agent.sizes.font+"px "+agent.theme.font;agent.ctx.fillStyle=agent.theme.foreground;agent.ctx.strokeStyle=agent.ctx.fillStyle;for(var b=agent.size.h/2-a.length*(agent.sizes.font+10)/2,c=0;c<a.length;c++){0<c&&(agent.ctx.fillStyle=agent.theme.foreground,agent.ctx.strokeStyle=agent.ctx.fillStyle);var e=agent.ctx.measureText(a[c].txt).width,d=agent.size.w/2-e/2,f=b+c*(agent.sizes.font+10);agent.ctx.fillText(a[c].txt,d,f);a[c].cmd&&(agent.ctx.strokeRect(d-5,f-agent.sizes.font,e+10,agent.sizes.font+
5),agent.canvas.messages.push({bounds:{x:d,y:f-agent.sizes.font,x2:d+e,y2:f+5},cmd:a[c].cmd,isMenu:!0}))}},renderController:{frameCount:0,fps:0,fpsInterval:0,startTime:0,now:0,then:0,elapsed:0,start:function(a){var b=agent.canvas.renderController;b.fps=a;b.fpsInterval=1E3/b.fps;b.then=window.performance.now();b.startTime=b.then;window.requestAnimationFrame(agent.canvas.render)}},render:function(a){if(agent.applyFPSLimiter||agent.vrRunning){var b=agent.canvas.renderController;var c=agent.screen.fps;
agent.playback.active&&(c=agent.playback.fps);if(c!==b.fps){console.log("switching fps to "+c);agent.canvas.renderController.start(c);return}b.now=a;b.elapsed=b.now-b.then;window.requestAnimationFrame(agent.canvas.render);if(b.elapsed<=b.fpsInterval)return;b.then=b.now-b.elapsed%b.fpsInterval}else window.requestAnimationFrame(agent.canvas.render);agent.ctx.canvas.width=agent.mainCanvas[0].width;agent.ctx.canvas.height=agent.mainCanvas[0].height;if(0!==agent.ctx.canvas.width){agent.sizes.padding=agent.sizes.normalPadding;
switch(agent.sizes.mode){case "large":475>agent.size.w&&(agent.sizes.padding=parseInt(agent.sizes.normalPadding/1.5));380>agent.size.w&&(agent.sizes.padding=agent.sizes.normalPadding/2);break;default:350>agent.size.w&&(agent.sizes.padding=parseInt(agent.sizes.normalPadding/1.5))}if(agent.errorMessage)agent.canvas.drawMessage(agent.errorMessage);else switch(a=agent.helpers.translate,agent.state){case "vrRemoteOnly":agent.canvas.drawMessage([{txt:a("VR")},{txt:a("RemoteOnly"),cmd:"goRemote"}]);break;
case "vrUpgradeRequired":agent.canvas.drawMessage([{txt:a("VR")},{txt:a("UpgradeRequired"),cmd:"updateAgent"}]);break;case "startVR":b=[{txt:a("VR")}];agent.screens.vr.supported.vr?b.push({txt:"Immersive",cmd:"startVR"}):b.push({txt:"Immersive not available"});agent.screens.vr.supported.inline&&b.push({txt:"Local",cmd:"startVRInline"});1===b.length&&b.push({txt:a("NotSupported")});agent.canvas.drawMessage(b);break;case "stopVR":agent.canvas.drawMessage([{txt:"Put on your headset"},{txt:a("Stop"),
cmd:"stopVR"}]);break;case "loadScriptFailed":agent.canvas.drawMessage([{txt:a("ConnectionFailed")}]);break;case "mustSubscribe":agent.canvas.drawMessage([{txt:a("SubscriptionRequired"),cmd:"subscribe"}]);break;case "loading":agent.canvas.drawMessage([{txt:a("Loading")}]);break;case "reconnecting":agent.canvas.drawMessage([{txt:a("Reconnecting")},{txt:a("Cancel"),cmd:"reinit"}]);break;case "failed":agent.canvas.drawMessage([{txt:a("Login")}]);break;case "initError":agent.canvas.drawMessage([{txt:a("ConnectFailed")},
{txt:a("Retry"),cmd:"reinit"}]);break;case "selectServer":agent.canvas.drawMessage([{txt:a("SelectServer"),cmd:"popServers"}]);break;case "noServers":agent.canvas.drawMessage([{txt:a("NoServers")},{txt:a("AddServer"),cmd:"addServer"},{txt:a("Retry"),cmd:"reinit"}]);break;case "connecting":agent.canvas.drawMessage([{txt:a("Connecting")},{txt:agent.server.name}]);break;case "ok":try{agent.playback.active?agent.playback.render():agent.screen.render()}catch(d){(console.error||console.log).call(console,
d.stack||d)}}agent.menu.shouldShow()&&agent.canvas.drawMenu();if(agent.hoverText.timestamp&&agent.tooltips){agent.ctx.fillStyle=agent.theme.overlay;agent.ctx.font=agent.sizes.fixed+"px "+agent.theme.font;var e=agent.hoverText.text;""!==agent.hoverText.key&&agent.shortcutKeys&&(e+=" ("+agent.hoverText.key+")");c=agent.ctx.measureText(e).width;c+=8;a=agent.hoverText.x;b=agent.hoverText.y;a+c>agent.size.w&&(a=agent.size.w-c);agent.ctx.fillRect(a,b,c,agent.sizes.fixed+4);agent.ctx.fillStyle=agent.theme.foreground;
agent.ctx.fillText(e,a+2,b+agent.sizes.fixed);1E3<new Date-agent.hoverText.timestamp&&(agent.hoverText.timestamp=null)}}},drawMenu:function(){function a(p,n,u,t,v,w,x){b.fillStyle=agent.theme.foregroundToolbar;var r=b.measureText(p).width,q=agent.sizes.padding;t&&(n-=r);b.fillText(p,n,d);agent.canvas.hitTests.push({cmd:u,bounds:{x:n-q/2,y:0,x2:n+r+q/2,y2:d+8},keyCode:v,tag:w});x&&(b.strokeStyle=agent.theme.highlight,b.lineWidth=2,b.moveTo(n-q/2,agent.sizes.topBar-2),b.lineTo(n+r+q/2,agent.sizes.topBar-
2),b.stroke());return t?n-q:n+r+q}var b=agent.ctx,c=(new Date).getTime();if(-1E3<agent.menuCanvas.lastDraw-c)try{b.drawImage(agent.menuCanvas[0],0,0,b.canvas.width,agent.sizes.topBar);return}catch(p){console.error(p)}agent.menuCanvas[0].height=agent.sizes.topBar;agent.menuCanvas[0].width=b.canvas.width;agent.menuCanvas.lastDraw=c;agent.canvas.hitTests=[];b=agent.menuCanvas[0].getContext("2d",{alpha:!1});b.fillStyle=agent.theme.toolbar;var e=agent.sizes.topBar,d=e/2+agent.sizes.font/2;b.fillRect(0,
0,b.canvas.width,e);b.font=agent.FontAwesome(agent.sizes.icon);var f=0,g=agent.sizes.padding;c=b.canvas.width-g/2;var h=agent.server&&agent.server.armed,k=h?"\uf023":"\uf132",l=b.measureText(k).width;b.fillStyle=agent.theme.logoBack;b.fillRect(0,0,g+l,e);b.fillStyle=h?agent.theme.logoArmed:agent.theme.logoDisarmed;b.fillText(k,g/2,d);agent.server&&2330<agent.server.versionNumeric&&agent.canvas.hitTests.push({cmd:"toggleAlarm",bounds:{x:0,y:0,x2:g+l,y2:e},keyCode:74});b.fillStyle=agent.theme.foregroundToolbar;
f+=1.5*g+l;if(agent.server&&agent.server.API&&!comms.errorState)if(f=a("\uf233",f,"serverMenu",!1,48,null,"servermenu"===editing.sidebar),b.canvas.width>agent.minWindowWidthForFullTopMenu)for(var m in agent.screens)l=agent.screens[m],f=a(l.icon,f,"goScreen",!1,l.shortcutKey,l.name,agent.screen===l);else f=a(agent.screen.icon,f,"screenMenu",!1,54,null,!0);agent.canFullScreen&&(c=null!==agent.fullscreenElement?a("\uf2d2",c,"cancelfullscreen",!0):a("\uf2d0",c,"fullscreen",!0));c=a("\uf128",c,"help",
!0,191);agent.config&&agent.config.accountDetails&&(c=a("\uf007",c,"accountMenu",!0,55,null,"accountmenu"===editing.sidebar));agent.server&&agent.server.API&&!comms.errorState&&2840<agent.server.versionNumeric&&!agent.server.isAccess&&(c=a("\uf0f3",c,"alertMenu",!0,54,null,"alerts"===editing.sidebar),agent.server.alertCount&&0<agent.server.alertCount&&(b.strokeStyle=b.fillStyle=agent.theme.alertCounter,m=b.font,b.font="11px Arial",l=b.measureText(agent.server.alertCount).width,c+=2*agent.sizes.padding,
b.beginPath(),b.arc(c,8,8,0,2*Math.PI,!1),b.fill(),b.stroke(),b.fillStyle=agent.theme.foregroundToolbar,b.fillText(agent.server.alertCount,c-l/2,12,l),b.font=m));try{agent.ctx.drawImage(agent.menuCanvas[0],0,0,agent.menuCanvas[0].width,agent.sizes.topBar)}catch(p){console.error(p)}}},data:{processIncoming:function(a,b){var c=agent.server;if(-1<b.oid){if(!c.gotObjectList)return;var e=c.objectList.map(function(f){return f.typeID+","+f.id}).indexOf(b.ot+","+b.oid);if(-1===e)return;c=c.objectList[e]}switch(b.handler.toLowerCase()){case "timeupdate":agent.playback.timeupdate(b.time);
break;case "playend":agent.playback.playend();break;case "json":if((c=a.command)&&c.successCallback)if(b.error)console.log(b.error);else try{var d=JSON.parse(b.response);c.successCallback(c.obj,d)}catch(f){console.log("error processing json:"+f),console.log(b.response)}break;case "resource":if((c=a.command)&&c.successCallback)if(b.error)console.log(b.error);else try{c.successCallback(c.obj,b.response)}catch(f){console.log("error processing response:"+f)}break;case "events":agent.eventManager.processServerEvent(c,
b)}}},notifications:{NativeNotification:null,alertNotification:null,prompt:function(){if(!agent.isApp){var a=agent.helpers.translate;"granted"!==Notification.permission?editing.helpers.setStatus(a("EnableNotifications"),6E3,agent.notifications.setNativeNotifications,!0):agent.notifications.setNativeNotifications()}},setNativeNotifications:function(){if(!agent.isApp){var a=window.Notification,b=agent.helpers.translate;agent.promptedNotifications=!0;"granted"!==a.permission?a.requestPermission().then(function(c){switch(c){case "granted":agent.swRegistration&&
agent.swRegistration.pushManager.getSubscription().then(function(e){null===e?agent.helpers.serviceWorker.initPush(agent.swRegistration):account.pushNotifications.setWebPush(e)});break;case "denied":account.pushNotifications.disable(),editing.helpers.setStatus(b("EnableLater"),6E3)}}):agent.swRegistration&&agent.swRegistration.pushManager.getSubscription().then(function(c){null===c?agent.helpers.serviceWorker.initPush(agent.swRegistration):account.pushNotifications.setWebPush(c)})}},notify:function(a,
b,c,e){function d(g,h,k){!f||agent.isApp||agent.isAndroid||agent.isIOS?editing.helpers.setStatus(h+": "+k,4E3,e):(agent.notifications.NativeNotification=new window.Notification("Agent: "+h,{icon:"images/"+g+".png",body:k}),agent.notifications.NativeNotification.onclick=e)}var f=window.Notification;f&&("granted"!==f.permission?f=!1:null!==agent.notifications.NativeNotification&&agent.notifications.NativeNotification.close());switch(a){case "NewRecording":"true"===agent.storage.get("notify_recordings",
"true")&&d("notify_icon",b,c);break;case "Alert":"true"===agent.storage.get("notify_alerts","true")&&(d("alert_icon",b,c),"true"===agent.storage.get("notify_alarm","false")&&agent.helpers.alarm());break;case "Broadcast":d("notify_icon",b,c)}}},eventManager:{processServerEvent:function(a,b){var c=agent.helpers.translate;switch(b.type.toLowerCase()){case "statusupdate":console.log("status: "+b.message);switch(b.message.toLowerCase()){case "downloading":editing.helpers.setStatus(c("Downloading"));break;
case "download complete":editing.helpers.setStatus(c("DownloadComplete"));break;case "networkscancomplete":wizard.networkDevices=[];editing.helpers.setStatus(c("NetworkScanComplete"));break;default:editing.helpers.setStatus(b.message)}break;case "arming":editing.helpers.setStatus(c("Arming")+": "+b.message,2E3,function(){comms.api.command(agent.server,"disarm")});break;case "newevent":var e=agent.eventManager.getEventJSON(b.data,a);a.events.splice(0,0,e);a.hasPermission&&agent.notifications.notify("NewRecording",
c("NewRecording"),a.parent.name+": "+a.name,function(g,h){agent.helpers.playback(e);return!0});break;case "objectsupdated":comms.api.command(agent.server,"loadObjects",function(g,h){agent.helpers.reloadObjectList(h.objectList)});break;case "rtmpupdate":b.data.oid?(c=agent.helpers.findObject(b.data.ot,b.data.oid),null!==c&&(c.data.rtmpStreaming=b.data.playing)):agent.server.rtmpStreaming=b.data.playing;break;case "upgradereload":window.setTimeout(agent.helpers.reload,3E4);break;case "upgradestarted":agent.helpers.setState(c("Loading"));
break;case "sizeupdate":a.data.width=b.data.width;a.data.height=b.data.height;break;case "stats":a.stats=b.data;break;case "alertcount":agent.server.alertCount=b.data.count;document.title=0<agent.server.alertCount?"("+agent.server.alertCount+") "+agent.docTitle:agent.docTitle;break;case "manualalert":case "alert":var d=a;var f=d.parent;f&&(d.data.alerted=!0);f&&d.hasPermission&&agent.notifications.notify("Alert",c("Alert"),d.parent.name+": "+b.message,function(g,h){agent.screen!==agent.screens.live&&
agent.helpers.changeScreen(agent.screens.live);return!0});"alerts"===editing.sidebar&&(agent.updateAlerts=window.setTimeout(function(){editing.showAlerts(!0)},1E3));break;case "broadcast":d=a;if(d.parent){if(!d.hasPermission)break;d=d.parent}agent.notifications.notify("Broadcast",c("Broadcast"),d.name+": "+b.message);break;case "broadcasttranslate":d=a;if(d.parent){if(!d.hasPermission)break;d=d.parent}agent.notifications.notify("Broadcast",c("Broadcast"),d.name+": "+c(b.message));break;case "armed":agent.server.armed=
"true"===b.message;agent.notifications.notify("Broadcast",c("Broadcast"),agent.server.armed?c("SystemArmed"):c("SystemDisarmed"));break;case "tagresult":""===b.message&&(b.message=c("NoMatches"));agent.tags=b.message;break;case "error":console.log("error: "+a.name+":"+b.message);break;case "message":console.log("message: "+a.name+":"+b.message);break;case "enabled":a.data.online=!0;(d=editing.currentRenderObject())&&d.agentObject===a&&(agent.suppressLiveUpdates=!0,$("#chkEnable").prop("checked",!0).change(),
agent.suppressLiveUpdates=!1);break;case "local-claim":window.isLocal&&!agent.servicesConnected&&(location.href="https://www.ispyconnect.com/app/?code="+b.message);break;case "local-message":window.isLocal&&editing.helpers.setStatus(b.message);break;case "connecting":a.data.connecting=!0;break;case "connected":a.data.connecting=!1;break;case "disabled":a.data.online=!1;(d=editing.currentRenderObject())&&d.agentObject===a&&(agent.suppressLiveUpdates=!0,$("#chkEnable").prop("checked",!1).change(),agent.suppressLiveUpdates=
!1);break;case "recordingstop":a.data.recording=!1;break;case "recording":a.data.recording=!0;break;case "apply":a.data.pairid!==b.data.pairid&&(c=1===a.typeID?2:1,-1!==a.data.pairid&&(d=agent.helpers.findObject(c,a.data.pairid),null!==d&&(d.data.pairid=-1)),-1!==b.data.pairid&&(c=agent.helpers.findObject(c,b.data.pairid),null!==c&&(c.data.pairid=a.id)));a.data=b.data;a.name=a.data.name;break;case "tagdetected":a.data.alerted=!0;break;case "alertstopped":a.data.alerted=!1;break;case "detected":a.data.detected=
(new Date).getTime()}},loadEvents:function(){agent.server.isBlocked||comms.api.command(agent.server,"getevents",agent.eventManager.popEvents)},getEventJSON:function(a,b){var c=new Date;c.setTime((parseInt(a.c)-621355968E9)/1E4);a.parent=b;a.date=c;a.time=c.getTime();a.created=a.c;a.maxalarm=a.ma;a.duration=a.d;a.timeEnd=(new Date).setTime(a.time+1E3*(a.dd?a.dd:a.d));a.filename=a.fn;a.sizeBytes=a.sb;a.timelapse=a.tl;a.tags=null===a.tg?"":a.tg;a.type="Event";a.selected=!1;a.prettyBytes=a.sizeBytes.toString().prettyBytes();
a.color=agent.helpers.hslToRgb(0,a.ma/100,.5);c=(new Date(1E3*a.duration)).toISOString().substr(11,8);a.summary=a.date.formatDate(agent.timeFormat)+" | "+c+" | "+a.prettyBytes+(a.timelapse?" (timelapse)":"");return a},popEvents:function(a,b){for(var c=0;c<b.events.length;c++){var e=b.events[c],d=agent.helpers.findObject(e.ot,e.oid);null!==d&&d.events.push(agent.eventManager.getEventJSON(e,d))}0<b.events.length&&setTimeout(function(f,g){comms.api.command(agent.server,"getevents&enddate="+g,agent.eventManager.popEvents)},
2E3,a,b.events[b.events.length-1].c)},loadPhotos:function(a){a.grabsLoading||comms.api.command(a,"getcameragrabs",agent.eventManager.popPhotos)},popPhotos:function(a,b){a.grabsLoading=!0;if(0<b.results.length){var c=[],e=null;0<a.grabs.length&&(e=a.grabs[0]);for(var d=0;d<b.results.length;d++){var f=b.results[d];if(a.grabsPrepend&&e&&e.filename===f.name)break;var g=new Date;g.setTime(parseInt(f.time));c.push({filename:f.name,tags:f.tags,date:g,summary:g.formatDate(agent.timeFormat),parent:a,type:"Grab"})}a.grabsPrepend?
(a.grabs=c.concat(a.grabs),a.grabsLoading=!1):(a.grabs=a.grabs.concat(c),b.last&&0<b.last?setTimeout(function(h,k){comms.api.command(h,"getcameragrabs&enddate="+k,agent.eventManager.popPhotos)},2E3,a,data.last):(a.grabsLoading=!1,a.grabsPrepend=!0))}else a.grabsLoading=!1,a.grabsPrepend=!0}}},monthNames="Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" "),dayNames="Sun Mon Tue Wed Thu Fri Sat".split(" ");Date.prototype.addHours=function(a){this.setTime(this.getTime()+36E5*a);return this};
Date.prototype.addMinutes=function(a){this.setTime(this.getTime()+6E4*a);return this};
Date.prototype.formatDate=function(a){a||(a="MM/dd/yyyy");var b=this.getMonth()+1,c=this.getFullYear();-1<a.indexOf("yyyy")?a=a.replace("yyyy",c.toString()):-1<a.indexOf("yy")&&(a=a.replace("yy",c.toString().substr(2,2)));a=a.replace("dd",this.getDate().toString().padL(2,"0"));c=this.getHours();-1<a.indexOf("t")&&(a=11<c?a.replace("t"," PM"):a.replace("t"," AM"));-1<a.indexOf("HH")&&(a=a.replace("HH",c.toString().padL(2,"0")));-1<a.indexOf("hh")&&(12<c&&(c-=12),0===c&&(c=12),a=a.replace("hh",c.toString().padL(2,
"0")));-1<a.indexOf("mm")&&(a=a.replace("mm",this.getMinutes().toString().padL(2,"0")));-1<a.indexOf("ss")&&(a=a.replace("ss",this.getSeconds().toString().padL(2,"0")));a=a.replace("MMM",monthNames[b-1]);return a=a.replace("MM",b.toString().padL(2,"0"))};String.repeat=function(a,b){for(var c="",e=0;e<b;e++)c+=a;return c};
String.prototype.prettyBytes=function(){var a=parseInt(this,10);return 1024>a?a+" Bytes":1048576>a?(a/1024).toFixed(1)+" KB":1073741824>a?(a/1048576).toFixed(2)+" MB":(a/1073741824).toFixed(3)+" GB"};String.prototype.toHHMMSS=function(){var a=parseInt(this,10),b=Math.floor(a/3600),c=Math.floor((a-3600*b)/60);a=a-3600*b-60*c;10>b&&(b="0"+b);10>c&&(c="0"+c);10>a&&(a="0"+a);return b+":"+c+":"+a};
String.prototype.padL=function(a,b){if(!a||1>a)return this;b||(b=" ");var c=a-this.length;return 1>c?this.substr(0,a):(String.repeat(b,c)+this).substr(0,a)};String.prototype.padR=function(a,b){if(!a||1>a)return this;b||(b=" ");var c=a-this.length;1>c&&this.substr(0,a);return(this+String.repeat(b,c)).substr(0,a)};Array.prototype.hasObject=Array.indexOf?function(a){return-1!==this.indexOf(a)}:function(a){for(var b=this.length+1;1===b;)if(this[b-1]===a)return!0;return!1};
String.prototype.endsWith||(String.prototype.endsWith=function(a,b){if(void 0===b||b>this.length)b=this.length;return this.substring(b-a.length,b)===a});String.prototype.format=String.prototype.f=function(){for(var a=this,b=arguments.length;b--;)a=a.replace(new RegExp("\\{"+b+"\\}","gm"),arguments[b]);return a};

//comms.js
var comms={initialized:!1,reconDelays:[1,10,30],transports:["webSockets","serverSentEvents","longPolling"],errorState:!1,disabled:!1,localCandidates:[],remoteCandidates:[],hasRemoteDescription:!1,usingTransceivers:!1,connectionState:"",currentConnection:null,bulkCandidates:!0,hasConnected:!1,textDecoder:window.TextDecoder?new window.TextDecoder:null,deinit:function(){wizard.pollDevice&&(clearInterval(wizard.pollDevice),wizard.pollDevice=null);window.isLocal?comms.local.deinit():comms.signalR.deinit();
comms.webRTC.deinit();agent.server&&(agent.server.views=[]);agent.helpers.setState("loading")},send:function(a){window.isLocal?comms.local.send(a):comms.signalR.send(a)},connect:function(){window.isLocal?comms.local.connect():comms.signalR.connect()},failed:function(a){var b=agent.helpers.translate;agent.errorMessage=[{txt:a?a:b("TryAnotherBrowser")},{txt:b("Retry"),cmd:"reinit"}];editing.ui.teardown(!0);comms.errorState=!0;null!==agent.preloader&&agent.preloader.hide();window.isLocal?comms.local.deinit():
comms.signalR.deinit()},local:{poll:function(){$.ajax({type:"GET",url:"poll.json?id="+comms.localID+"&r="+Math.random(),contentType:"application/json",dataType:"json",success:function(a){""!==a&&(console.log("Received: "+a),comms.webRTC.received(JSON.stringify(a)))},error:function(a,b,d){console.log(a+" "+b+" "+d)}})},init:function(){comms.localID=Math.random();comms.localPoll=window.setInterval(comms.local.poll,100);var a=agent.server;a.webRTCConnection=new comms.webRTC.Connect(a);a.webRTCConnection.init()},
needsInit:!0,server:null,config:null,connected:!1,deinit:function(){window.clearInterval(comms.localPoll)},failed:function(){var a=agent.helpers.translate;agent.errorMessage=[{txt:a("FailedLocal")},{txt:a("Retry"),cmd:"reinit"}];comms.errorState=!0;editing.ui.teardown(!0)},send:function(a){var b="";try{b=JSON.stringify(a)}catch(d){console.error(d);return}$.ajax({type:"POST",url:"cmd.json?id="+comms.localID+"&r="+Math.random(),contentType:"application/json",dataType:"json",data:b,success:function(d){},
error:function(d,e,c){console.log(d+" "+e+" "+c)}})},connect:function(){var a=agent.helpers.translate;if(null===comms.textDecoder)agent.errorMessage=[{txt:a("BrowserIncompatible")},{txt:a("OK")}],comms.errorState=!0;else{comms.local.needsInit=!1;a=agent.server;a.eventList=[];a.include=!0;a.selected=!1;a.isAccess=!1;a.Permissions=null;a.type="Server";if(-1<a.iSpyAccessID){for(var b=0;b<agent.config.accessServers.length;b++){var d=agent.config.accessServers[b];d.id===a.iSpyAccessID&&(a.Permissions=
d)}a.isAccess=!0}a.objectCount=0;a.hasExtendedAPI=!0;a.gotObjectList=!1;comms.local.init()}}},signalR:{needsInit:!0,server:null,connected:!1,deinit:function(){comms.signalR.needsInit=!0;comms.signalR.server&&(console.log("stopping signalr"),comms.signalR.server.stop()["catch"](function(a){comms.signalR.server=null;console.log("error stopping signalr: "+a);console.log("signalr disconnected")}).then(function(){comms.signalR.server=null}))},send:function(a){try{agent.server.serverless?(a.fromConnectionID=
agent.server.connectionId,console.log("SigR Send: "+JSON.stringify(a)),$.ajax({type:"POST",url:agent.server.signalr+"/agentHub/messages",data:JSON.stringify(a),contentType:"application/json; charset=utf-8",dataType:"json",success:function(b){},failure:function(b){}})):comms.signalR.server.send("ProcessJSON",JSON.stringify(a))}catch(b){console.log("Error sending data"),console.error(b)}},connect:function(){function a(){comms.signalR.server=null}function b(){comms.disabled||(comms.signalR.server=(new signalR.HubConnectionBuilder).withUrl(agent.server.signalr+
"/agentHub").build(),comms.signalR.server.on("ProcessJSON",function(c){console.log("SigR Recv: "+c);comms.signalR.needsInit&&d();comms.errorState&&(comms.errorState=!1,agent.errorMessage=null);comms.webRTC.received(c)}),comms.signalR.server.onclose(a),comms.signalR.server.start({transport:comms.transports})["catch"](a))}function d(){comms.signalR.needsInit=!1;var c=agent.server;c.eventList=[];c.include=!0;c.selected=!1;c.isAccess=!1;c.Permissions=null;c.type="Server";if(-1<c.iSpyAccessID){for(var f=
0;f<agent.config.accessServers.length;f++){var g=agent.config.accessServers[f];g.id===c.iSpyAccessID&&(c.Permissions=g)}c.isAccess=!0}c.objectCount=0;c.hasExtendedAPI=!0;c.gotObjectList=!1;c.webRTCConnection=new comms.webRTC.Connect(c);c.webRTCConnection.init()}var e=agent.helpers.translate;null===comms.textDecoder?(agent.errorMessage=[{txt:e("BrowserIncompatible")},{txt:e("OK")}],comms.errorState=!0):comms.signalR.server?comms.signalR.send({action:"test"}).then(function(){try{d()}catch(c){console.error(c)}})["catch"](function(c){console.error(c);
console.log("reconnecting signalr");comms.signalR.connect()}):comms.signalR.server?d():(comms.signalR.needsInit=!0,b())}},webRTC:{checkMediaPermissions:function(){function a(){try{navigator.mediaDevices.getUserMedia({audio:!0}).then(function(c){window.setTimeout(function(f){f.getTracks().forEach(function(g){return g.stop()})},1E3,c);d||agent.server.webRTCConnection.doinit()})["catch"](function(c){"NotAllowedError"!==c.name||agent.isApp||window.self!==window.top?("NotFoundError"===c.name&&agent.storage.set("nodevices",
"true"),agent.server.webRTCConnection.doinit()):(c=agent.helpers.translate,comms.failed(c("NeedMediaPermission")))})}catch(c){console.log(c),agent.server.webRTCConnection.doinit()}}if(window.isLocal&&!agent.isFirefox||"true"===agent.storage.get("nodevices","false"))agent.server.webRTCConnection.doinit();else{var b="";agent.isApp||(b='<div><hr /><img src="//ispycontent.azureedge.net/content/access_mic.gif"/></div>');var d=!1,e=agent.helpers.translate;try{navigator.permissions&&window.self===window.top?
navigator.permissions.query({name:"microphone"}).then(function(c){d=!0;switch(c.state){case "granted":agent.server.webRTCConnection.doinit();break;case "denied":case "prompt":editing.helpers.confirm(e("AllowMedia"),a,null,!0)}c.onchange=function(){switch(c.state){case "granted":agent.server.webRTCConnection.doinit();break;case "prompt":case "denied":editing.helpers.confirm(e("AllowMedia")+b,a,null,!0)}}})["catch"](function(c){console.log(c);"false"===agent.storage.get("promptedMediaPermission","false")?
(agent.storage.set("promptedMediaPermission","true"),editing.helpers.confirm(e("AllowMedia"),a,null,!0)):a()}):(d=!1,a())}catch(c){console.log(c),"false"===agent.storage.get("promptedMediaPermission","false")?(agent.storage.set("promptedMediaPermission","true"),editing.helpers.confirm(e("AllowMedia"),a,null,!0)):a()}}},checkConnection:function(){console.log("RTC Connection: "+comms.connectionState);"Connected"!==comms.connectionState&&(agent.helpers.setState("initError"),editing.ui.teardown(!0))},
deinit:function(){agent.server&&agent.server.webRTCConnection&&agent.server.webRTCConnection.close();comms.connectionState="Disconnected"},received:function(a){a=JSON.parse(a);var b=agent.server;if(null!==b){var d=b.webRTCConnection,e=agent.helpers.translate;switch(a.command){case "disconnect":agent.errorMessage=[{txt:e("Disconnected")},{txt:e("Retry"),cmd:"reinit"}];comms.disabled=!0;window.isLocal||comms.signalR.server.stop();comms.localCandidates=[];comms.remoteCandidates=[];break;case "register":b.serverless=
!0===a.serverless;b.serverless&&(b.connectionId=a.connectionId);if(!agent.promptedNotifications&&(agent.promptedNotifications=!0,!agent.isApp))switch(""===agent.config.pushPlatform&&(agent.config.pushPlatform="web"),agent.config.pushPlatform){case "web":agent.notifications.prompt()}break;case "OnSuccessAnswer":d.connection&&(console.log("OnSuccessAnswer[remote]: "+a.sdp),d.remoteAnswer=a.sdp,d.connection.setRemoteDescription({type:"answer",sdp:d.remoteAnswer}).then(function(){comms.hasRemoteDescription=
!0;for(var f=0;f<comms.remoteCandidates.length;f++)try{d.connection.addIceCandidate(comms.remoteCandidates[f])}catch(g){console.log("error adding remote ice candidate: "+g)}if(comms.bulkCandidates)f={connectionID:b.connectionID,sessionID:b.sessionID,action:"relay",command:"onicecandidates",candidates:comms.localCandidates},comms.send(f);else for(f=0;f<comms.localCandidates.length;f++)comms.send(comms.localCandidates[f]);comms.remoteCandidates=[];comms.localCandidates=[]})["catch"](function(f){f=agent.helpers.translate;
comms.failed(f("LostConnection"))}));break;case "OnIceCandidate":if(d.connection){console.log("OnIceCandidate[remote]: "+a.sdp);var c=new RTCIceCandidate({sdpMLineIndex:a.sdp_mline_index,sdpMid:a.sdp_mid,candidate:a.sdp});"have-local-offer"===d.connection.signalingState?comms.remoteCandidates.push(c):d.connection.addIceCandidate(c)["catch"](function(f){console.log("error adding ice candidate: "+f)})}break;case "OnIceCandidates":if(d.connection&&a.candidates)for(console.log("OnIceCandidates[remote]: "+
a.candidates.length),e=0;e<a.candidates.length;e++)c=a.candidates[e],c=new RTCIceCandidate({sdpMLineIndex:c.sdp_mline_index,sdpMid:c.sdp_mid,candidate:c.sdp}),"have-local-offer"===d.connection.signalingState?comms.remoteCandidates.push(c):d.connection.addIceCandidate(c)["catch"](function(f){console.log("error adding ice candidate: "+f)})}}},Connect:function(a){function b(){try{a.dataChannel&&(a.dataChannel.close(),delete a.dataChannel),a.dataChannel=comms.webRTC.buildDataChannel(a,"serverdata",!0),
a.talkDataChannel=comms.webRTC.buildDataChannel(a,"talk",!1)}catch(p){comms.failed(t("TryAnotherBrowser"));return}if(comms.usingTransceivers){a.chunkDataChannel=comms.webRTC.buildDataChannel(a,"chunk",!0);a.downloadDataChannels=[];for(var k=0;4>=k;k++)a.downloadDataChannels.push(comms.webRTC.buildDataChannel(a,"download_"+k,!0));a.dataChannelIndex=0}a.dataChannel.onopen=function(){console.log("server data opened");comms.api.command(a,"loadAPI",comms.api.attach,comms.failed)};a.dataChannel.onclose=
function(p){console.log("serverdata closed")};a.dataChannel.onerror=function(p){console.log("serverdata error ("+p+")")}}function d(){agent.helpers.setState("initError");editing.ui.teardown(!0);comms.errorState=!0;null!==agent.preloader&&agent.preloader.hide()}function e(){comms.connectionState=h.connection.connectionState;console.log("connection state: "+h.connection.connectionState);c(h.connection.connectionState)}function c(k){switch(k){case "disconnected":comms.connectionState="Disconnected";
break;case "failed":if(!comms.hasConnected){comms.failed();break}h.connection.close();h.isShutdown||d();break;case "connected":comms.connectionState="Connected";comms.hasConnected=!0;a.isReconnect&&(agent.errorMessage=null);comms.errorState=!1;a.isReconnect=!1;window.isLocal?comms.local.deinit():comms.signalR.deinit();null!==agent.preloader&&agent.preloader.hide();break;case "closed":h.isShutdown||d()}}function f(k){comms.connectionState=h.connection.iceConnectionState;"new"===comms.connectionState&&
(comms.connectionState="Connecting...");console.log("ice state: "+h.connection.iceConnectionState);h.connection.onconnectionstatechange||c(h.connection.iceConnectionState)}function g(k){k.message?console.log("onError: "+k.message):console.log(k)}function l(k){console.log("Channel ["+k.channel.label+"] created by remote peer")}function q(k){try{a.mediaStream?a.mediaStream.addTrack(k.track):a.mediaStream=new MediaStream([k.track]),agent.videoPlayer.srcObject=a.mediaStream,console.log("remote media connection success!")}catch(p){console.log("Failed to connect to remote media!",
p)}}function m(k){if(k.candidate&&"Connected"!==comms.connectionState){console.log("onicecandidate[local]: "+k.candidate.candidate);null===k.candidate.usernameFragment&&(k.candidate.usernameFragment="");var p={connectionID:a.connectionID,sessionID:a.sessionID,action:"relay",command:"onicecandidate",candidate:k.candidate};comms.hasRemoteDescription?comms.send(p):comms.bulkCandidates?comms.localCandidates.push(k.candidate):comms.localCandidates.push(p)}else console.log("onicecandidate: complete.")}
function n(k){if(agent.isIOS||agent.isSafari||agent.isIOSApp)console.log("forcing vp8 (safari)"),k.sdp=CodecsHandler.preferCodec(k.sdp,"vp8");var p=new RTCSessionDescription(k);h.connection.setLocalDescription(p).then(function(){console.log("Local description set");var r=Math.max(300,$(window).width()),v=Math.max(200,$(window).height()-agent.sizes.topBar-agent.sizes.bottomBar);0!==r%2&&r++;0!==v%2&&v++;r={connectionID:a.connectionID,sessionID:a.sessionID,action:"relay",command:"offer",turn:a.turnServer,
desc:k,maxWidth:r,maxHeight:v};window.isLocal&&(r.IceConfig=agent.config.RTCServers.iceServers);console.log("local desc: "+r);comms.send(r)},g)}comms.iceCandidates=[];comms.hasRemoteDescription=!1;this.remoteAnswer=this.connection=a.mediaStream=null;this.isShutdown=!1;var h=this,u={optional:[{DtlsSrtpKeyAgreement:!0}]};this.retry=function(){d()};this.close=function(){h.isShutdown=!0;return h.connection?h.connection.close():!0};this.init=function(){comms.webRTC.checkMediaPermissions()};this.doinit=
function(){a.mediaStream=null;if("Connected"!==comms.connectionState){comms.connectionState="Connecting...";comms.localCandidates=[];comms.remoteCandidates=[];try{for(var k=JSON.parse(JSON.stringify(agent.config.RTCServers)),p=0;p<k.iceServers.length;p++)k.iceServers[p].urls=k.iceServers[p].urls.replace("SERVER",a.turnServer);comms.currentConnection=h.connection=new RTCPeerConnection(k,u)}catch(r){agent.errorMessage=[{txt:"Try another browser"}];comms.errorState=!0;return}(agent.isIOS||agent.isIOSApp)&&
h.connection.addTransceiver&&(comms.usingTransceivers=!0,agent.canAutoPlay=agent.isIOSApp,h.connection.addTransceiver("audio"),h.connection.addTransceiver("video"));h.connection.ontrack=q;h.connection.ondatachannel=l;h.connection.onicecandidate=m;null===h.connection.onconnectionstatechange&&(h.connection.onconnectionstatechange=e);h.connection.oniceconnectionstatechange=f;h.connection.canTrickleIceCandidates=!0;h.connection.onnegotiationneeded=function(r){console.log("negotiation needed "+r)};h.connection.onsignalingstatechange=
function(r){console.log("signaling state change: "+r)};b();h.connection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0,voiceActivityDetection:!1,iceRestart:!1}).then(n,g)}};return this},buildDataChannel:function(a,b,d){d=a;d.parent&&(d=d.parent);console.log("creating "+b);d=d.webRTCConnection.connection.createDataChannel(b,{ordered:!0,maxRetransmits:5,negotiated:!1});d.buffer=[];d.obj=a;d.onmessage=function(e){var c=e.currentTarget;comms.webRTC.readFromArrayBuffer(e.data).then(function(f){f=
comms.textDecoder.decode(f);var g=f.substring(0,1);switch(g){case "P":case "F":var l=f.substring(1,f.indexOf("_")),q=f.substring(f.indexOf("_")+1);var m=c.obj.dataChannel.buffer[l];if(null!==m){m.response=null===m.response?q:m.response+q;if("P"===g)return;f=m.response;delete c.obj.dataChannel.buffer[l]}break;case "{":break;default:return}g=null;try{g=JSON.parse(f)}catch(n){console.log("error parsing json: "+n);if(m)switch(m.response=null,console.log(m.command.command),m.command.command){case "loadAPI":setTimeout(function(h){comms.api.command(h.command.obj,
"loadAPI",comms.api.attach,comms.failed)},200,m);break;case "loadObjects":setTimeout(function(h){comms.api.command(h.command.obj,"loadObjects",comms.api.loadObjects,comms.failed)},200,m)}return}agent.data.processIncoming(m,g)},function(f){console.log("data channel error")})};d.onerror=function(e){console.log("data channel error")};d.onclose=function(e){console.log("closed "+b)};d.onopen=function(e){console.log("opened "+b)};return d},readFromArrayBuffer:function(a){return new Promise(function(b,d){var e=
new FileReader;e.onload=function(){b(e.result)};e.onerror=d;e.readAsArrayBuffer(new Blob([a],{type:"application/octet-stream"}))})},sendData:function(a,b){if(a&&"open"===a.readyState)try{a.send(b)}catch(d){console.log("Error sending data"),console.error(d)}else console.log("stream readystate is "+a?a.readyState:"null")}},api:{attach:function(a,b){agent.server.API=b;comms.api.command(a,"loadObjects",comms.api.loadObjects,comms.failed);agent.menuCanvas.lastDraw=0},loadObjects:function(a,b){var d=agent.helpers.translate;
"undefined"===typeof b.settings.supportsPlugins?(a.supportsPlugins=!0,a.canUpdate=!0):(a.supportsPlugins=b.settings.supportsPlugins,a.canUpdate=b.settings.canUpdate);a.hasRTMP=!0;a.background=b.settings.background;a.armed=void 0===b.settings.isArmed?!0:b.settings.isArmed;a.armed||agent.notifications.notify("Broadcast",d("Warning"),d("SystemDisarmed"));a.objectList=b.objectList;a.locations=b.locations;a.profiles=b.profiles;a.rtmpStreaming=b.rtmpStreaming;a.gotObjectList=!0;for(j=0;j<a.objectList.length;j++)obj=
a.objectList[j],agent.helpers.initObject(obj,!1),obj.hasPermission||(a.objectList.splice(j,1),j--);a.views=b.views;agent.helpers.checkViews();agent.eventManager.loadEvents();agent.helpers.setState("ok");0!==a.objectList.length||comms.shownHelp||(comms.shownHelp=!0,editing.showHelp())},bufferIdent:0,getIdent:function(){comms.api.bufferIdent++;100<comms.bufferIdent&&(comms.bufferIdent=0);var a=comms.api.bufferIdent.toString();agent.server.dataChannel.buffer[a]&&delete agent.server.dataChannel.buffer[a];
return a},command:function(a,b,d,e){comms.api.load("loadjson",a,b,"",d,e)},loadJSON:function(a,b,d,e,c){comms.api.load("loadjson",a,b,JSON.stringify(d),e,c)},saveJSON:function(a,b,d,e){comms.api.request(a,{type:"savejson",command:"savejson",successCallback:d,errorCallback:e,data:b},"json",d,e)},request:function(a,b,d,e,c){var f=agent.server,g=-1,l=-1;switch(a.type){case "Device":g=a.id;l=a.typeID;break;case "Grab":case "Event":g=a.parent.id,l=a.parent.typeID}b.ot=l;b.oid=g;b.lc=agent.language.current;
b.handler=d;b.ident=comms.api.getIdent();d=JSON.stringify(b);b.obj=a;b.successCallback=e;b.errorCallback=c;f.dataChannel.buffer[b.ident]={command:b,response:null};a=0;for(e=!1;!e;)c=Math.min(d.length-a,16E3),e=16E3>c,c=d.substring(a,a+c),c=e?"F"+b.ident+"_"+c:"P"+b.ident+"_"+c,comms.webRTC.sendData(f.dataChannel,c),a+=16E3},load:function(a,b,d,e,c,f){var g=agent.server,l=-1,q=-1;b&&"Device"===b.type&&(l=b.id,q=b.typeID);comms.api.process(g,{type:a,command:d,oid:l,ot:q,successCallback:c,errorCallback:f,
obj:b,data:e})},process:function(a,b){a.dataChannel||console.log("datachannel not ready yet: "+b);var d=comms.api.getIdent();b.data||(b.data=!1);a.dataChannel.buffer[d]={command:b,response:null,timestamp:new Date};for(var e=0,c=!1,f=JSON.stringify({type:b.type,ident:d,oid:b.oid,ot:b.ot,handler:"json",cmd:b.command,lc:agent.language.current,data:b.data});!c;){var g=Math.min(f.length-e,16200);c=16200>g;g=f.substring(e,e+g);g=c?"F"+d+"_"+g:"P"+d+"_"+g;comms.webRTC.sendData(a.dataChannel,g);e+=16200}},
downloadFile:function(a,b,d,e,c){if(a){if(comms.usingTransceivers){var f=a.parent?a.parent:a;var g=f.downloadDataChannels[f.dataChannelIndex];g.send(JSON.stringify(b));f.dataChannelIndex++;f.dataChannelIndex>=f.downloadDataChannels.length&&(f.dataChannelIndex=0)}else g=comms.webRTC.buildDataChannel(a,"download_"+(new Date).getTime(),!0),g.onopen=function(){g.send(JSON.stringify(b))};g.dataPackets=[];var l=0,q=0;f=b.filename;var m=f.lastIndexOf("\\");-1<m&&(f=f.substring(m+1));b.file=f;agent.isAndroidApp&&
(a.td=new window.TextDecoder("iso-8859-1"),ANDROID_Downloader.CreateDownload(b.file));b.type="video/mp4";switch(b.file.substring(b.file.lastIndexOf(".")+1)){case "json":b.type="application/json";break;case "mp3":b.type="audio/mp3";break;case "vp8":b.type="video/vp8";break;case "ogg":b.type="audio/ogg";break;case "jpg":b.type="image/jpeg";break;case "xml":b.type="text/xml"}g.onmessage=function(n){if(0===l)n=JSON.parse(n.data),l=parseInt(n.size);else if("[object Blob]"===n.data.toString()){var h=new FileReader;
h.onload=function(){var u=new Uint8Array(this.result);g.dataPackets.push(u);q+=u.length;u=q/l*100;e&&e(u);q===l&&((!c||c.is(":visible"))&&0<g.dataPackets.length&&(u=new Blob(g.dataPackets,{type:b.type}),d(u)),comms.usingTransceivers||g.close())};h.readAsArrayBuffer(n.data)}else n=new Uint8Array(n.data),g.dataPackets.push(n),q+=n.length,h=q/l*100,e&&e(h),agent.isAndroidApp&&ANDROID_Downloader.AddPacket(b.file,a.td.decode(n.buffer)),q===l&&((!c||c.is(":visible"))&&0<g.dataPackets.length&&(e&&e(100),
agent.isAndroidApp?(ANDROID_Downloader.FinishDownload(b.file),a.td=null):(n=new Blob(g.dataPackets,{type:b.type}),d(n))),comms.usingTransceivers||g.close());c&&!c.is(":visible")&&(comms.usingTransceivers||g.close())}}}}};

//codecsHandler.js
var CodecsHandler=function(){function n(b,a){var c=p(b);return!c.videoCodecNumbers||"vp8"===a&&c.vp8LineNumber===c.videoCodecNumbers[0]||"vp9"===a&&c.vp9LineNumber===c.videoCodecNumbers[0]||"h264"===a&&c.h264LineNumber===c.videoCodecNumbers[0]?b:b=l(b,a,c)}function l(b,a,c,e){var d="";if("vp8"===a){if(!c.vp8LineNumber)return b;d=c.vp8LineNumber}if("vp9"===a){if(!c.vp9LineNumber)return b;d=c.vp9LineNumber}if("h264"===a){if(!c.h264LineNumber)return b;d=c.h264LineNumber}a=c.videoCodecNumbersOriginal.split("SAVPF")[0]+
"SAVPF ";var f=[d];e&&(f=[]);c.videoCodecNumbers.forEach(function(g){g!==d&&f.push(g)});a+=f.join(" ");return b=b.replace(c.videoCodecNumbersOriginal,a)}function p(b){var a={};b.split("\n").forEach(function(c){0===c.indexOf("m=video")&&(a.videoCodecNumbers=[],c.split("SAVPF")[1].split(" ").forEach(function(e){(e=e.trim())&&e.length&&(a.videoCodecNumbers.push(e),a.videoCodecNumbersOriginal=c)}));-1===c.indexOf("VP8/90000")||a.vp8LineNumber||(a.vp8LineNumber=c.replace("a=rtpmap:","").split(" ")[0]);
-1===c.indexOf("VP9/90000")||a.vp9LineNumber||(a.vp9LineNumber=c.replace("a=rtpmap:","").split(" ")[0]);-1===c.indexOf("H264/90000")||a.h264LineNumber||(a.h264LineNumber=c.replace("a=rtpmap:","").split(" ")[0])});return a}function k(b,a,c,e,d){for(c=-1!==c?c:b.length;a<c;++a)if(0===b[a].indexOf(e)&&(!d||-1!==b[a].toLowerCase().indexOf(d.toLowerCase())))return a;return null}function m(b){return(b=b.match(/a=rtpmap:(\d+) \w+\/\d+/))&&2===b.length?b[1]:null}function q(b,a){a=a||{};var c=a.min,e=a.max,
d=b.split("\r\n"),f=k(d,0,-1,"a=rtpmap","VP8/90000"),g;f&&(g=m(d[f]));if(!g)return b;f=k(d,0,-1,"a=rtpmap","rtx/90000");var h;f&&(h=m(d[f]));if(!f)return b;h=k(d,0,-1,"a=fmtp:"+h.toString(),void 0);null!==h&&(d[h]=d[h].concat("\r\na=fmtp:"+(g+" x-google-min-bitrate="+(c||"228")+"; x-google-max-bitrate="+(e||"228"))),b=d.join("\r\n"));return b}function r(b,a){a=a||{};var c=b.split("\r\n"),e=k(c,0,-1,"a=rtpmap","opus/48000"),d;e&&(d=m(c[e]));if(!d)return b;e=k(c,0,-1,"a=fmtp:"+d.toString(),void 0);
if(null===e)return b;d="; stereo="+("undefined"!==typeof a.stereo?a.stereo:"1");d+="; sprop-stereo="+("undefined"!==typeof a["sprop-stereo"]?a["sprop-stereo"]:"1");"undefined"!==typeof a.maxaveragebitrate&&(d+="; maxaveragebitrate="+(a.maxaveragebitrate||1048576));"undefined"!==typeof a.maxplaybackrate&&(d+="; maxplaybackrate="+(a.maxplaybackrate||1048576));"undefined"!==typeof a.cbr&&(d+="; cbr="+("undefined"!==typeof a.cbr?a.cbr:"1"));"undefined"!==typeof a.useinbandfec&&(d+="; useinbandfec="+a.useinbandfec);
"undefined"!==typeof a.usedtx&&(d+="; usedtx="+a.usedtx);"undefined"!==typeof a.maxptime&&(d+="\r\na=maxptime:"+a.maxptime);c[e]=c[e].concat(d);return b=c.join("\r\n")}return{removeVPX:function(b){var a=p(b);b=l(b,"vp9",a,!0);return b=l(b,"vp8",a,!0)},disableNACK:function(b){if(!b||"string"!==typeof b)throw"Invalid arguments.";b=b.replace("a=rtcp-fb:126 nack\r\n","");b=b.replace("a=rtcp-fb:126 nack pli\r\n","a=rtcp-fb:126 pli\r\n");b=b.replace("a=rtcp-fb:97 nack\r\n","");return b=b.replace("a=rtcp-fb:97 nack pli\r\n",
"a=rtcp-fb:97 pli\r\n")},prioritize:function(b,a){if(a&&a.getSenders&&a.getSenders().length){if(!b||"string"!==typeof b)throw"Invalid arguments.";a.getSenders().forEach(function(c){for(var e=c.getParameters(),d=0;d<e.codecs.length;d++)if(e.codecs[d].mimeType===b){e.codecs.unshift(e.codecs.splice(d,1));break}c.setParameters(e)})}},removeNonG722:function(b){return b.replace(/m=audio ([0-9]+) RTP\/SAVPF ([0-9 ]*)/g,"m=audio $1 RTP/SAVPF 9")},setApplicationSpecificBandwidth:function(b,a,c){if(a&&("undefined"===
typeof isFirefox||!isFirefox)){c&&(a.screen?300>a.screen&&console.warn("It seems that you are using wrong bandwidth value for screen. Screen sharing is expected to fail."):console.warn("It seems that you are not using bandwidth for screen. Screen sharing is expected to fail."));a.screen&&c&&(b=b.replace(/b=AS([^\r\n]+\r\n)/g,""),b=b.replace(/a=mid:video\r\n/g,"a=mid:video\r\nb=AS:"+a.screen+"\r\n"));if(a.audio||a.video)b=b.replace(/b=AS([^\r\n]+\r\n)/g,"");a.audio&&(b=b.replace(/a=mid:audio\r\n/g,
"a=mid:audio\r\nb=AS:"+a.audio+"\r\n"));a.screen?b=b.replace(/a=mid:video\r\n/g,"a=mid:video\r\nb=AS:"+a.screen+"\r\n"):a.video&&(b=b.replace(/a=mid:video\r\n/g,"a=mid:video\r\nb=AS:"+a.video+"\r\n"))}return b},setVideoBitrates:function(b,a){return q(b,a)},setOpusAttributes:function(b,a){return r(b,a)},preferVP9:function(b){return n(b,"vp9")},preferCodec:n,forceStereoAudio:function(b){var a=b.split("\r\n"),c=null,e;for(e=0;e<a.length;e++)if(-1!==a[e].search("opus/48000")){var d=extractSdp(a[e],/:(\d+) opus\/48000/i);
break}for(e=0;e<a.length;e++)if(-1!==a[e].search("a=fmtp")&&extractSdp(a[e],/a=fmtp:(\d+)/)===d){c=e;break}if(null===c)return b;a[c]=a[c].concat("; stereo=1; sprop-stereo=1");return b=a.join("\r\n")}}}();

//editing.js
var editing={newDevice:{alerts:!1,record:!1,resize:!1,raw:!0},sectionList:[{text:"AlertActions",value:!1},{text:"Alerts",value:!1},{text:"Cloud",value:!1},{text:"FTP",value:!1},{text:"FishEyeCorrection",value:!1},{text:"General",value:!1},{text:"Intelligence",value:!1},{text:"Intervals",value:!1},{text:"Mask",value:!1},{text:"MotionDetection",value:!1},{text:"Photos",value:!1},{text:"PTZ",value:!1},{text:"PTZSchedule",value:!1},{text:"Recording",value:!1},{text:"Rotation",value:!1},{text:"Schedule",
value:!1},{text:"StorageManagement",value:!1},{text:"Tagging",value:!1},{text:"Timelapse",value:!1},{text:"Timestamp",value:!1}],sidebar:null,nibSize:"fa-sm",detectorMode:"live",renderObjects:[],pageElement:null,validate:!1,importantSnackbar:!1,snackbarElement:null,elementClicked:null,openDevice:null,objectsUpdated:function(){var a=editing.currentRenderObject();if(a&&a.name&&"editDevices"===a.name())editing.renderObjects.pop(),editing.editDevices();else if(null!==editing.openDevice&&(a=agent.helpers.findObject(editing.openDevice.ot,
editing.openDevice.id))){var b=agent.server.views[agent.viewIndex],d={oid:editing.openDevice.id,ot:editing.openDevice.ot};-1===b.objects.indexOf(d)&&b.objects.push(d);agent.screens.live.saveViews();agent.screens.live.startview();editing.openDevice.wait?(b=agent.helpers.translate,editing.openDevice=null,editing.helpers.setStatus(b("Loading")),setTimeout(editing.editObject,3E3,a)):(editing.openDevice=null,editing.editObject(a))}},pages:[{url:"partials/render.html",html:"",name:"render"},{url:"partials/edit_view.html",
html:"",name:"edit_view"},{url:"partials/select_device.html",html:"",name:"select_device"},{url:"partials/render_simple.html",html:"",name:"render_simple"},{url:"partials/render_sidebar.html",html:"",name:"render_sidebar"},{url:"partials/payment_history.html",html:"",name:"payment_history"},{url:"partials/presets.html",html:"",name:"presets"},{url:"partials/download.html",html:"",name:"download"}],showShield:function(){$(".modal-backdrop")[0]||$("<div/>",{"class":"modal-backdrop fade show"}).appendTo("body")},
hideShield:function(){$(".modal-backdrop").remove()},modalVisible:function(){return!!$(".modal-backdrop")[0]},init:function(a,b){function d(c){return jQuery.isFunction(c)?c():c}editing.pageElement=$(a);editing.snackbarElement=$(b);ko.bindingHandlers.slider={init:function(c,e,g){var f=$(c),m=g();g=d(m.attr.range);var l={range:g,min:d(m.attr.min),max:d(m.attr.max),tooltip_position:"bottom"};m=l.values=d(m.attr.value);g?l.values=[parseInt(m[0]),parseInt(m[1])]:l.value=parseInt(m[0]);l.slide=function(q,
r){var w=q.target.attributes.affects,F=r.values;F||(F=r.value);e()(F);""!==w.value&&(agent.helpers.findID(editing.currentRenderObject().origData,"id",w.value)[0].value=F);q.target.nextElementSibling&&$(q.target.nextElementSibling).text(F)};f.slider(l);ko.utils.domNodeDisposal.addDisposeCallback(c,function(){$(c).slider("destroy")})},update:function(c,e,g,f,m){e=ko.unwrap(e());$(c).slider("value",e);f.live&&f.live()&&!agent.suppressLiveUpdates&&(c=ko.mapping.toJS(f),f=editing.currentRenderObject().agentObject,
e="",editing.currentRenderObject().data.origin&&(e=editing.currentRenderObject().data.origin()),comms.api.saveJSON(f,{name:"liveupdate",origin:e,sections:[{items:[c]}]}))}};ko.bindingHandlers.DateTime={init:function(c,e,g){var f=$(c).parent(),m={locale:moment.locale(agent.language.current)};g().DateTime&&(m.date=g().DateTime());f.datetimepicker(m);f.on("change.datetimepicker",function(l){null!==l.oldDate&&e()(l.date.toDate())});ko.utils.domNodeDisposal.addDisposeCallback(c,function(){f.parent().datetimepicker("destroy")})},
update:function(c,e){ko.unwrap(e())}};ko.bindingHandlers.toggle={init:function(c,e,g){c=$(c);c.prop("checked",g().checked());c.bootstrapToggle({on:agent.helpers.translate("On"),off:agent.helpers.translate("Off")});c.change(function(){var f=e(),m=$(this).prop("checked");f(m)})}};ko.bindingHandlers.canvasManager={init:function(c,e,g){var f=editing.currentRenderObject();c=$(c);var m=g(),l=d(m.attr.width),q=d(m.attr.height);g=f.agentObject;var r=d(m.attr.max)||1,w=d(m.attr.data),F=d(m.attr.bindto),H=
d(m.attr.autosize),K=d(m.attr.overlay)||!1;m=d(m.attr.mode);l={mode:m,max:r,name:m,width:l,height:q,obj:g,overlay:K,bindto:F,data:w,autosize:H};switch(m){case "area":""===l.data?l.data=[]:jQuery.isArray(l.data)||(l.data=JSON.parse(l.data));break;case "motionzones":q=16;r=12;3072===l.data.length&&(q=64,r=48);l.motionArr=Array(q);for(w=0;w<q;w++)l.motionArr[w]=Array(r);for(r=q=0;r<l.motionArr.length;r++)for(w=0;w<l.motionArr[0].length;w++){l.motionArr[r][w]=0;try{l.motionArr[r][w]=parseInt(l.data.charAt(q)),
q++}catch(B){console.error(B)}}break;default:try{l.data=ko.toJS(l.data)}catch(B){l.data=[]}}l.change=function(B){e()(B)};c[0].renderEngine=new editing.ZoneRenderer(c[0],l,g,f);f.renderers.push(c[0].renderEngine)}};editing.helpers.loadHTML()},currentRenderObject:function(){return editing.renderObjects[editing.renderObjects.length-1]},editObject:function(a){var b=agent.helpers.translate;editing.helpers.setStatus(b("Loading"));switch(a.type){case "Device":wizard.editObject=a;comms.api.command(a,"editobject",
function(d,c){editing.helpers.setStatus("");$("body").css("pointer-events","");editing.helpers.render(d,c)});break;case "Server":comms.api.command(a,"getSettings",function(d,c){editing.helpers.setStatus("");editing.helpers.render(d,c)})}},deleteObject:function(a){comms.api.command(a,"deleteobject",function(){agent.currentObject===a&&(agent.currentObject=null)})},addServer:function(){var a=agent.helpers.translate,b=$.urlParam("code")||"";"enter_here"===b&&(b="");a={page:"render",data:{header:a("AddServer"),
okResult:"AddServer",name:"AddServer",sections:[{header:a("ClaimCode"),displayType:"Form",tabActive:!0,items:[{type:"Info",value:a("ClaimCodeInfo")},{text:"Code",value:b,type:"String",help:a("ClaimCode_help")}]}]}};a=ko.mapping.fromJS(a);editing.renderObjects.push(a);editing.helpers.renderPage("sm")},updateAgent:function(){var a=agent.helpers.translate,b=a("UpdateAgent")+'<br/><iframe src="https://www.ispyconnect.com/producthistory.aspx?productid='+agent.server.productID+'" frameBorder="0" style="width:100%;height:300px"></iframe>';
agent.server&&2330<agent.server.versionNumeric&&!agent.isIOS&&!agent.isIOSApp&&(b+="<br/>"+a("UpdateAvailableHelp"));editing.helpers.confirm(b,function(d){window.isLocal&&0===window.localConfig.SubscriptionLevel?editing.goRemote():agent.server.canUpdate?comms.api.command(d,"updateserver",function(c,e){var g=agent.helpers.translate;editing.helpers.setStatus(g("AgentRestart"))}):editing.goRemote()},agent.server)},backupRestore:function(){var a=agent.helpers.translate;if(2520>agent.server.versionNumeric)comms.api.command(obj.agentObject,
"getobjectsxml",function(c,e){b={page:"render",OKOnly:!1,name:"backupRestore",data:{header:a("BackupRestore"),okResult:"uploadXML",sections:[{header:a("BackupRestore"),displayType:"Form",tabActive:!0,items:[]}]}};b.data.sections[0].items.push({text:a("Configuration"),value:e.xml,type:"TextArea",help:a("Configuration_help")});var g=ko.mapping.fromJS(b);editing.renderObjects.push(g);editing.helpers.renderPage()});else{var b={page:"render_simple",OKOnly:!0,data:{header:a("BackupRestore"),okResult:"",
items:[]}};b.data.items.push({value:editing.helpers.buttonIcon2("fa-download",a("Download")),type:"ButtonIcon",action:"downloadConfig"});b.data.items.push({value:editing.helpers.buttonIcon2("fa-upload",a("Upload")),type:"ButtonIcon",action:"uploadConfig",help:a("Configuration_help2")});var d=ko.mapping.fromJS(b);editing.renderObjects.push(d);editing.helpers.renderPage()}},copySettings:function(){var a=agent.helpers.translate,b={page:"render",name:"copySettings",data:{header:a("CopySettings"),okResult:"copySections",
sections:[{header:a("CopySettings"),displayType:"Form",tabActive:!0,items:[]}]}},d={text:a("CopyFrom"),type:"Select",options:[{text:a("SelectDevice"),value:"-1",noTranslate:!0}],value:""},c={text:a("To"),type:"CheckBoxList",options:[],value:""},e;for(e=0;e<agent.server.objectList.length;e++){var g=agent.server.objectList[e];if(2===g.typeID){var f=""!==g.name?g.name:"object "+e;d.options.push({text:f,value:g.id});c.options.push({text:f,value:!1,oid:g.id,id:"cam_"+e})}}b.data.sections[0].items.push(d);
d={text:a("Section"),type:"CheckBoxList",options:[],value:""};for(e=0;e<editing.sectionList.length;e++)g=editing.sectionList[e],d.options.push({text:a(g.text),value:g.value,checked:g.value,id:"sec_"+e});b.data.sections[0].items.push(d);b.data.sections[0].items.push(c);a=ko.mapping.fromJS(b);editing.renderObjects.push(a);editing.helpers.renderPage()},editDevices:function(){function a(f){var m="";f.data.online&&(m+='<i class="fa fa-eye mr-1" aria-hidden="true" title="Online"></i>',f.data.alertsActive&&
(m+='<i class="fa fa-exclamation-circle mr-1" title="Alerts Active" aria-hidden="true"></i>'),f.data.recording&&(m+='<i class="fa fa-circle mr-1" title="Recording" aria-hidden="true"></i>'));return m}var b=agent.helpers.translate;b={page:"render",OKOnly:!0,name:"editDevices",data:{header:b("EditDevices"),okResult:"",sections:[{header:b("EditDevices"),displayType:"TableEdit",tabActive:!0,editJSON:"editDevice",deleteJSON:"deleteDevice",addJSON:"addDevice",items:[]}]}};for(var d=0;d<agent.server.objectList.length;d++){var c=
agent.server.objectList[d];if(2===c.typeID||0>=c.data.pairid){var e=""!==c.name?c.name:"object "+d;if(0<c.data.pairid){var g=agent.helpers.findObject(1,c.data.pairid);g&&(e+=' <span class="small">'+(""!==g.name?g.name:"mic "+d)+"</span>")}b.data.sections[0].items.push({index:d,text:a(c)+e})}}b=ko.mapping.fromJS(b);b.generator=editing.editDevices;editing.renderObjects.push(b);editing.helpers.renderPage()},onvif:{discover:function(){var a=editing.currentRenderObject(),b=ko.toJS(a.data),d=agent.helpers.findID(b,
"bindto","settings.onvifident")[0].value,c=agent.helpers.findID(b,"bindto","settings.login")[0].value,e=agent.helpers.findID(b,"bindto","settings.password")[0].value,g=agent.helpers.findID(b,"bindto","settings.onvif.rtspport")[0].value;b=agent.helpers.findID(b,"bindto","settings.onvif.timeout")[0].value;var f=agent.helpers.translate;editing.helpers.setStatus(f("Loading"),3E4);$("#ddlOnvifURLs").empty();cmd="onvifdiscover&un="+encodeURIComponent(c)+"&pwd="+encodeURIComponent(e)+"&port="+g+"&timeout="+
b+"&surl="+encodeURIComponent(d);$("#btnOnvifDiscover").attr("disabled","disabled");comms.api.command(a.agentObject,cmd,function(m,l){$("#btnOnvifDiscover").removeAttr("disabled");var q=agent.helpers.translate;if(l.error)editing.helpers.setStatus(q("Error")+": "+l.error);else{var r=$("#ddlOnvifURLs");r.empty();0<l.list.length&&($.each(l.list,function(w,F){r.append($("<option>",{value:F.value,text:F.text}))}),r.val(l.list[0].value).change());editing.helpers.setStatus(q("OptionsFound")+": "+l.list.length)}},
function(){$("#btnOnvifDiscover").removeAttr("disabled")})}},nest:{discover:function(){var a=editing.currentRenderObject(),b=ko.toJS(a.data);b=agent.helpers.findID(b,"bindto","settings.nestident")[0].value;var d=agent.helpers.translate;editing.helpers.setStatus(d("Loading",6E3));$("#ddlNestURLs").empty();cmd="nestdiscover&url="+encodeURIComponent(b);comms.api.command(a.agentObject,cmd,function(c,e){var g=agent.helpers.translate;if(e.error)editing.helpers.setStatus(g("Error")+": "+e.error);else{var f=
$("#ddlNestURLs");f.empty();0<e.list.length&&($.each(e.list,function(m,l){f.append($("<option>",{value:l.uri,text:l.uri}))}),f.val(e.list[0].uri).change());editing.helpers.setStatus(g("OptionsFound")+": "+e.list.length)}},function(){})}},cameraList:[],presets:{show:function(a){comms.api.command(a,"getptzcommands&ptzid="+a.data.ptzid,function(b,d){var c=agent.helpers.translate;c={page:"presets",newPreset:"",isOnvif:d.isOnvif,data:{header:c("Presets"),okResult:"",items:[]}};c.data.items=d.elements;
c=ko.mapping.fromJS(c);editing.renderObjects.push(c);editing.helpers.renderPage("sm")})},click:function(a,b,d){switch(d.currentTarget.attributes.cmd.value){case "delPreset":comms.api.command(agent.currentObject,"ptzpresetdelete&value="+encodeURI(b.value()),function(){editing.renderObjects.pop();editing.presets.show(agent.currentObject)});break;case "goPreset":comms.api.command(agent.currentObject,"ptzcommand&field=ptz&value="+encodeURI(b.value()),function(c,e){var g=agent.helpers.translate;editing.helpers.setStatus(g("OK"))})}},
add:function(a,b){var d=a.newPreset();""===d&&(d="None");comms.api.command(agent.currentObject,"ptzpresetcreate&name="+encodeURI(d),function(){editing.renderObjects.pop();editing.presets.show(agent.currentObject)})}},ui:{close:function(){editing.ui.teardown()},ok:function(){var a=editing.currentRenderObject();editing.validate=a.origData&&a.origData.data.validate;a.suppressClose||editing.validate||editing.ui.teardown();var b=agent.helpers.translate,d=ko.toJS(a.data),c,e=agent.helpers.findID(d,"type",
"Time");for(c=0;c<e.length;c++){var g=e[c].value.replace("--","0").split(":");g=60*parseInt(g[0])+parseInt(g[1]);e[c].value=g}switch(a.page()){case "edit_view":d=ko.toJS(a);a=agent.server.views[d.viewIndex];a.objects||(a.objects=[]);for(b=b=0;b<a.objects.length;b++)for(c=a.objects[b],e=0;e<d.objects.length;e++)if(g=d.objects[e],g.oid===c.oid&&g.ot===c.ot&&!g.inView){a.objects.splice(b,1);b--;break}for(b=0;b<d.objects.length;b++)if(c=d.objects[b],c.inView){var f=!1;for(e=0;e<a.objects.length;e++)if(g=
a.objects[e],g.oid===c.oid&&g.ot===c.ot){f=!0;break}f||a.objects.push({oid:c.oid,ot:c.ot})}a.mode=d.mode;a.name=d.viewName;agent.screens.live.saveViews();agent.screens.live.startview(d.viewIndex);break;case "render_simple":switch(d.okResult){case "confirm":a.confirmTarget.callback&&a.confirmTarget.callback(a.confirmTarget.obj,d);break;case "configureDevice":editing.newDevice.alerts=d.items[0].value;editing.newDevice.record=d.items[1].value;2<d.items.length&&(editing.newDevice.resize=d.items[2].value,
editing.newDevice.raw=d.items[3].value);a.confirmTarget.callback();break;case "setNotifications":account.setNotifications(a);break;case "setViewOptions":f=parseInt(d.items[d.items.length-1].value);isNaN(f)&&(f=0);agent.screens.live.cycleDelay=f;agent.storage.set("cycleDelay",f);agent.screens.live.resetCycle();break;case "updatePermission":account.permissions.update(d)}break;case "render":switch(d.okResult){case "copySections":f=d.sections[0].items[0].value;a=d.sections[0].items[2];c=[];for(b=0;b<
a.options.length;b++)a.options[b].value&&c.push(a.options[b].oid);e=[];a=d.sections[0].items[1];for(b=0;b<a.options.length;b++)editing.sectionList[b].value=a.options[b].value,a.options[b].value&&e.push(editing.sectionList[b].text);comms.api.saveJSON(agent.server,{name:"copysections",typeID:2,fromid:f,sections:e,cameras:c},editing.helpers.switchResult);break;case "uploadXML":2520>agent.server.versionNumeric&&editing.helpers.confirm(b("ConfirmLoadObjects"),function(){comms.api.saveJSON(agent.server,
{name:"setobjectsxml",xml:d.sections[0].items[0].value},editing.helpers.switchResult)});break;case "UpdateLocationList":f=[{text:"None",value:"-1",noTranslate:!0}];for(c=0;c<agent.server.locations.length;c++)f.push({text:agent.server.locations[c].name,value:c.toString(),noTranslate:!0});editing.currentRenderObject().data.sections()[0].items()[1].options(f);break;case "":break;case "savePermissions":account.permissions.save();break;case "filter":f=agent.search;b=d.sections[0].items;f.apply=b[0].value;
f.from=b[1].value;f.to=b[2].value;f.tags=b[3].value;f.activity=b[4].value;f.timelapse=b[5].value;f.apply&&agent.search.filter();break;case "UpdateTags":a.file.tags=d.sections[0].items[0].value;comms.api.command(f.parent,"savetags&fn="+encodeURI(f.filename)+"&tags="+encodeURI(f.tags),editing.helpers.switchResult);break;case "RunAccountForm":account.processAccountForm(a);break;case "UpdateAccount":account.update(a);break;case "AddServer":f=d.sections[0].items[1].value;""!==f&&(editing.helpers.setStatus(b("Loading")),
$.ajax({type:"POST",url:"/webservices/UserAdmin.asmx/ClaimSerialJSON",data:JSON.stringify({code:f.toUpperCase()}),contentType:"application/json; charset=utf-8",dataType:"json",success:function(m){var l=agent.helpers.translate;m=JSON.parse(m.d);null!==m.Error&&editing.helpers.setStatus(m.Error);"OK"===m.Result&&(editing.helpers.setStatus(l("Connecting")),window.setTimeout(agent.helpers.reinit,4E3),window.history.replaceState&&window.history.replaceState({},document.title,"/app/"))},failure:function(){var m=
agent.helpers.translate;editing.helpers.setStatus(m("LostConnection"))}}));break;case "EditLocation":case "AddLocation":f=editing.locations.editIndex;b=d.sections[0].items[0].value;a=d.sections[0].items[1].value;c={name:b,color:a};-1===f?agent.server.locations.push(c):agent.server.locations[f]=c;comms.api.command(agent.server,"editlocation&ind="+editing.locations.editIndex+"&name="+encodeURI(b)+"&color="+encodeURI(a),function(m,l){editing.renderObjects.pop();editing.locations.show()});break;case "EditProfile":case "AddProfile":f=
editing.profiles.editIndex;b=d.sections[0].items[0].value;c={name:b};-1===f?agent.server.profiles.push(c):agent.server.profiles[f]=c;comms.api.command(agent.server,"editprofile&ind="+editing.profiles.editIndex+"&name="+encodeURI(b),function(m,l){editing.renderObjects.pop();editing.profiles.show()});break;case "AuthoriseCloud":editing.helpers.setStatus(b("Authorizing"));comms.api.command(agent.server,"authorise&provider="+d.provider+"&code="+encodeURI(d.sections[0].items[0].value),function(m,l){var q=
l.message;""===l.message&&(q=l.error);editing.helpers.setStatus(q)});break;default:comms.api.saveJSON(a.agentObject,d,editing.helpers.switchResult)}break;case "select_device":if(f=a.deviceID(),f.oid)switch(c=a.section(),c){default:comms.api.command(a.agentObject,"copyfrom&section="+c+"&fot="+f.ot+"&fid="+f.oid,editing.helpers.switchResult);break;case "device":if(f=agent.helpers.findObject(f.ot,f.oid))editing.helpers.setStatus(b("Loading")),comms.api.command(f,"copydevice",function(m,l){editing.openDevice=
{ot:l.ot,id:l.oid}})}}},change:function(a,b){if(a.live&&a.live()&&!agent.suppressLiveUpdates){var d=ko.mapping.toJS(a);var c=editing.currentRenderObject().agentObject;var e="";editing.currentRenderObject().data.origin&&(e=editing.currentRenderObject().data.origin());comms.api.saveJSON(c,{name:"liveupdate",origin:e,sections:[{items:[d]}]})}if(a.command){d=a.command();e=b.currentTarget.value;c=editing.currentRenderObject();var g=ko.toJS(c.data);switch(d){case "editaction":var f=agent.helpers.findID(g,
"id","chkActive")[0].value;var m=agent.helpers.findID(g,"id","ddlMode")[0].value;d+="&active="+f+"&mode="+m+"&ident="+g.ident;break;case "toggleAlertList":switch(f=$("#ddlAlertActionList").parent().parent(),a.value()){case "9":case "10":f.show();break;default:f.hide()}}d+="&id="+encodeURIComponent(e);comms.api.command(c.agentObject,d,function(l,q){switch(q.task){case "bindActionView":editing.helpers.reloadSection(q,0);break;case "rendersourceeditor":editing.helpers.reloadSection(q,0)}})}if(a.action)switch(f=
a.action(),f){case "setStartPage":agent.storage.set("start",b.currentTarget.value);break;case "setThemeSize":agent.storage.set("large",a.value());agent.sizes=a.value()?agent.themes.sizes.large:agent.themes.sizes.standard;agent.server&&"Live"===agent.screen.name&&agent.screens.live.startview();agent.menuCanvas.lastDraw=0;break;case "changeLanguage":agent.storage.set("language",b.currentTarget.value);agent.helpers.language.load(b.currentTarget.value,function(){var l=editing.currentRenderObject();if(l&&
l.name)switch(l.name()){case "languageChoice":editing.ui.teardown(!0);break;case "loginChoice":editing.renderObjects.pop(),account.showLoginChoice()}});break;case "setToolTips":agent.storage.set("tooltips",a.value());agent.tooltips=a.value();break;case "setLabels":agent.storage.set("labels",a.value());agent.labels=a.value();break;case "setAutoHide":agent.storage.set("autohide",a.value());agent.menu.autoHide=a.value();agent.screen===agent.screens.live&&agent.screen.resize();break;case "setShortcutKeys":agent.storage.set("shortcutkeys",
a.value());agent.shortcutKeys=a.value();break;case "setFPSLimiter":agent.storage.set("fpslimiter",a.value()),agent.applyFPSLimiter=a.value()}},itemclick:function(a,b,d){var c=editing.currentRenderObject().agentObject,e=agent.helpers.translate;switch(d.currentTarget.attributes.cmd.value){case "download":a=b.filename();a.endsWith(".jpg")&&(a="grabs\\"+a);b={type:"download",ot:b.typeID(),oid:b.id(),filename:a};agent.helpers.downloadFile(b,$(d.currentTarget));break;case "edit":switch(a.editJSON()){case "editLocation":editing.locations.edit(b.index());
break;case "editDevice":editing.editObject(agent.server.objectList[b.index()]);break;case "editPermission":account.permissions.edit(b.index());break;case "editProfile":editing.profiles.edit(b.index());break;default:comms.api.command(c,a.editJSON()+"&ident="+b.value(),editing.helpers.render)}break;case "del":switch(a.deleteJSON()){case "deleteDevice":editing.helpers.confirm(e("DeleteDevice"),function(g){editing.deleteObject(g)},agent.server.objectList[b.index()]);break;case "deletePermission":account.permissions["delete"](b.index());
break;case "deleteLocation":editing.locations["delete"](b.index());break;case "deleteProfile":editing.profiles["delete"](b.index());break;default:comms.api.command(c,a.deleteJSON()+"&ident="+b.value(),editing.helpers.switchResult)}}},click:function(a,b){var d="",c;if(a.url&&""!==a.url())window.open(a.url());else{d=a.action?a.action():b.currentTarget.attributes.cmd.value;editing.elementClicked=b.currentTarget;if(c=editing.currentRenderObject())c=c.agentObject;var e=agent.helpers.translate;switch(d){case "downloadConfig":d=
{type:"download",filename:"agentDVR.xml"};agent.helpers.downloadFile(d);break;case "uploadConfig":$('<input type="file" accept=".xml,.ispy">').on("change",function(){var g=this.files[0];if(g){var f=new FileReader;f.onload=function(m){comms.api.saveJSON(agent.server,{name:"setobjectsxml",xml:m.target.result,filename:g.name},editing.helpers.switchResult)};f.readAsText(g)}}).trigger("click");break;case "claimServer":editing.ui.teardown(!0);editing.helpers.setStatus(e("Loading"),15E3);comms.api.command(c,
"claimserver",function(g,f){f.error?editing.helpers.setStatus(f.error):window.isLocal?location.href="https://www.ispyconnect.com/app/?code="+f.serial:agent.helpers.changeServer()});break;case "showLogin":account.showLogin(a.index());break;case "goServer":editing.ui.teardown();agent.helpers.processCommand("goServer",a.index());break;case "armProfile":editing.ui.teardown();comms.api.command(agent.server,"armprofile&ind="+a.index(),function(g,f){});break;case "reinit":editing.ui.teardown();agent.helpers.reinit();
break;case "addServer":editing.ui.teardown();editing.addServer();break;case "updateAgent":editing.updateAgent();break;case "installPlugin":editing.ui.teardown();c=agent.config.plugins[a.index()];editing.plugins.install(c);break;case "buyPlugin":editing.ui.teardown();c=agent.config.plugins[a.index()];editing.plugins.buy(c);break;case "scanDevice":d=ko.toJS(editing.currentRenderObject().data);wizard.scanDevice(d);break;case "scanNetwork":wizard.scanNetwork();break;case "wizNext":wizard.next();break;
case "runwizard":wizard.load();break;case "unsubscribe":account.subscriptions.unsubscribe();break;case "forceSubscribe":editing.ui.teardown();account.subscriptions.load();break;case "subscribe":if(window.isLocal){editing.goRemote();break}agent.config.subscribed?account.subscriptions.showCancel():account.subscriptions.load();break;case "chooseSubscription":account.subscriptions.purchase(a.index());break;case "purchaseCredits":account.smsCredits.load();break;case "recharge":account.smsCredits.purchase(a.index());
break;case "goTimeline":agent.helpers.changeScreen(agent.screens.timeline);editing.ui.teardown();break;case "goRecordings":agent.helpers.changeScreen(agent.screens.recordings);editing.ui.teardown();break;case "goPhotos":agent.helpers.changeScreen(agent.screens.photos);editing.ui.teardown();break;case "goVR":agent.helpers.changeScreen(agent.screens.vr);editing.ui.teardown();break;case "goLive":agent.helpers.changeScreen(agent.screens.live);editing.ui.teardown();break;case "notificationSettings":account.showNotificationSettings();
break;case "onvifdiscover":editing.onvif.discover();break;case "nestdiscover":editing.nest.discover();break;case "logout":account.signOut();break;case "reload":agent.helpers.reload();break;case "paymentHistory":account.paymentHistory.load();break;case "permissions":account.permissions.load();break;case "copyDevice":d={typeID:-1,page:"select_device",deviceID:-1,section:"device"};od=ko.mapping.fromJS(d);od.deviceList=function(){var g=[];g.push({obj:{oid:-1,ot:-1},name:e("SelectDevice")});for(var f=
0;f<agent.server.objectList.length;f++){var m=agent.server.objectList[f];m.hasPermission&&(2===m.typeID||0>=m.data.pairid)&&g.push({obj:{oid:m.id,ot:m.typeID},name:m.name})}return g};od.agentObject=c;editing.renderObjects.push(od);editing.helpers.renderPage();break;case "addVideo":editing.helpers.configureNewDevice(!1,function(){var g=editing.newDevice.alerts?1:0,f=editing.newDevice.record?1:0,m=editing.newDevice.resize?1:0,l=editing.newDevice.raw?1:0;editing.helpers.setStatus(e("Loading"));comms.api.command(agent.server,
"adddevice&ot=2&sourceTypeID=3&alerts="+g+"&record="+f+"&resize="+m+"&raw="+l,function(q,r){editing.openDevice={ot:2,id:r.ID}})});break;case "addVideoOnvif":editing.helpers.configureNewDevice(!1,function(){var g=editing.newDevice.alerts?1:0,f=editing.newDevice.record?1:0,m=editing.newDevice.resize?1:0,l=editing.newDevice.raw?1:0;editing.helpers.setStatus(e("Loading"));comms.api.command(agent.server,"adddevice&ot=2&sourceTypeID=9&alerts="+g+"&record="+f+"&resize="+m+"&raw="+l,function(q,r){editing.openDevice=
{ot:2,id:r.ID}})});break;case "addAudio":editing.helpers.configureNewDevice(!0,function(){var g=editing.newDevice.alerts?1:0,f=editing.newDevice.record?1:0;editing.helpers.setStatus(e("Loading"));comms.api.command(agent.server,"adddevice&ot=1&sourceTypeID=0&alerts="+g+"&record="+f,function(m,l){editing.openDevice={ot:1,id:l.ID}})});break;case "addWizard":editing.helpers.configureNewDevice(!1,function(){wizard.load()});break;case "setTheme":c=a.index();agent.themes.setTheme(c);break;case "goPlatform":switch(a.value()){case "iSpy":location.href=
"/monitor/?setPlatform=iSpy";break;case "Agent (original)":location.href="/monitor/?setPlatform=Agent"}break;case "remoteAccess":editing.goRemote();break;case "selectLanguage":account.showLanguageChoice();break;case "popConnect":editing.popConnect();break;case "changeTheme":editing.openThemes();break;case "changePlatform":editing.openPlatforms();break;case "changeStartPage":editing.openStartPage();break;case "editAccount":account.showEdit();break;case "editDevices":editing.editDevices();break;case "copySettings":editing.copySettings();
break;case "addDevice":editing.showAddDeviceMenu();break;case "backupRestore":editing.backupRestore();break;case "showProfiles":editing.profiles.show();break;case "executeCommand":editing.commands.executeCommand(a.index());break;case "editServer":editing.editObject(agent.server);break;case "changeServer":agent.helpers.changeServer();break;case "showCommands":editing.commands.show();break;case "downloadLogs":agent.helpers.downloadFile({type:"download",filename:"logs.json"},null);break;case "showPlugins":editing.plugins.show();
break;case "showview":agent.screens.live.startview(a.index());break;case "authorise":editing.cloud.authorise(a.parameter());break;case "authoriseyoutube":editing.cloud.authorise("youtube");break;case "updatexml":$(editing.elementClicked).prop("disabled",!0);agent.servicesConnected?comms.api.command(agent.server,d+"&type="+a.parameter(),function(g,f){}):editing.popConnect();break;case "downloadmodel":$(editing.elementClicked).prop("disabled",!0);agent.servicesConnected?comms.api.command(agent.server,
d,function(g,f){}):editing.popConnect();break;case "bool":a.value(!a.value());break;case "add":if(a.addJSON)switch(a.addJSON()){case "addDevice":editing.showAddDeviceMenu();break;case "addPermission":account.permissions.add();break;case "addLocation":editing.locations.add();break;case "addProfile":editing.profiles.add()}else comms.api.command(c,a.editJSON()+"&ident=new",editing.helpers.render);break;case "copy":d={typeID:c.typeID,page:"select_device",deviceID:-1,section:a.ident()};od=ko.mapping.fromJS(d);
od.deviceList=function(g){for(var f=[],m=0;m<agent.server.objectList.length;m++){var l=agent.server.objectList[m];!l.hasPermission||l.typeID!==g&&g||f.push({obj:{oid:l.id,ot:l.typeID},name:l.name})}return f};od.agentObject=c;editing.renderObjects.push(od);editing.helpers.renderPage();break;case "editmic":c=agent.helpers.findObject(1,c.data.pairid);null!==c?editing.editObject(c):editing.helpers.setStatus(e("SelectMicrophone"));break;case "editplugin":d=agent.helpers.findID(ko.toJS(editing.currentRenderObject().data),
"id","ddlPlugin")[0].value;editing.plugins.check(c,{name:d});break;case "editLocations":editing.locations.show();break;case "plugincommand":cmd=c.action+"&command="+c.command;comms.api.command(c,cmd,function(g,f){editing.helpers.setStatus(f.msg)});break;case "installPWA":agent.helpers.installPWA();break;default:comms.api.command(c,a.action(),editing.helpers.render)}}},teardown:function(a,b){a=void 0===a?!1:a;b=void 0===b?!0:b;for(var d=!0;d||a;){d=!1;var c=editing.renderObjects.pop();if(c){if(editing.ui.renderers&&
editing.ui.renderers.deinit(c),c.onclose)c.onclose()}else break}if(0<editing.renderObjects.length){d=editing.currentRenderObject();if(d.generator)return editing.renderObjects.pop(),d.generator(),c;editing.helpers.renderPage()}else editing.pageElement.modal("hide"),editing.hideShield(),agent.mainCanvas.focus();a&&b&&editing.helpers.closeSideBar();return c},renderers:{deinit:function(a){if(a&&a.renderers){for(var b=a.renderers,d=0;d<b.length;d++)b[d].deinit();delete a.renderers}}},setTab:function(a,
b){for(var d=editing.renderObjects[editing.renderObjects.length-1],c=d.data.sections().length,e=0;e<c;e++)d.data.sections()[e].tabActive(!1);a.tabActive(!0);d.currentSection(a.header());d.currentTab&&d.currentTab(a.name())},commands:{clearZones:function(a){var b="";a&&(b=$(a).attr("binding"));a=editing.currentRenderObject();for(var d=0;d<a.renderers.length;d++){var c=a.renderers[d];if("motionzones"===c.options.mode&&(""===b||c.options.bindto===b)){c.clear(!0);break}}},setNibSize:function(){var a=
editing.nibSize;switch(editing.nibSize){case "fa-sm":editing.nibSize="fa-md";break;case "fa-md":editing.nibSize="fa-lg";break;case "fa-lg":editing.nibSize="fa-sm"}$(".nibcontrol").addClass(editing.nibSize).removeClass(a)},toggleDetectorMode:function(){editing.detectorMode="detector"===editing.detectorMode?"live":"detector";var a="fa-toggle-on";"live"===editing.detectorMode&&(a="fa-toggle-off");$(".detectorcontrol").removeClass("fa-toggle-on").removeClass("fa-toggle-off").addClass(a)}}},commands:{show:function(){function a(){var b=
agent.helpers.translate;b={page:"render_simple",data:{header:b("Commands"),okResult:"",items:[]}};for(var d=0;d<agent.server.commands.length;d++){var c=agent.server.commands[d];b.data.items.push({index:d,value:""!==c.name?c.name:d,type:"Button",action:"executeCommand"})}b=ko.mapping.fromJS(b);editing.renderObjects.push(b);editing.helpers.renderPage()}agent.server.commands?a():comms.api.command(agent.server,"getcmdlist",function(b,d){b.commands=d.commands;a()})},executeCommand:function(a){var b=agent.server.commands[a];
comms.api.command(agent.server,"executecmd&id="+a,function(d,c){editing.helpers.setStatus(b.name+": "+c.status)})}},plugins:{install:function(a){account.plugins.check(a,function(){comms.api.loadJSON(agent.server,"installplugin",a,function(b,d){var c=agent.helpers.translate;editing.helpers.setStatus(c("AgentRestartPlugin"),6E3,null,!0);editing.helpers.closeModal()})})},buy:function(a){var b=agent.helpers.translate;editing.helpers.closeModal();editing.helpers.setStatus(b("Loading"));b=$("#pp_purchase").contents();
b.find("#amount").val(a.price);b.find("#notify_url").val(agent.config.URL.replace("http:","https:")+"/IPN.aspx?pluginid="+a.id);b.find("#item_name").val(a.name);b.find("#item_number").val(agent.config.accountDetails.id);b.find("#currency_code").val(agent.config.currency);b.find("#paypalForm").submit()},check:function(a,b){if(window.isLocal)comms.api.command(a,"editplugin",function(c,e){editing.helpers.setStatus("");editing.helpers.render(c,e)});else{var d=agent.helpers.translate;editing.helpers.setStatus(d("Loading"));
account.plugins.check(b,function(){comms.api.command(a,"editplugin",function(c,e){editing.helpers.setStatus("");editing.helpers.render(c,e)})})}},show:function(){if(window.isLocal)editing.goRemote();else{for(var a=agent.helpers.translate,b={page:"render",OKOnly:!0,data:{header:a("Plugins"),okResult:"",sections:[]}},d=0;d<agent.config.plugins.length;d++){var c=agent.config.plugins[d];0===d&&(b.currentSection=c.name);var e={header:a("PluginData."+c.name),displayType:"Form",tabActive:0===d,items:[],
index:d};e.items.push({type:"Header",text:a("PluginData."+c.name),help:a("PluginData."+c.name+"_desc")});e.items.push({text:"",type:"Button",value:a("Install"),action:"installPlugin",index:d});e.items.push({type:"Info",value:"v"+c.version});e.items.push({text:"",type:"Button",value:"$"+c.price+" - "+a("BuyNow"),index:d,action:"buyPlugin"});e.items.push({type:"Info",value:a("PluginTrial")});b.data.sections.push(e)}a=ko.mapping.fromJS(b);editing.renderObjects.push(a);editing.helpers.renderPage("sm")}}},
popConnect:function(){var a=agent.helpers.translate;a={page:"render_simple",OKOnly:!0,data:{header:a("ConnectAccount"),okResult:"",items:[{value:a("ConnectAccountHTML"),type:"Info"},{type:"Button",value:a("Connect"),action:"claimServer"}]}};a=ko.mapping.fromJS(a);editing.renderObjects.push(a);editing.helpers.renderPage()},popHTML:function(a,b){var d=ko.mapping.fromJS({page:"render_simple",OKOnly:!0,data:{header:a,okResult:"",items:[{value:b,type:"Info"}]}});editing.renderObjects.push(d);editing.helpers.renderPage("lg")},
goRemote:function(){var a=agent.helpers.translate;agent.servicesConnected?editing.helpers.confirm(a("UseWebPortal"),function(b){location.href="https://www.ispyconnect.com/app/"}):editing.popConnect()},openThemes:function(){for(var a=agent.helpers.translate,b={page:"render_simple",data:{header:a("Theme"),okResult:"",items:[]}},d=0;d<agent.themes.list.length;d++)b.data.items.push({index:d,value:agent.themes.list[d].name,type:"Button",action:"setTheme"});d={text:a("SetStartPage"),type:"Select",action:"setStartPage",
value:agent.storage.get("start","live"),options:[]};for(var c in agent.screens){var e=agent.screens[c];d.options.push({text:a(e.name),value:e.name})}b.data.items.push(d);c="true"===agent.storage.get("large");b.data.items.push({text:a("Large"),type:"Boolean",value:c,action:"setThemeSize"});c="true"===agent.storage.get("tooltips");b.data.items.push({text:a("ToolTips"),type:"Boolean",value:c,action:"setToolTips"});c="true"===agent.storage.get("labels");b.data.items.push({text:a("Labels"),type:"Boolean",
value:c,action:"setLabels"});c="true"===agent.storage.get("autohide");b.data.items.push({text:a("AutoHide"),type:"Boolean",value:c,action:"setAutoHide"});c="true"===agent.storage.get("shortcutkeys");b.data.items.push({text:a("ShortcutKeys"),type:"Boolean",value:c,action:"setShortcutKeys"});c="true"===agent.storage.get("fpslimiter");b.data.items.push({text:a("FPSLimiter"),type:"Boolean",value:c,action:"setFPSLimiter",help:a("FPSLimiter_help")});a=ko.mapping.fromJS(b);editing.renderObjects.push(a);
editing.helpers.renderPage()},openPlatforms:function(){if(window.isLocal)editing.goRemote();else{var a=agent.helpers.translate;a={page:"render_simple",data:{header:a("Platform"),okResult:"",items:[{value:"Agent (original)",type:"Button",action:"goPlatform"}]}};agent.isAndroidApp||agent.isIOSApp||a.data.items.push({value:"iSpy",type:"Button",action:"goPlatform"});a=ko.mapping.fromJS(a);editing.renderObjects.push(a);editing.helpers.renderPage()}},openViews:function(){for(var a=agent.helpers.translate,
b={page:"render_simple",OKOnly:!0,data:{header:a("SelectView"),okResult:"setViewOptions",items:[]}},d=0;d<agent.server.views.length;d++){var c=agent.server.views[d];b.data.items.push({index:d,value:""!==c.name?c.name:d,type:"Button",action:"showview"})}b.data.items.push({text:a("Cycle"),value:agent.screens.live.cycleDelay,type:"Int32",min:0,max:600,help:a("CycleHelp")});a=ko.mapping.fromJS(b);editing.renderObjects.push(a);editing.helpers.renderPage()},editView:function(a){var b=agent.server.views[a];
a={mode:b.mode,name:"editView",viewName:b.name?b.name:a,page:"edit_view",viewIndex:a};b=b.objects;for(var d=[],c=0;c<agent.server.objectList.length;c++){var e=agent.server.objectList[c];if(e.hasPermission){for(var g={oid:e.id,ot:e.typeID,inView:!1,name:e.name},f=0;f<b.length;f++)if(b[f].oid===e.id&&b[f].ot===e.typeID){g.inView=!0;break}d.push(g)}}a.objects=d;a=ko.mapping.fromJS(a);a.generator=function(){editing.editView(agent.viewIndex)};a.toggle=function(m){m.inView(!m.inView())};a.canEdit=!0;if(b=
agent.server.Permissions)a.canEdit=!b.readOnly;editing.renderObjects.push(a);editing.helpers.renderPage()},showAddDeviceMenu:function(){var a=agent.helpers.translate,b={page:"render_simple",name:"addDevice",OKOnly:!0,data:{header:a("AddDevice"),okResult:"",items:[]}};b.data.items.push({value:editing.helpers.buttonIcon2("fa-magic",a("IPWizard")),type:"ButtonIcon",action:"addWizard"});b.data.items.push({value:editing.helpers.buttonIcon2("fa-opera","ONVIF"),type:"ButtonIcon",action:"addVideoOnvif"});
b.data.items.push({value:editing.helpers.buttonIcon2("fa-video-camera",a("VideoSource")),type:"ButtonIcon",action:"addVideo"});b.data.items.push({value:editing.helpers.buttonIcon2("fa-microphone",a("AudioSource")),type:"ButtonIcon",action:"addAudio"});agent.server&&2810<agent.server.versionNumeric&&b.data.items.push({value:editing.helpers.buttonIcon2("fa-files-o",a("CopyDevice")),type:"ButtonIcon",action:"copyDevice"});a=ko.mapping.fromJS(b);editing.renderObjects.push(a);editing.helpers.renderPage()},
showServerMenu:function(a){var b=agent.helpers.translate,d={page:"render_simple",isMenu:!0,OKOnly:!0,data:{header:a.name,okResult:"",version:"v"+a.version,items:[]}},c=!0;a.isAccess&&a.Permissions&&(c=!c.readOnly);c?(a.stats&&(d.data.subHeader="-"!==a.stats.cpu?"CPU: "+a.stats.cpu+" RAM: "+a.stats.ram+" Drive: "+a.stats.disk:"Drive: "+a.stats.disk),c=[],c.push({value:b("Devices"),type:"Header"}),c.push({value:editing.helpers.buttonIcon2("fa-plus",b("AddDevice")),type:"ButtonIcon",action:"addDevice"}),
c.push({value:editing.helpers.buttonIcon2("fa-edit",b("EditDevices")),type:"ButtonIcon",action:"editDevices"}),agent.server&&2810<agent.server.versionNumeric&&c.push({value:editing.helpers.buttonIcon2("fa-files-o",b("CopySettings")),type:"ButtonIcon",action:"copySettings"}),agent.server&&2330<agent.server.versionNumeric&&!agent.isIOS&&!agent.isIOSApp&&c.push({value:editing.helpers.buttonIcon2("fa-save",b("BackupRestore")),type:"ButtonIcon",action:"backupRestore"}),c.push({value:b("Configuration"),
type:"Header"}),c.push({value:editing.helpers.buttonIcon2("fa-cogs",b("Settings")),type:"ButtonIcon",action:"editServer"}),agent.server&&2590<agent.server.versionNumeric&&c.push({value:editing.helpers.buttonIcon2("fa-bookmark",b("Profiles")),type:"ButtonIcon",action:"showProfiles"}),a.supportsPlugins&&c.push({value:editing.helpers.buttonIcon2("fa-puzzle-piece",b("Plugins")),type:"ButtonIcon",action:"showPlugins"}),c.push({value:b("Integration"),type:"Header"}),c.push({value:editing.helpers.buttonIcon2("fa-terminal",
b("Commands")),type:"ButtonIcon",action:"showCommands"}),agent.servicesConnected?(c.push({value:editing.helpers.buttonIcon2("fa-external-link","IFTTT"),type:"ButtonIcon",url:"https://ifttt.com/ispy_agent/"}),c.push({value:editing.helpers.buttonIcon2("fa-external-link","Home Assistant"),type:"ButtonIcon",url:"https://www.home-assistant.io/integrations/agent_dvr/"})):(c.push({value:editing.helpers.buttonIcon2("fa-external-link","IFTTT"),type:"ButtonIcon",action:"popConnect"}),c.push({value:editing.helpers.buttonIcon2("fa-external-link",
"Home Assistant"),type:"ButtonIcon",action:"popConnect"})),a.isAccess||(c.push({value:b("System"),type:"Header"}),agent.server&&2470<agent.server.versionNumeric&&c.push({value:editing.helpers.buttonIcon2("fa-download",b("Logs")),type:"ButtonIcon",action:"downloadLogs"}),agent.server.updateAvailable&&agent.server.canUpdate&&c.push({value:editing.helpers.buttonIcon2("fa-download",b("UpdateAvailable")),type:"ButtonIcon",action:"updateAgent"}),window.isLocal&&c.push({value:editing.helpers.buttonIcon2("fa-plug",
b("RemoteAccess")),type:"ButtonIcon",action:"remoteAccess"})),d.data.items=c):d.data.items.push({value:b("AccessDenied"),type:"HTML"});a=ko.mapping.fromJS(d);editing.renderObjects.push(a);editing.helpers.renderPage()},popServers:function(){var a=agent.helpers.translate,b={page:"render_simple",name:"server_menu",cancelOnly:!0,data:{header:a("SelectServer"),okResult:"",items:[]}},d;for(d=0;d<agent.config.connectedServers.length;d++)b.data.items.push({value:agent.config.connectedServers[d].name,type:"Button",
action:"goServer",index:d});0<d&&b.data.items.push({type:"HR"});b.data.items.push({value:a("Reload"),type:"Button",action:"reinit"});b.data.items.push({value:a("ChangePlatform"),type:"Button",action:"changePlatform"});b.data.items.push({value:a("AddServer"),type:"Button",action:"addServer"});a=ko.mapping.fromJS(b);editing.renderObjects.push(a);editing.helpers.renderPage()},showScreenMenu:function(){var a=agent.helpers.translate,b={page:"render_simple",cancelOnly:!0,data:{header:a("Display"),okResult:"",
items:[]}},d;for(d in agent.screens){var c=agent.screens[d],e=a(c.name);b.data.items.push({value:editing.helpers.buttonIcon2(c.iconName,e),type:"ButtonIcon",action:c.action})}a=ko.mapping.fromJS(b);editing.renderObjects.push(a);editing.helpers.renderPage()},showAlerts:function(a){comms.api.command(agent.server,"getalerts",function(b,d){var c=agent.helpers.translate;c={page:"render_simple",OKOnly:!0,data:{header:c("Alerts"),okResult:"",items:[]}};for(var e="",g,f,m,l=0;l<d.alerts.length;l++){var q=
d.alerts[l],r=agent.helpers.findObject(q.ot,q.oid);if(null!==r){var w=new Date;m=(parseInt(q.time)-621355968E9)/1E4;w.setTime(m);g="warning";f="Alert";switch(q.reason){case "tagdetected":g="tag";f="Tag Detected";break;case "manualalert":g="hand-stop-o",f="Manual Alert"}e+='<button type="button" class="btn '+(q.read?"btn-secondary":"btn-danger")+' text-left" onclick="editing.helpers.focusTimeline(this,'+m+",'"+q.id+'\')"><span style="float:right" class="fa fa-'+g+' fa-2x" title="'+f+'"></span>'+r.name+
"<div><small>"+w.formatDate(agent.timeFormat)+"</small></div></button>"}}c.data.items.push({value:'<span style="position:absolute;right:20px;top:-65px"><button type="button" class="btn btn-primary btn-sm" onclick="editing.clearAlerts() " title="Clear"><i class="fa fa-trash-o fa-lg"> </i></button></span><div class="scrollDiv"><div class="list-group">'+(e+"</div></div>"),type:"Info",action:""});editing.helpers.renderWithSidebar(c,"alerts",a)})},clearAlerts:function(){comms.api.command(agent.server,
"clearalerts",function(){editing.ui.teardown(!0)})},showArmMenu:function(){var a=agent.helpers.translate;a={page:"render_simple",cancelOnly:!0,data:{header:a("ArmSystem"),okResult:"",items:[{value:a("Current"),type:"Button",action:"armProfile",index:-1}]}};for(var b=0;b<agent.server.profiles.length;b++){var d=agent.server.profiles[b];a.data.items.push({value:""!==d.name?d.name:b,type:"Button",action:"armProfile",index:b})}a=ko.mapping.fromJS(a);editing.renderObjects.push(a);editing.helpers.renderPage()},
showFilter:function(){var a=agent.helpers.translate;a={page:"render",data:{header:a("Filter"),okResult:"filter",sections:[{header:a("Filter"),displayType:"Form",tabActive:!0,items:[{text:a("Filter"),value:agent.search.apply,type:"Boolean"},{text:a("From"),value:agent.search.from,type:"DateTime",id:"dtpFrom"},{text:a("To"),value:agent.search.to,type:"DateTime",id:"dtpTo"},{text:a("Tags"),value:agent.search.tags,type:"String"},{text:a("Activity"),value:agent.search.activity,type:"Slider",range:!0,min:0,
max:100},{text:a("Timelapse"),value:agent.search.timelapse,type:"Boolean"}]}]},idise:function(b){return"#"+b()}};a=ko.mapping.fromJS(a);editing.renderObjects.push(a);editing.helpers.renderPage("md")},helpers:{closeSideBar:function(){var a=$("#sidebar");a&&a.hasClass("active")&&(a.removeClass("active"),window.setTimeout(agent.helpers.resize,500));editing.sidebar=null;agent.updateAlerts&&(window.clearTimeout(agent.updateAlerts),agent.updateAlerts=null)},menuise:function(a){for(var b=[],d={},c=0;c<a.length;c++){var e=
a[c];"Header"===e.type?(d=e,d.subItems=[],b.push(d)):d.subItems.push(e)}return b},focusTimeline:function(a,b,d){agent.screen!==agent.screens.timeline&&agent.helpers.changeScreen(agent.screens.timeline);agent.screens.timeline.FocusTime(b);$(a).hasClass("btn-danger")&&($(a).removeClass("btn-danger").addClass("btn-secondary"),comms.api.command(agent.server,"markasread&id="+d,function(){}))},buttonIcon:function(a){return'<i class="fa '+a+' fa-md pull-right mt-1" aria-hidden="true"></i>'},buttonIcon2:function(a,
b){return'<i class="fa '+a+' fa-2x fa-fw mr-2" style="vertical-align: middle" aria-hidden="true"></i>'+b},configureNewDevice:function(a,b){wizard.editObject=null;var d=agent.helpers.translate,c={page:"render_simple",data:{header:d("Configure"),okResult:"configureDevice",items:[{text:d("Alerts"),value:editing.newDevice.alerts,type:"Boolean",help:d("AlertsHelp")},{text:d("RecordOnDetect"),value:editing.newDevice.record,type:"Boolean",help:d("RecordOnDetectHelp")}]}};a||(c.data.items.push({text:d("Resize"),
value:editing.newDevice.resize,type:"Boolean",help:d("ResizeHelp")}),c.data.items.push({text:d("RecordRaw"),value:editing.newDevice.raw,type:"Boolean",help:d("RecordRawHelp")}));d=ko.mapping.fromJS(c);d.confirmTarget={callback:b,obj:null};editing.renderObjects.push(d);editing.helpers.renderPage()},confirm:function(a,b,d,c,e){e=void 0===e?"":e;var g=agent.helpers.translate;a={page:"render_simple",OKOnly:void 0===c?!1:c,data:{header:""===e?g("Confirm"):g(e),okResult:"confirm",items:[{type:"Info",value:a}]}};
a=ko.mapping.fromJS(a);a.confirmTarget={callback:b,obj:d};editing.renderObjects.push(a);editing.helpers.renderPage()},setTextOption:function(a,b){$("#"+b).val(a).change()},setStatus:function(a,b,d,c){if(c||!editing.importantSnackbar)b||(b=6E3),editing.statusTimeout&&window.clearTimeout(editing.statusTimeout),""===a?editing.snackbarElement.removeClass("show"):(editing.importantSnackbar=!0===c,editing.snackbarElement.addClass("show"),d?(editing.snackbarElement.off(),editing.importantSnackbar=!1,editing.snackbarElement.on("click",
d)):editing.snackbarElement.off(),editing.snackbarElement.html(a),editing.statusTimeout=window.setTimeout(function(){editing.snackbarElement.removeClass("show");editing.importantSnackbar=!1},b))},canCopy:function(a){return a.hasCopy&&a.hasCopy()},canAdd:function(a){return a.canAdd?a.canAdd():!0},canDelete:function(a){return a.canDelete?a.canDelete():!0},OKOnly:function(a){return a.OKOnly?a.OKOnly():!1},CancelOnly:function(a){return a.cancelOnly?a.cancelOnly():!1},FullOptions:function(a){return!editing.helpers.OKOnly(a)&&
!editing.helpers.CancelOnly(a)},HideFooter:function(a){return a.hideFooter?a.hideFooter():!1},closeModal:function(){for(;0<editing.renderObjects.length;){var a=editing.renderObjects.pop();editing.ui.renderers&&editing.ui.renderers.deinit(a)}editing.pageElement.modal("hide");editing.hideShield();agent.mainCanvas.focus()},getPage:function(a){for(var b=0;b<editing.pages.length;b++){var d=editing.pages[b];if(d.name===a)return d.html}return null},loadHTML:function(){function a(d){$.get(editing.pages[d].url+
"?v="+boot.version,function(c){editing.pages[d].html=c})}for(var b=0;b<editing.pages.length;b++)a(b)},filterPlatform:function(a){return!0},bigType:function(a){switch(a){case "MultiSelect":case "ZoneManager":case "ScreenAreaManager":case "DesktopAreaManager":case "LineManager":case "SpectrumAnalyser":case "DetectorViewManager":case "PiPManager":case "VolumeLevel":case "TextArea":case "PlaceHolder":case "HTML":return!0}return!1},renderStaticControls:function(){$(".volumeLevel").each(function(){var a=
editing.currentRenderObject();this.renderEngine=new editing.LevelRenderer(this,a.agentObject,a)});$(".typeahead-ctrl-basic").each(function(){var a=this.attributes.values.value.split(",");$(this).typeahead({source:a})})},switchResult:function(a,b){switch(b.actionResult){case "reload":agent.helpers.reload();break;case "reloadSchedule":comms.api.command(a,"showschedule",editing.helpers.loadContent);break;case "reloadActions":comms.api.command(a,"showactions",editing.helpers.loadContent);break;case "reloadPTZSchedule":comms.api.command(a,
"showptzschedule",editing.helpers.loadContent);break;case "reloadFTPServers":comms.api.command(a,"getSettings",function(d,c){for(var e=0;e<c.sections.length;e++)if("FTPServers"===c.sections[e].ident){editing.helpers.reloadSection(c,e);break}});break;case "reloadStorage":comms.api.command(a,"getSettings",function(d,c){for(var e=0;e<c.sections.length;e++)if("Storage"===c.sections[e].ident){editing.helpers.reloadSection(c,e);break}});break;case "setpairid":a.data.pairid=b.id;break;case "error":editing.helpers.setStatus(b.message);
return}editing.validate&&editing.ui.teardown()},reloadSection:function(a,b){var d=editing.renderObjects.pop(),c=ko.toJS(d.data);c.sections[b]=a.sections[b];c.sections[b].tabActive=!0;d.data=ko.mapping.fromJS(c);editing.renderObjects.push(d);editing.helpers.renderPage()},loadContent:function(a,b){var d=editing.renderObjects.pop();d.data=ko.mapping.fromJS(b);editing.renderObjects.push(d);editing.helpers.renderPage()},render:function(a,b){function d(m,l,q){var r=[],w;for(w in m)m.hasOwnProperty(w)&&
("object"===typeof m[w]?r=r.concat(d(m[w],l,q)):w===l&&m[l]===q&&r.push(m));return r}if(b.error)editing.helpers.setStatus(b.error);else{var c=editing.currentRenderObject();c&&editing.ui.renderers.deinit(c);2===a.typeID&&(c=d(b,"id","ptzModelList"),0<c.length&&(c[0].options=agent.server.API.ptzmodels));var e=d(b,"type","Time");for(c=0;c<e.length;c++){var g=e[c].value,f=Math.floor(g/60);g-=60*f;10>g&&(g="0"+g);10>f&&(f="0"+f);e[c].value=f+":"+g}e={currentSection:b.sections[0].header,data:b,type:a.typeID,
id:a.id,page:"render"};if("EditCamera"===b.name||"EditMicrophone"===b.name)b.header=a.id+": "+a.name;for(c=0;c<e.data.sections.length;c++)f=e.data.sections[c],f.tabActive=0===c,void 0===f.available||f.available||(e.data.sections.splice(c,1),c--);c=ko.mapping.fromJS(e);c.deviceList=function(m){for(var l=[],q=0;q<agent.server.objectList.length;q++){var r=agent.server.objectList[q];!r.hasPermission||r.typeID!==m&&m||l.push({oid:r.id,name:r.name,ot:r.typeID})}return l};c.origData=e;c.agentObject=a;editing.renderObjects.push(c);
editing.helpers.renderPage()}},renderWithSidebar:function(a,b,d){var c=$("#sidebar"),e=!1;if(c&&c.hasClass("active")&&(e=!0,b===editing.sidebar&&!d)){c.removeClass("active");editing.sidebar=null;window.setTimeout(agent.helpers.resize,500);return}!c||$(window).width()<=agent.minWindowWidthForSidebar?(a=ko.mapping.fromJS(a),editing.renderObjects.push(a),editing.helpers.renderPage()):(editing.sidebar=b,a.page="render_sidebar",a.isMenu?a.data.items=editing.helpers.menuise(a.data.items):a.isMenu=!1,a=
ko.mapping.fromJS(a),a.translate=function(g){return agent.helpers.translate(g)},b=editing.helpers.getPage(a.page()),c.addClass("active"),c.html(b),ko.cleanNode(c[0]),ko.applyBindings(a,c[0]),e||window.setTimeout(agent.helpers.resize,500))},renderPage:function(a){var b=editing.currentRenderObject();!a&&b.sz&&(a=b.sz);b.renderers=[];b.translate=function(c){return agent.helpers.translate(c)};b.makeList||(b.makeList=function(c,e){var g="",f=agent.helpers.translate;c=c();jQuery.isArray(c)||(c=c.split(","));
for(var m=0;m<c.length;m++)""!==c[m]&&"None"!==c[m]&&(g+='<tr><td class="wordbreak">'+agent.helpers.shorten(c[m],30)+'</td><td><button type="button" class="btn btn-secondary btn-sm" onclick="editing.helpers.setTextOption(\''+c[m]+"','"+e()+"')\">"+f("Use")+"</button></td></tr>");""!==g&&(g='<table class="table table-bordered table-striped agentTable"><tbody>'+g+"</tbody></table>");return g});var d=editing.helpers.getPage(b.page());if(a)switch(b.page()){case "render_simple":d=d.replace("modal-sm",
" modal-"+a);break;default:d=d.replace("modal-lg"," modal-"+a)}a=editing.pageElement;a.html(d);ko.cleanNode(a[0]);ko.applyBindings(b,a[0]);editing.helpers.renderStaticControls();editing.elementClicked=null;editing.pageElement.modal("show");editing.showShield();0<$("#ddlScheduleAction").length&&$("#ddlScheduleAction").trigger("change")}},cloud:{authorise:function(a){if(agent.servicesConnected){var b=encodeURI(agent.config.URL+"/responsecode.aspx"),d=agent.helpers.translate;d={page:"render",data:{header:d("Authorize"),
okResult:"AuthoriseCloud",name:"AuthoriseCloud",provider:a,sections:[{header:d("Code"),displayType:"Form",tabActive:!0,items:[{text:d("Code"),value:"",type:"String"}]}]}};d=ko.mapping.fromJS(d);editing.renderObjects.push(d);editing.helpers.renderPage("sm");switch(a){case "drive":window.open("https://accounts.google.com/o/oauth2/v2/auth?scope=https://www.googleapis.com/auth/drive&redirect_uri=urn:ietf:wg:oauth:2.0:oob&response_type=code&client_id=648753488389.apps.googleusercontent.com&access_type=offline");
break;case "youtube":window.open("https://accounts.google.com/o/oauth2/v2/auth?scope=https://www.googleapis.com/auth/youtube&redirect_uri=urn:ietf:wg:oauth:2.0:oob&response_type=code&client_id=648753488389.apps.googleusercontent.com&access_type=offline");break;case "dropbox":window.open("https://www.dropbox.com/oauth2/authorize?client_id=6k40bpqlz573mqt&response_type=code&redirect_uri="+b);break;case "onedrive":window.open("https://login.live.com/oauth20_authorize.srf?client_id=000000004C193719&scope=wl.offline_access wl.skydrive_update&response_type=code&redirect_uri="+
b);break;case "onedrivebusiness":window.open("https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=1e863e71-7702-4296-9b80-463d5d8b083a&response_type=code&redirect_uri="+b+"&response_mode=query&scope=offline_access%20files.readwrite.all");break;case "box":window.open("https://account.box.com/api/oauth2/authorize?client_id=0uvr6c6kvl60p7725i62v9ua4k6bclpj&box_login="+encodeURI(agent.config.email)+"&response_type=code&state="+Math.random()+"&redirect_uri="+b);break;case "vision":window.open("https://cloud.google.com/vision/docs/auth")}}else editing.popConnect()}},
LevelRenderer:function(a,b,d){function c(){if(w){if($(g).is(":visible")){var H=$(g).parent().width();f!==H&&(f=H,$(g).width(H));l.canvas.width=f;l.canvas.height=m;l.clearRect(-1,-1,l.canvas.width+2,l.canvas.height+2);H=r.value[0]/100*f;var K=r.value[1]/100*f;l.fillStyle="rgba(255,255,255,0.7)";l.fillRect(0,0,f,m);var B=Math.min(f,f*q);l.fillStyle=B<H||B>K?"rgba(67,168,235,0.8)":"rgba(233,69,94,0.8)";l.fillRect(0,5,B,m-10);l.stroke();l.beginPath();l.strokeStyle="rgba(20,20,20,1)";l.moveTo(H,4);l.lineTo(H,
m-4);l.moveTo(K,4);l.lineTo(K,m-4);l.closePath();l.stroke()}window.requestAnimationFrame(c)}}function e(){$(g).is(":visible")&&comms.api.command(b,"querylevel",function(H,K){q=K.level})}var g=a,f=g.width,m=g.height,l=g.getContext("2d"),q=0,r=null,w=!0,F=null;this.deinit=function(){window.clearInterval(F);w=!1};this.init=function(){w=!0;r=agent.helpers.findID(d.origData,"id","arrSensitivity")[0];F=window.setInterval(e,100);c()};l.translate(.5,.5);this.init()},ZoneRenderer:function(a,b,d,c){function e(h,
k){p.fillStyle=k;var n=h.x/100*v,z=h.y/100*t,E=h.w/100*v,G=h.h/100*t;p.fillRect(n,z,E,G);p.beginPath();p.rect(n,z,E,G);p.closePath();p.stroke();L.push({x:n,y:z,x2:n+E,y2:z+G,obj:h});if("pip"===b.mode)for(var C=d.parent.objectList,M=0;M<C.length;M++)if(C[M].id===h.id&&2===C[M].typeID){p.fillStyle="#fff";p.fillText(C[M].name,n+2,z+10);break}h===u&&(n+=E,z+=G,p.beginPath(),p.moveTo(n-20,z-5),p.lineTo(n-5,z-5),p.lineTo(n-5,z-20),p.closePath(),p.stroke())}function g(){if(U){if($(B).is(":visible")){if(b.autosize){var h=
b.height/b.width,k=Math.min(.95*$(B).parent().width(),640);k=parseInt(Math.max(320,k));h=parseInt(k*h);if(v!==k||t!==h)v=k,t=h,$(B).width(k),$(B).height(h)}p.canvas.width=v;p.canvas.height=t;L=[];D.current&&p.drawImage(D.current,0,0,v,t);p.strokeStyle="rgba(0,0,0,1)";switch(b.mode){case "motionzones":if(S){null===O&&(O=$("<canvas/>",{height:t,width:v}));O[0].width=v;O[0].height=t;k=O[0].getContext("2d");k.clearRect(0,0,v,t);var n=b.motionArr.length;k.fillStyle="rgba(38,201,255,0.4)";h=v/n;n=t/(3*
n/4);for(x=0;x<b.motionArr.length;x++)for(y=0;y<b.motionArr[0].length;y++)1===b.motionArr[x][y]&&k.rect(x*h,y*n,h,n);k.fill();S=!1}p.drawImage(O[0],0,0,v,t);N&&m();break;case "spectrum":if(k=K.spectrum){h=v/k.length;n=t/100;p.fillStyle="rgba(38,201,255,0.7)";for(var z=0;z<k.length;z++){var E=k[z]*n;p.fillRect(z*h,t/2-E/2,h-1,E)}p.stroke()}break;case "detector":R&&f();N&&m();break;case "line":R&&f();for(k=0;k<b.data.length;k++){h=b.data[k];p.beginPath();p.strokeStyle="rgba(255,0,0,1)";n=h.x/100*v;
z=h.y/100*t;E=h.x2/100*v;var G=h.y2/100*t;p.moveTo(n,z);p.lineTo(E,G);p.closePath();p.stroke();var C=agent.touchClickRadius;L.push({x:n-C,y:z-C,x2:n+C,y2:z+C,obj:{line:h,p:1}});L.push({x:E-C,y:G-C,x2:E+C,y2:G+C,obj:{line:h,p:2}})}null!==V&&(p.fillStyle="rgba(255,0,0,0.5)",k=V,h=k.line.x,n=k.line.y,2===k.p&&(h=k.line.x2,n=k.line.y2),h=h/100*v,n=n/100*t,p.fillRect(h-5,n-5,10,10));break;default:for(k=0;k<b.data.length;k++)h=b.data[k],h!==u&&e(h,"rgba(255,255,255,0.5)");null!==u&&(k="rgba(67,168,235,0.8)",
P&&!Q&&(0>A.x||A.x>v||0>A.y||A.y>t)&&(k="rgba(233,69,94,0.8)"),e(u,k))}}window.requestAnimationFrame(g)}}function f(){var h={w:R.value[1]/100*v,h:W.value[1]/100*t},k={w:R.value[0]/100*v,h:W.value[0]/100*t},n=(new Date).getTime();p.limits||(p.limits={max:h,min:k,ts:n});if(p.limits.max.w!==h.w||p.limits.max.h!==h.h||p.limits.min.w!==k.w||p.limits.min.h!==k.h)p.limits={max:h,min:k,ts:n+4E3};if(!(p.limits.ts<=n)){n=v/2-h.w/2;var z=t/2-h.h/2,E=h.w;h=h.h;var G=v/2-k.w/2,C=t/2-k.h/2,M=k.w;k=k.h;p.fillStyle=
"rgb(67,168,235,0.4)";p.beginPath();p.moveTo(n,z);p.lineTo(n,z+h);p.lineTo(n+E,z+h);p.lineTo(n+E,z);p.lineTo(n,z);p.rect(G,C,M,k);p.fill()}}function m(){var h=N.value[0],k=N.value[1];p.fillStyle="rgba(255,255,255,0.7)";p.fillRect(0,t-20,v,20);p.beginPath();p.strokeStyle="rgba(20,20,20,0.7)";h=h/100*v;k=k/100*v;p.moveTo(h,t-19);p.lineTo(h,t);p.moveTo(k,t-19);p.lineTo(k,t);p.closePath();p.stroke();var n=Math.min(v,v*X);p.fillStyle=n<h||n>k?"rgba(67,168,235,0.8)":"rgba(233,69,94,0.8)";p.fillRect(0,t-
15,n,10);p.stroke()}function l(h){A=agent.helpers.mouseXYRel(B,h);agent.helpers.setCursor(h,"pointer");var k;if(P)switch(b.mode){case "detectorview":case "spectrum":break;case "motionzones":var n=b.motionArr.length,z=Math.floor(A.x/(v/n),10),E=Math.floor(A.y/(t/(3*n/4)),10),G=2!==Y?1:0;if(0>z||z>=n||0>E||E>=b.motionArr[0].length)break;b.motionArr[z][E]=G;if("fa-sm"!==editing.nibSize){var C=2;"fa-lg"===editing.nibSize&&(C=4);for(h=z-C/2;h<z+C/2;h++)for(k=E-C/2;k<E+C/2;k++)0<=h&&h<n&&0<=k&&k<b.motionArr[0].length&&
(b.motionArr[h][k]=G)}S=!0;break;case "line":null!==I&&(h=A.x/v*100,k=A.y/t*100,1===I.p?(I.line.x=h,I.line.y=k):(I.line.x2=h,I.line.y2=k));break;default:null!==u&&(Q?(u.w=Math.max(5,A.x/v*100-u.x),u.h=Math.max(5,A.y/t*100-u.y),k=u.x+u.w,100<k&&(u.w-=k-100),k=u.y+u.h,100<k&&(u.h-=k-100),agent.helpers.setCursor(h,"nwse-resize")):(u.x=Math.min(100,Math.max(0,T.x-(J.x-A.x)/v*100)),u.y=Math.min(100,Math.max(0,T.y-(J.y-A.y)/t*100)),k=u.x+u.w,100<k&&(u.x-=k-100),k=u.y+u.h,100<k&&(u.y-=k-100)))}else for(h=
L.length-1;0<=h;h--)if(k=L[h],A.x>k.x&&A.y>k.y&&A.x<k.x2&&A.y<k.y2){"line"===b.mode&&(V=k.obj);break}}function q(h){P=!1;Y=h.button;if(h.target===B){h.preventDefault();J=agent.helpers.mouseXYRel(B,h);P=!0;switch(b.mode){case "motionzones":case "detectorview":case "spectrum":return}var k=!0;for(h=L.length-1;0<=h;h--){var n=L[h];if(J.x>n.x&&J.y>n.y&&J.x<n.x2&&J.y<n.y2){"line"===b.mode?I=n.obj:(u=n.obj,Q=15>agent.helpers.calcDist(J,{x:n.x2,y:n.y2}),T={x:u.x,y:u.y});k=!1;break}}if(k){h=Math.min(96,J.x/
v*100);k=Math.min(96,J.y/t*100);switch(b.mode){case "line":k={x:h,y:k,x2:h,y2:k};I={line:k,p:2};break;default:k={x:h,y:k,w:5,h:5};if("pip"===b.mode)for(k.id=parseInt($("#PiPDeviceList").val()),h=0;h<b.data.length;h++)if(b.data[h].id===k.id){b.data.splice(h,1);break}u=k}b.data.push(k);b.data.length>b.max&&b.data.splice(0,1);Q=!0}}}function r(h){P&&(A=agent.helpers.mouseXYRel(B,h),null!==u&&!Q&&(0>A.x||0>A.y||A.x>v||A.y>t)&&(b.data.splice(b.data.indexOf(u),1),u=null),null!==I&&(0>A.x||0>A.y||A.x>v||
A.y>t)&&(b.data.splice(b.data.indexOf(I.line),1),I=null),F());P=!1;T=J=null;Q=!1;g()}function w(h){if(b.motionArr){h=1===b.motionArr[0][0]?0:1;for(var k=0;k<b.motionArr.length;k++)for(var n=0;n<b.motionArr[0].length;n++)b.motionArr[k][n]=h;F();S=!0;g()}}function F(){var h,k;if(b.motionArr){var n="";for(h=0;h<b.motionArr.length;h++)for(k=0;k<b.motionArr[0].length;k++)n+=1===b.motionArr[h][k]?"1":"0";h={name:b.name,zonemap:n,bindto:b.bindto};b.bindto&&(k=agent.helpers.findID(c.data,"bindto",b.bindto),
0<k.length&&([0].value=n));b.change&&b.change(n)}else h={name:b.name,zones:b.data,bindto:b.bindto},b.bindto&&(k=agent.helpers.findID(c.data,"bindto",b.bindto),0<k.length&&([0].value=b.data)),b.change&&b.change(b.data);comms.api.saveJSON(d,h)}function H(){if($(B).is(":visible")){switch(b.mode){case "spectrum":var h={type:"spectrum",mode:b.mode};comms.api.request(d,h,"resource",function(k,n){K.spectrum=JSON.parse(n)});break;default:if(D.needFrame){D.needFrame=!1;h=b.mode;if("detector"===h||"line"===
h)h=editing.detectorMode;h={type:"zoneimage",mode:h,width:parseInt(v),height:parseInt(t)};comms.api.request(d,h,"resource",function(k,n){D.loading.src=n})}}N&&comms.api.command(d,"querylevel",function(k,n){X=n.level})}}var K=this,B=a,O=null,S=!0,v=B.width,t=B.height,p=B.getContext("2d"),A={x:0,y:0},J=null,Q=!1,P=!1,Y=0,u=null,I=null,V=null,L=[],D={front:new Image,back:new Image},Z=null;this.options=b;this.spectrum=null;var X=0,T={x:0,y:0},N,R,W,U=!0;this.clear=function(h){w(null)};this.deinit=function(){$(document.body).off("mousemove touchmove",
l);$(window).off("mouseup touchend",r);$(B).off("mousedown touchstart",q);$(B).off("dblclick",w);window.clearInterval(Z);U=!1};this.init=function(){console.log("zonerenderer init: "+b.mode);U=!0;$(document.body).on("mousemove touchmove",l);$(window).on("mouseup touchend",r);$(B).on("mousedown touchstart",q);$(B).on("dblclick",w);D.loading=D.back;D.needFrame=!0;D.current=null;D.front.onload=function(){D.current=D.front;D.loading=D.back;D.needFrame=!0};D.back.onload=function(){D.current=D.back;D.loading=
D.front;D.needFrame=!0};var h=agent.helpers.findID(c.origData,"id","arrSensitivity");N=null;0<h.length&&(N=h[0]);switch(b.mode){case "line":case "detector":R=agent.helpers.findID(c.origData,"id","arrWidthLimits")[0],W=agent.helpers.findID(c.origData,"id","arrHeightLimits")[0]}Z=window.setInterval(H,200);g()};p.translate(.5,.5);this.init()},showVideo:function(a){a=agent.helpers.language.translations.Videos[a];editing.popHTML(a.title,'<div style="position:relative;padding-top:56.25%;"><iframe src ="//www.youtube.com/embed/'+
a.id+'?rel=0" frameborder="0" allowfullscreen style = "position:absolute;top:0;left:0;width:100%;height:100%;"></iframe></div>')},showHelp:function(){var a=agent.helpers.translate,b={page:"render",OKOnly:!0,name:"help",currentSection:a("Video"),data:{header:a("help.Help"),okResult:"",sections:[]}},d="<p>"+a("VideoIntro")+"<ul>",c=agent.helpers.language.translations.Videos,e;for(e=0;e<c.length;e++)d+='<li><a href="#" onclick="editing.showVideo('+e+')">'+c[e].title+"</a></li>";d+="</ul></p><p>"+a("VideoOutro")+
"</p>";b.data.sections.push({header:a("Video"),displayType:"Form",tabActive:!0,name:"Help0",items:[{value:d,type:"HTML"}]});e=1;for(var g in agent.helpers.language.translations.help.Sections){a=agent.helpers.language.translations.help.Sections[g];d=a.HTML;if(!d)break;d=d.replace(/<ul>/g,'<ul class="list-group">');d=d.replace(/<li>/g,'<li class="list-group-item">');b.data.sections.push({header:a.Header,displayType:"Form",tabActive:!1,name:"Help"+e,items:[{value:d,type:"HTML"}]});e++}b=ko.mapping.fromJS(b);
editing.renderObjects.push(b);editing.helpers.renderPage("lg")},profiles:{editIndex:-1,go:function(a){comms.api.command(agent.server,"setprofile&ind="+a,function(b,d){var c=agent.helpers.translate;editing.helpers.setStatus(c("ProfileLoaded"))})},show:function(){var a=agent.helpers.translate;a={page:"render",OKOnly:!0,name:"editProfiles",data:{header:a("Profiles"),okResult:"",sections:[{header:a("Profiles"),displayType:"TableEdit",tabActive:!0,editJSON:"editProfile",deleteJSON:"deleteProfile",addJSON:"addProfile",
help:a("Profiles_help"),items:[]}]}};for(var b=0;b<agent.server.profiles.length;b++){var d=agent.server.profiles[b];a.data.sections[0].items.push({index:b,text:' <button type="button" onclick="editing.profiles.go('+b+')" class="btn btn-sm btn-primary pull-right" title="Apply"><span class="fa fa-check fa-lg"> </span></button>'+(""!==d.name?d.name:b)})}a=ko.mapping.fromJS(a);a.generator=editing.profiles.show;editing.renderObjects.push(a);editing.helpers.renderPage()},showEdit:function(a){var b=agent.helpers.translate;
a={page:"render",data:{header:b("Profile"),okResult:-1!==editing.profiles.editIndex?"EditProfile":"AddProfile",name:"EditProfile",sections:[{header:b("Profile"),displayType:"Form",tabActive:!0,items:[{text:b("Name"),value:a.name,type:"String",help:b("RunProfile_help")}]}]}};a=ko.mapping.fromJS(a);editing.renderObjects.push(a);editing.helpers.renderPage("sm")},add:function(){editing.profiles.editIndex=-1;editing.profiles.showEdit({name:""})},edit:function(a){editing.profiles.editIndex=a;editing.profiles.showEdit(agent.server.profiles[a])},
"delete":function(a){editing.profiles.editIndex=a;comms.api.command(agent.server,"deleteProfile&ind="+a,function(){agent.server.profiles.splice(a,1);editing.renderObjects.pop();editing.profiles.show()})}},locations:{editIndex:-1,show:function(){var a=agent.helpers.translate;a={page:"render",OKOnly:!0,name:"editLocations",data:{header:a("Locations"),okResult:"UpdateLocationList",sections:[{header:a("Locations"),displayType:"TableEdit",tabActive:!0,editJSON:"editLocation",deleteJSON:"deleteLocation",
addJSON:"addLocation",items:[]}]}};for(var b=0;b<agent.server.locations.length;b++){var d=agent.server.locations[b];a.data.sections[0].items.push({index:b,text:""!==d.name?d.name:b})}a=ko.mapping.fromJS(a);a.generator=editing.locations.show;editing.renderObjects.push(a);editing.helpers.renderPage()},showEdit:function(a){var b=agent.helpers.translate;a={page:"render",data:{header:b("Location"),okResult:-1!==editing.locations.editIndex?"EditLocation":"AddLocation",name:"EditLocation",sections:[{header:b("Location"),
displayType:"Form",tabActive:!0,items:[{text:b("Name"),value:a.name,type:"String"},{text:b("Color"),value:a.color,type:"Color"}]}]}};a=ko.mapping.fromJS(a);editing.renderObjects.push(a);editing.helpers.renderPage("sm")},add:function(){editing.locations.editIndex=-1;editing.locations.showEdit({name:"",color:""})},edit:function(a){editing.locations.editIndex=a;editing.locations.showEdit(agent.server.locations[a])},"delete":function(a){editing.locations.editIndex=a;comms.api.command(agent.server,"deleteLocation&ind="+
a,function(){agent.server.locations.splice(a,1);editing.renderObjects.pop();editing.locations.show()})}}};

//live.js
function live(){var F,H,C;function O(a){function b(c){for(var e=0;e<c.length;e++){var f=c[e];if(f.bounds&&f.bounds.x<a.x&&f.bounds.x2>a.x&&f.bounds.y<a.y&&f.bounds.y2>a.y)return c[e]}}var d=b(p.toolbar);if(d)return d;p.menu.open&&(d=b(p.menu.list));return d||null}function L(a){var b=a;b.cmd&&(b=b.cmd);switch(b){case "startView":h.objMax=null;comms.api.command(agent.server,"stream-restore",null);h.startview(a.viewIndex);break;case "openviews":editing.openViews();break;case "toggleMenu":p.menu.open=
!p.menu.open;break;case "play":agent.videoPlayer.play();break;case "pause":agent.videoPlayer.pause();break;case "manualalert":comms.api.command(agent.currentObject,"manualalert",function(){});break;case "edit":editing.editObject(agent.currentObject);break;case "editview":editing.editView(agent.viewIndex);break;case "ptzpresets":editing.presets.show(agent.currentObject);break;case "startrecord":comms.api.command(agent.currentObject,"record",function(){});break;case "stoprecord":comms.api.command(agent.currentObject,
"recordstop",function(){});break;case "poweron":comms.api.command(agent.currentObject,"switchon");break;case "poweroff":comms.api.command(agent.currentObject,"switchoff");break;case "ptz":D&&((z=!z)?F=window.setInterval(h.checkPTZ,50):window.clearInterval(F));break;case "photo":comms.api.command(agent.currentObject,"snapshot",function(){var d=agent.helpers.translate;editing.helpers.setStatus(d("PhotoSaved"))});break;case "mute":agent.videoPlayer.muted=!0;agent.storage.set("muted","true");break;case "sound":agent.videoPlayer.muted=
!1;agent.storage.set("muted","false");break;case "micon":ba();break;case "micoff":M();break;case "startrtmp":comms.api.command(agent.currentObject,"start-rtmp",function(d,c){c.error&&""!==c.error&&editing.helpers.setStatus(c.error);c.message&&""!==c.message&&editing.helpers.setStatus(c.message)});break;case "startrtmpview":comms.api.loadJSON(agent.server,"start-rtmp-view",agent.server.views[agent.viewIndex],function(d,c){c.error&&""!==c.error&&editing.helpers.setStatus(c.error);c.message&&""!==c.message&&
editing.helpers.setStatus(c.message)});break;case "stoprtmpview":case "stoprtmp":comms.api.command(agent.server,"stop-rtmp",function(d,c){c.error&&""!==c.error&&editing.helpers.setStatus(c.error);c.message&&""!==c.message&&editing.helpers.setStatus(c.message)})}}function P(){var a=agent.maxHeight/agent.maxWidth,b=A.width,d=A.height,c=b,e=parseInt(Math.floor(b*a));e>d&&(e=d,c=parseInt(Math.floor(d/a)));return{w:Math.floor(b),h:Math.ceil(d-1),x:Math.floor((b-c)/2),y:agent.menu.autoHide?0:agent.sizes.topBar,
w2:c,h2:e}}function N(a,b,d,c){a.beginPath();a.moveTo(d+b[0].x,c+b[0].y);for(var e=1;e<b.length;e++)a.lineTo(d+b[e].x,c+b[e].y);a.lineTo(d+b[0].x,c+b[0].y);a.closePath();a.fill();a.stroke()}function Q(a,b,d){for(var c=0;c<a.length;c++)a[c].x+=b,a[c].y+=d}function E(a){if(m){if(h.objMax)return h.objMax;a=agent.helpers.mouseXY(a);a.x=agent.maxWidth/m.w2*(a.x-m.x);a.y=agent.maxHeight/m.h2*(a.y-m.y);for(var b=0;b<v.length;b++){var d=v[b];if(a.x>d.x&&a.x<d.x+d.w&&a.y>d.y&&a.y<d.y+d.h)return agent.helpers.findObject(d.ot,
d.oid)}return null}}function M(){n.active&&(n.active=!1,n.audioContext.close().then(function(){n.stream.getAudioTracks().forEach(function(a){a.stop()});comms.usingTransceivers&&(n.recorder.disconnect(),delete n.recorder)}))}function ba(){function a(e){for(var f=e.length,l=new Int16Array(e.length);f--;){var g=Math.max(-1,Math.min(1,e[f]));l[f]=0>g?32768*g:32767*g}return l}function b(e){var f=agent.currentObject;n.ws=agent.server.talkDataChannel;n.ws.onclose=function(){n.recorder&&n.recorder.disconnect();
n.active=!1};if(n.ws){n.active=!0;var l=new (window.AudioContext||window.webkitAudioContext)({SampleRate:16E3});n.audioContext=l;n.audioInput=l.createMediaStreamSource(e);n.stream=e;n.recorder=l.createScriptProcessor(2048,1,1);var g=-1;n.recorder.onaudioprocess=function(k){if(n.active)if(-1===g)g=n.recorder.context.sampleRate,2640>agent.server.versionNumeric?n.ws.send(JSON.stringify({oid:f.id,sampleRate:g,ot:f.typeID,channel:"talk"})):comms.api.command(agent.currentObject,"talk&samplerate="+g,function(){});
else{k=k.inputBuffer.getChannelData(0);try{n.ws.send(a(k))}catch(w){M()}}};n.audioInput.connect(n.recorder);n.recorder.connect(l.destination)}}function d(e){if(e.name)switch(e.name){case "NotAllowedError":editing.helpers.setStatus("Enable Mic Access",2E3);break;case "NotFoundError":editing.helpers.setStatus("No device available",2E3);break;default:editing.helpers.setStatus("Error: "+e.message,2E3)}else editing.helpers.setStatus("Not accessible",2E3)}if(!n.active)if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)navigator.mediaDevices.getUserMedia({audio:!0,
video:!1}).then(b)["catch"](d);else{var c=navigator.getUserMedia||navigator.webKitGetUserMedia||navigator.moxGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;c?c({audio:!0,video:!1},b,d):editing.helpers.setStatus("Not supported",2E3)}}this.name="Live";this.shortcutKey=49;this.action="goLive";this.fps=30;this.icon="\uf03d";this.iconName="fa-video-camera";this.cmd=this.playobj=null;var h=this,q=null,R=null;this.objMax=null;this.cycleDelay=0;var S=new Date,I,J,A={width:0,height:0},n=
{active:!1},D=!1,v=[],B=[],p={toolbar:[],menu:{open:!1,maxWidth:0,maxHeight:0,list:[]},lastUpdate:null};this.allswitch=!0;var z=!1,r="",m,x=null,u={},G=!1,T=(new Date).getTime(),y=C=H=F=null,K=null,U=function(a){var b=agent.server.views[agent.viewIndex],d=agent.currentObject;if(d){var c;for(c=0;c<b.objects.length&&(b.objects[c].oid!==d.id||b.objects[c].ot!==d.typeID);c++);switch(a.which){case 37:case 38:c--;0>c&&(c=b.objects.length-1);agent.currentObject=agent.helpers.findObject(b.objects[c].ot,b.objects[c].oid);
comms.api.command(agent.currentObject,"setaudio",null);break;case 39:case 40:c++;c>=b.objects.length&&(c=0);agent.currentObject=agent.helpers.findObject(b.objects[c].ot,b.objects[c].oid);comms.api.command(agent.currentObject,"setaudio",null);break;case 13:case 32:null!==d&&(null!==h.objMax?(comms.api.command(agent.server,"stream-restore",null),h.objMax=null):(comms.api.command(d,"stream-max",null),h.objMax=agent.currentObject))}if(agent.shortcutKeys){for(c=0;c<p.toolbar.length;c++)if(b=p.toolbar[c],
b.keyCode===a.which){L(b.cmd);break}for(c=0;c<p.menu.list.length;c++)if(b=p.menu.list[c],b.keyCode===a.which){L(b.cmd);break}}}},V=function(a){if(D){if(50<(new Date).getTime()-T){a=a.originalEvent;var b=-.3;0>a.deltaY&&(b=.3);agent.helpers.stopEvent(a);var d=q.offset().left,c=q.offset().top,e=E(a);if(null===e)return;var f=e.r;h.objMax&&(f={x:m.x,y:m.y,w:m.w2,h:m.h2});d=Math.max(0,(a.pageX-d-f.x)/f.w);a=Math.max(0,(a.pageY-c-f.y)/f.h);u.object=e;comms.api.command(e,"digilivezoom&x="+d+"&y="+a+"&z="+
b,null,null);T=(new Date).getTime()}h.resetCycle()}},W=function(a){lastmove=Date.now();agent.menu.show();overtext="";var b=agent.helpers.mouseXY(a);live.cmd=O(b);live.cmd&&agent.helpers.hoverCommand(a,live.cmd);if(!z){var d=a.originalEvent;if(agent.server&&D&&d&&d.touches&&2===d.touches.length){var c={x:d.touches[0].pageX,y:d.touches[0].pageY};var e={x:d.touches[1].pageX,y:d.touches[1].pageY};u.zoomEnd=agent.helpers.calcDist(c,e);d=u.object.r;b=u.zoomEnd-u.zoomStart;if(1<Math.abs(b)){var f=(c.x+e.x)/
2-d.x;c=(c.y+e.y)/2-d.y;f=Math.max(0,f/d.w);d=Math.max(0,c/d.h);comms.api.command(u.object,"digilivezoom&x="+f+"&y="+d+"&z="+b/15*.2,null,null);u.zoomStart=u.zoomEnd;x=null}agent.helpers.stopEvent(a)}else agent.server&&D&&null!==x&&G&&(e=E(a),e===x&&e===u.object&&(d=u.object.r,f=K.x-b.x,c=K.y-b.y,f/=d.w,d=c/d.h,.01<Math.sqrt(Math.pow(f,2)+Math.pow(d,2))&&(comms.api.command(e,"digilivenav&x="+f+"&y="+d,null,null),K=b),agent.helpers.stopEvent(a)))}},X=function(a){lastmove=Date.now();x=null;G=!1},Y=
function(a){a.preventDefault();agent.menu.show();S=(new Date).getTime();y=agent.helpers.mouseXY(a);K={x:y.x,y:y.y};if(!(agent.menu.autoHide&&y.y<agent.sizes.topBar)){x=null;G=!0;var b=a.originalEvent;u.object=E(a);if(!z&&agent.server&&D&&b&&b.touches&&2===b.touches.length){a={x:b.touches[0].pageX,y:b.touches[0].pageY};b={x:b.touches[1].pageX,y:b.touches[1].pageY};u.zoomStart=agent.helpers.calcDist(a,b);var d=u.object.r,c=(a.y+b.y)/2-d.y;u.xpc=Math.max(0,((a.x+b.x)/2-d.x)/d.w);u.ypc=Math.max(0,c/d.h)}else{if(z)for(b=
q.width(),d=q.height(),a=Math.PI/8,c=0;c<B.length;c++){if(agent.helpers.pointIsInPoly({x:y.x-b/2,y:y.y-d/2},B[c].points)){switch(B[c].cmd){case "dir":b=Math.atan2(d/2-y.y,b/2-y.x);b<a&&b>-a&&(r="ispydir_1");b>=a&&b<3*a&&(r="ispydir_2");b>=3*a&&b<5*a&&(r="ispydir_3");b>=5*a&&b<7*a&&(r="ispydir_4");if(b>=7*a||b<-7*a)r="ispydir_5";b<=-5*a&&b>-7*a&&(r="ispydir_6");b<=-3*a&&b>-5*a&&(r="ispydir_7");b<=-a&&b>-3*a&&(r="ispydir_8");break;case "zoomin":r="ispydir_9";break;case "zoomout":r="ispydir_10"}return}}else x=
E(a);lastmove=Date.now()}}},Z=function(a){G=!1;a.preventDefault();if(""!==r&&z)r="ispydir_11",agent.helpers.stopEvent(a);else{var b=agent.helpers.mouseXY(a);if(agent.helpers.calcDist(y,b)<agent.touchClickRadius&&300>(new Date).getTime()-S)h.click(a);else if(null!==x){var d=E(a);if(d&&d!==x){G=!1;var c=agent.server.views[agent.viewIndex];b=a=null;var e;for(e=0;e<c.objects.length&&(a=c.objects[e],a.oid!==d.id||a.ot!==d.typeID);e++);for(e=0;e<c.objects.length&&(b=c.objects[e],b.oid!==x.id||b.ot!==x.typeID);e++);
a&&b&&(d=a.ot,c=a.oid,a.oid=b.oid,a.ot=b.ot,b.oid=c,b.ot=d,h.objectsChanged(!1),h.saveViews())}x=null}}};this.resetCycle=function(){agent.server&&(C&&clearInterval(C),0<h.cycleDelay&&(C=setInterval(h.cycleView,1E3*h.cycleDelay)))};this.saveViews=function(){agent.server&&(agent.helpers.checkViews(),agent.server.isAccess||comms.api.loadJSON(agent.server,"saveviews",agent.server.views))};this.checkPTZ=function(){""!==r&&(comms.api.command(agent.currentObject,"ptzcommand&field=ptz&value="+encodeURIComponent(r)),
"ispydir_11"===r&&(r=""))};this.init=function(){q=agent.mainCanvas;R=agent.ctx;q.on("keydown",U);q.on("wheel",V);q.on("mousemove touchmove",W);q.on("mouseout",X);q.on("mousedown touchstart",Y);q.on("mouseup touchend",Z);h.objectsChanged();null!==h.playobj&&(agent.currentObject=h.objMax=h.playobj,comms.api.command(agent.currentObject,"stream-max",null),h.playobj=null)};this.deinit=function(){if(q){q.off("keydown",U);q.off("wheel",V);q.off("mousemove touchmove",W);q.off("mouseout",X);q.off("mousedown touchstart",
Y);q.off("mouseup touchend",Z);if(agent.videoPlayer){try{agent.videoPlayer.pause()}catch(a){console.error(a)}try{comms.api.command(agent.currentObject,"streamstop")}catch(a){console.error(a)}}M();F&&window.clearInterval(F);C&&window.clearInterval(C)}};this.cycleView=function(){agent.server&&0<agent.maxHeight&&0<h.cycleDelay&&!editing.modalVisible()&&h.nextView(1)};this.nextView=function(a){for(var b=agent.server,d=agent.viewIndex,c=0,e=-1;c<b.views.length;)if(d+=a,c++,d===b.views.length&&(d=0),-1===
d&&(d=b.views.length-1),0<b.views[d].objects.length){e=d;break}-1<e&&e!==agent.viewIndex&&h.startview(e)};this.objectsChanged=function(){var a=null,b=agent.server;agent.helpers.checkViews();if(null===agent.currentObject){var d=b.views[agent.viewIndex];null===a&&null!==d.objects&&0<d.objects.length&&(a=agent.helpers.findObject(d.objects[0].ot,d.objects[0].oid));null!==a&&(agent.currentObject=a)}a=b.Permissions;D=null===a||a.ptz;z=!1;h.startview(agent.viewIndex)};this.resize=function(){var a=agent.server;
if(a&&a.dataChannel){var b=h.getArea();m=P();!b||b.width===A.width&&b.height===A.height||(A=b,H&&window.clearTimeout(H),H=window.setTimeout(function(){comms.api.command(agent.server,"reschange&width="+b.width+"&height="+b.height,function(d,c){h.updateLiveArray(c.array,c.width,c.height)})},500))}};this.render=function(){var a=R;if(a){I=agent.size.w;J=agent.size.h;var b=agent.helpers.translate,d;a.font=agent.sizes.fontLarge+"px "+agent.theme.font;if(m&&0<v.length){var c=(new Date).getSeconds()%3;for(var e=
"",f=0;f<c;f++)e+=" ";c=e+".";try{a.drawImage(agent.videoPlayer,m.x,m.y,m.w2,m.h2)}catch(aa){(console.error||console.log).call(console,aa.stack||aa)}agent.videoPlayer.playing||agent.helpers.centerText(a,b("ClickToStart"));var l;e=(new Date).getSeconds();f=agent.server.locations;for(b=0;b<v.length;b++){var g=v[b],k=g.obj;if(!(null===k||h.objMax&&h.objMax!==k)){g=h.objMax?m:{x:m.x+m.w2/agent.maxWidth*g.x,y:m.y+m.h2/agent.maxHeight*g.y,w:m.w2/agent.maxWidth*g.w,h:m.h2/agent.maxHeight*g.h};k.r=g;k.data.recording&&
(a.fillStyle="#ff0000",a.fillRect(g.x+g.w-15,g.y+5,10,10));if(agent.labels||!k.data.online||k.data.connecting){var w=[k.name];-1<k.locationIndex&&k.locationIndex<f.length&&w.push(f[k.locationIndex].name);k.data.online&&k.data.connecting&&w.push(c);var t=a.font;a.font=agent.sizes.font+"px "+agent.theme.font;for(l=d=0;l<w.length;l++)d=Math.max(d,a.measureText(w[l]).width+agent.sizes.padding);d=Math.min(d,g.w-2-agent.sizes.padding);a.fillStyle=agent.theme.overlay;a.fillRect(g.x+1,g.y+1,d,w.length*(agent.sizes.font+
2+agent.sizes.padding/2));a.fillStyle=agent.theme.foreground;for(l=0;l<w.length;l++)a.fillText(w[l],g.x+1+agent.sizes.padding/2,g.y+(l+1)*(agent.sizes.font+agent.sizes.padding/2)-4,d);a.font=t}if(h.objMax)break;else d=a.strokeStyle,a.beginPath(),a.lineWidth=2,t=agent.theme.grid,agent.currentObject&&(k===agent.currentObject?t=agent.theme.selected:f&&-1<k.locationIndex&&k.locationIndex<f.length&&(t=f[k.locationIndex].color,""===t&&(t=agent.theme.grid))),a.strokeStyle=t,a.moveTo(Math.max(1,g.x),g.y),
t=Math.min(g.y+g.h,m.h2+m.y-1.5),a.lineTo(Math.max(1,g.x),t),a.lineTo(g.x+g.w,t),a.stroke(),0===e%2&&k.data.online&&(k.data.alerted?(a.strokeStyle="#ff0000",a.beginPath(),t=Math.max(g.y,m.y+1),a.moveTo(g.x,t),a.lineTo(g.x+g.w-1.5,t),a.lineTo(g.x+g.w-1.5,g.y+g.h),a.stroke()):k.data.detected&&5E3>(new Date).getTime()-k.data.detected&&(a.strokeStyle="#ff9326",a.beginPath(),a.moveTo(g.x,g.y),a.lineTo(g.x+g.w-1,g.y),a.lineTo(g.x+g.w-1,g.y+g.h),a.stroke())),a.strokeStyle=d}}}b=agent.currentObject;if(!(null!==
p.lastUpdate&&300>(new Date).getTime()-p.lastUpdate.getTime())){p.lastUpdate=new Date;e=agent.helpers.translate;p.toolbar=[];p.menu.list=[];c=p.toolbar;f=!0;k=!1;if(g=agent.server.Permissions)k=g.readOnly,f=g.ptz;if(b){if(b.data.online){if(!k){c.push({icon:"\uf011",cmd:"poweroff",keyCode:79});c.push({icon:"\uf044",cmd:"edit",state:!0,keyCode:69});if(2===b.typeID||-1===b.data.pairid)b.data.recording?c.push({icon:"\uf192",cmd:"stoprecord",keyCode:82}):c.push({icon:"\uf192",cmd:"startrecord",keyCode:82});
2===b.typeID&&c.push({icon:"\uf030",cmd:"photo",state:!0,keyCode:67});c.push({icon:"\uf071",cmd:"manualalert",keyCode:84})}}else k||(c.push({icon:"\uf011",cmd:"poweron",keyCode:79}),c.push({icon:"\uf044",cmd:"edit",keyCode:69}));b.data.online&&f&&(-1<b.data.ptzid||-5===b.data.ptzid)&&p.menu.list.push({icon:"\uf03a",cmd:"ptzpresets",state:!0,text:"Presets",keyCode:89})}c.push({icon:"\uf142",cmd:"toggleMenu",right:!0});A.width<agent.sizes.minLive&&(c=p.menu.list);c.push({icon:"\uf00a",cmd:"openviews",
text:"tt.openviews",right:!0,keyCode:86});k||c.push({icon:"\uf044",cmd:"editview",text:"tt.editview",right:!0,prompt:0===v.length?e("ClickEdit"):null,keyCode:66});f&&c.push({icon:"\uf0b2",cmd:"ptz",text:"tt.ptz",right:!0,state:!0,keyCode:90});a.font=agent.sizes.font+"px "+agent.theme.font;c=p.menu.list;agent.videoPlayer.paused?c.push({icon:"\uf00d",cmd:"play",state:!1,text:"Playing",keyCode:80}):c.push({icon:"\uf14a",cmd:"pause",state:!0,text:"Playing",keyCode:80});agent.videoPlayer.muted?c.push({icon:"\uf00d",
cmd:"sound",state:!0,text:"Audio",keyCode:65}):c.push({icon:"\uf14a",cmd:"mute",state:!1,text:"Audio",keyCode:65});k||(n.active?c.push({icon:"\uf14a",cmd:"micoff",state:!0,text:"Microphone",keyCode:77}):c.push({icon:"\uf00d",cmd:"micon",state:!1,text:"Microphone",keyCode:77}),agent.server.rtmpStreaming?c.push({icon:"\uf14a",cmd:"stoprtmpview",state:!1,text:"RTMPStreaming",keyCode:83}):c.push({icon:"\uf00d",cmd:"startrtmpview",state:!1,text:"RTMPStreaming",keyCode:83}));for(e=b=0;e<c.length;e++)f=
c[e],f.translated=agent.helpers.translate(f.text),f.key="",f.isMenu=!0,f.keyCode&&!agent.isMobile&&(f.key=agent.helpers.getChar(f.keyCode)),f.textWidth=a.measureText(f.translated+" "+f.key).width,f.textWidth>b&&(b=f.textWidth);p.menu.maxWidth=parseInt(b)}(c=agent.menu.shouldShow())&&agent.helpers.drawToolbar(a,p.toolbar,live.cmd);if(z){a.fillStyle=agent.theme.ptz;a.strokeStyle=agent.theme.foreground;a.lineWidth=1;B=[];for(b=0;8>b;b++){e=void 0;f=a;k=2*b*Math.PI/8;g=agent.size.w;d=agent.size.h-2*agent.sizes.topBar;
t=Math.min(300,Math.min(g/2,d/2));l=Math.min(80,Math.max(70,g/8));w=Math.min(80,Math.max(50,d/8));l=[{x:0-w,y:l/2},{x:0,y:0},{x:0-w,y:-(l/2)}];for(e in l)l.hasOwnProperty(e)&&(w=l[e].y*Math.cos(k)+(t+l[e].x)*Math.sin(k),l[e].x=(t+l[e].x)*Math.cos(k)-l[e].y*Math.sin(k),l[e].y=w);N(f,l,g/2,agent.sizes.topBar+d/2);B.push({points:l,angle:k,cmd:"dir"})}b=Math.min(50,Math.max(40,I/20));e=Math.min(15,Math.max(15,J/80));f=[{x:0-b,y:e},{x:-e,y:e},{x:-e,y:b},{x:e,y:b},{x:e,y:e},{x:b,y:e},{x:b,y:-e},{x:e,y:-e},
{x:e,y:-b},{x:-e,y:-b},{x:-e,y:-e},{x:-b,y:-e}];k=[{x:-b,y:e},{x:b,y:e},{x:b,y:-e},{x:-b,y:-e}];Q(f,0-b-e,0);Q(k,b+e,0);N(a,f,I/2,J/2);N(a,k,I/2,J/2);B.push({points:f,cmd:"zoomin"});B.push({points:k,cmd:"zoomout"})}p.menu.open&&c&&agent.helpers.drawCommandMenu(a,p.menu,live.cmd)}};this.click=function(a){var b=agent.helpers.mouseXY(a),d=O(b);if(d)L(d);else if(!(agent.menu.autoHide&&b.y<agent.sizes.topBar)){if(v&&b.y>m.y&&b.y<m.y+m.h){if(m&&0<v.length&&!agent.videoPlayer.playing){agent.videoPlayer.play();
return}b=E(a);if(h.objMax&&2!==a.button){comms.api.command(agent.server,"stream-restore",null);h.objMax=null;return}null!==b?(2===a.button?(agent.helpers.stopEvent(a),!b||agent.server.Permissions&&agent.server.Permissions.readOnly||editing.editObject(b)):agent.currentObject===b&&(h.objMax=b,comms.api.command(b,"stream-max")),agent.currentObject=b,comms.api.command(b,"setaudio"),agent.labels||editing.helpers.setStatus(b.name,1E3)):agent.currentObject&&2===a.button&&(agent.helpers.stopEvent(a),agent.server.Permissions&&
agent.server.Permissions.readOnly||editing.editObject(agent.currentObject))}h.resetCycle()}};this.getArea=function(){var a=agent.size.w,b=agent.size.h;agent.menu.autoHide||(b-=agent.sizes.topBar+agent.sizes.bottomBar);0!==a%2&&a++;0!==b%2&&b++;return{width:a,height:b}};this.startview=function(a){a=void 0===a?agent.viewIndex:a;if(agent.server&&agent.server.views){var b=h.getArea();b&&(A=b,agent.viewIndex=a,a=agent.server.views[agent.viewIndex],editing.helpers.setStatus(""!==a.name?a.name:"?",1E3),
a.maxWidth=b.width,a.maxHeight=b.height,a.backColor=agent.theme.backColor,a.id=-1,a.typeID=-1,agent.currentObject&&(a.id=agent.currentObject.id,a.typeID=agent.currentObject.typeID),a.focused=!1,agent.currentObject&&(a.focused=agent.currentObject===h.objMax),a.focused||(h.objMax=null),comms.api.loadJSON(agent.server,"stream",a,function(d,c){h.updateLiveArray(c.array,c.width,c.height);if(!agent.videoPlayer.playing){var e=agent.videoPlayer.play();null!==e&&(e.then(function(f){}),e["catch"](function(f){console.error(f)}))}h.resize()}),
h.resetCycle())}};this.updateLiveArray=function(a,b,d){v=a;b&&(agent.maxWidth=b,agent.maxHeight=d,m=P());a=null;for(b=0;b<v.length;b++){d=v[b];var c=agent.helpers.findObject(d.ot,d.oid);null===c?(v.splice(b,1),b--):(d.obj=c,c===agent.currentObject&&(a=c))}null===a&&0<v.length&&(a=v[0].obj);null!==a&&(agent.currentObject=a,comms.api.command(agent.currentObject,"setaudio",null))};this.mousedown=function(a){}};

//photos.js
function photos(){function R(a){if(agent.shortcutKeys)for(var b=0;b<F.length;b++){var c=F[b];if(c.keyCode===a.which){S(c.cmd);break}}}function ba(a){var b=[];u&&(b.push({icon:"\uf1f8",cmd:"massdeletegrabs",keyCode:46}),b.push({icon:"\uf093",cmd:"uploadcloudgrabs",keyCode:85}),agent.isIOSApp||agent.isIOS||b.push({icon:"\uf019",cmd:"download",keyCode:68}));b.push({icon:"\uf002",cmd:"filter",keyCode:70,right:!0,highlight:agent.search.apply});b.push({icon:"\uf067",cmd:"zoomin",keyCode:107,right:!0});
b.push({icon:"\uf068",cmd:"zoomout",keyCode:109,right:!0});agent.server.Permissions&&agent.server.Permissions.readOnly||b.push({icon:"\uf044",cmd:"editMode",keyCode:69,right:!0,highlight:u});F=b;agent.helpers.drawToolbar(a,F,photos.cmd)}function ca(a){var b=agent.mainCanvas[0].width;var c=agent.mainCanvas[0].height-agent.sizes.topBar-agent.sizes.bottomBar;0!==b%2&&b++;0!==c%2&&c++;if(null!==a){var d=b,k=parseInt(Math.floor(b*a));k>c&&(k=c,d=parseInt(Math.floor(c/a)));return{w:b,h:c,x:(b-d)/2,y:agent.sizes.topBar+
(c-k)/2,w2:d,h2:k}}return{w:b,h:c}}function T(a){a=a.originalEvent;var b=0>a.deltaY?Math.max(a.deltaY,-20):Math.min(a.deltaY,20);agent.helpers.stopEvent(a);M(b/(B/(f[0].height-agent.sizes.topBar-agent.sizes.bottomBar)))}function M(a){U?(w+=a,w<agent.sizes.topBar&&(w=agent.sizes.topBar),w>f[0].height-agent.sizes.bottomBar-(q[3]-q[1])&&(w=f[0].height-agent.sizes.bottomBar-(q[3]-q[1])),C=(w-agent.sizes.topBar)/(f[0].height-agent.sizes.topBar-agent.sizes.bottomBar)*B,C-a>B&&(C=B),0>C-a&&(C=0)):C=w=0}
function V(a){g=agent.helpers.mouseXY(a);if(!(g.y<agent.sizes.topBar)){photos.cmd=W(g);photos.cmd&&agent.helpers.hoverCommand(a,photos.cmd);var b=g.x,c=g.y;itemover=-1;var d,k;agent.isDesktop||!G||D||(J=!0);(d=a.originalEvent)&&d.touches&&2===d.touches.length&&(J=!0);if(G&&J)agent.helpers.setCursor(a,"pointer"),d=c-K,0!==d&&(M((0-d)/(B/(f[0].height-agent.sizes.topBar-agent.sizes.bottomBar))),K=c);else if(a.target===f[0]){for(k=0;k<x.length;k++)if(d=x[k],b>d.x&&c>d.y&&b<d.x2&&c<d.y2){agent.helpers.setCursor(a,
"pointer");break}D&&(agent.helpers.setCursor(a,"pointer"),d=c-K,0!==d&&(M(d),K=c));0<q.length&&b>q[0]&&c>q[1]&&b<q[2]&&c<q[3]&&agent.helpers.setCursor(a,"pointer")}}}function N(a){a.target===f[0]&&2!==a.button&&(f[0].focus(),a.preventDefault(),l=agent.helpers.mouseXY(a),G=!0,J=!1,K=l.y,0<q.length&&l.x>q[0]&&l.y>q[1]&&l.x<q[2]&&l.y<q[3]&&(D=!0))}function X(a){for(var b=a.grabs.length,c=0;c<b;c++){var d=a.grabs[c];agent.search.apply&&d.filtered||(d.selected=a.selected)}}function W(a){for(var b=0;b<
F.length;b++){var c=F[b];if(c.bounds.x<a.x&&c.bounds.x2>a.x&&c.bounds.y<a.y&&c.bounds.y2>a.y)return F[b]}return null}function da(){for(var a=[],b=0;b<agent.server.objectList.length;b++){var c=agent.server.objectList[b];if(0<c.grabs.length)for(var d=c.grabs.length,k=0;k<d;k++){var r=c.grabs[k];if(!agent.search.apply||!r.filtered)if(r.selected&&a.push({device:c.name,summary:r.summary,filename:r.filename,typeID:c.typeID,id:c.id}),10<a.length)break}}0<a.length?(b={page:"download",data:{okResult:"",items:[]}},
b.data.items=a,a=ko.mapping.fromJS(b),a.translate=function(n){return agent.helpers.translate(n)},editing.renderObjects.push(a),editing.helpers.renderPage()):(a=agent.helpers.translate,editing.helpers.setStatus(a("NoFilesSelected")))}function S(a){function b(){for(var H=agent.server,y=0;y<H.objectList.length;y++){var p=H.objectList[y];if(0<p.grabs.length){for(var m=p.grabs.length,E=[],L=0,z=0;z<m;z++){var h=p.grabs[z];if(!agent.search.apply||!h.filtered)if(h.selected&&(E.push({name:h.filename}),r++,
d?(p.grabs.splice(z,1),m--,z--):h.selected=!1,L++),L===c)break}0<L&&0<E.length&&(comms.api.load("loadjson",p,a,JSON.stringify({files:E}),function(v,A){k||(k=!0,A.success?editing.helpers.setStatus(n("OK")):editing.helpers.setStatus(n("Error")+": "+A.status))}),y--)}}0===r&&editing.helpers.setStatus(n("NoFilesSelected"))}var c=1,d=!1,k=!1;switch(a){case "massdeletegrabs":c=agent.maxFileOperations;d=!0;confirm="DeleteFiles";break;case "archivegrabs":c=agent.maxFileOperations;d=!0;confirm="ArchiveFiles";
break;case "uploadcloudgrabs":confirm="UploadFiles";break;case "editMode":u=!u;return;case "filter":editing.showFilter();return;case "zoomin":t.ZoomIn();return;case "zoomout":t.ZoomOut();return;case "download":da();return}var r=0,n=agent.helpers.translate;confirm?editing.helpers.confirm(n(confirm),b):b()}function Y(a){G=!1;if(!(a.target!==f[0]||D||2===a.button||(g=agent.helpers.mouseXY(a),g.y<agent.sizes.topBar||Math.sqrt(Math.pow(g.x-l.x,2)+Math.pow(g.y-l.y,2))>agent.touchClickRadius)))if(a=W(g))S(a.cmd);
else{I=null;var b=g.x,c=g.y,d;for(d=0;d<x.length;d++)if(a=x[d],b>a.x&&c>a.y&&b<a.x2&&c<a.y2){if("image"===a.cmd)if(u)a.obj.selected=!a.obj.selected;else{I=a.obj;break}if("minmax"===a.cmd){a.obj.minimized=!a.obj.minimized;break}if(u)switch(a.obj.type){case "Server":a.obj.selected=!a.obj.selected;for(b=0;b<a.obj.objectList.length;b++)c=a.obj.objectList[b],c.selected=a.obj.selected,X(c);return;case "Device":a.obj.selected=!a.obj.selected;X(a.obj);return}}}}function O(a){G=!1;if(a.target!==f[0]||D||J)D=
!1;else{g=agent.helpers.mouseXY(a);2===a.button&&(l=g);var b=Math.sqrt(Math.pow(g.x-l.x,2)+Math.pow(g.y-l.y,2));if((2===a.button||b>agent.touchClickRadius)&&!D&&agent.isDesktop&&u){b=Math.min(g.x,l.x);for(var c=Math.min(g.y,l.y),d=Math.max(g.x,l.x),k=Math.max(g.y,l.y),r=0;r<x.length;r++){var n=x[r];if("image"===n.cmd){var H=n.y,y=n.x2,p=n.y2;n.x>d||y<b||H>k||p<c||(n.obj.selected=2===a.button||!n.obj.selected)}}}else Y(a)}}function Z(a){touchstarttime=new Date;N(a)}function aa(a){agent.helpers.calcDist(l,
g)<agent.touchClickRadius?Y(a):O(a)}this.name="Photos";this.action="goPhotos";this.shortcutKey=52;this.fps=10;this.icon="\uf03e";this.iconName="fa-image";this.cmd=null;var t=this,f=null,q=[],x=[],F=[],e=null,G=!1,D=!1,w=0,C=0,B=0,g={x:0,y:0},K=0,l={x:0,y:0},u=!1,U=!1,I=null;this.scales=[{w:24,h:18,padding:4,isBig:!1,lines:1},{w:47,h:36,padding:4,isBig:!1,lines:2},{w:72,h:54,padding:4,isBig:!1,lines:3},{w:96,h:72,padding:4,isBig:!1,lines:4},{w:144,h:108,padding:4,isBig:!1,lines:5},{w:180,h:135,padding:6,
isBig:!0,lines:6},{w:216,h:162,padding:6,isBig:!0,lines:6},{w:270,h:203,padding:6,isBig:!0,lines:6},{w:320,h:240,padding:6,isBig:!0,lines:6}];this.scaleIndex=parseInt(agent.storage.get("scale",3));var J=!1;this.ZoomOut=function(){t.scaleIndex--;0>t.scaleIndex&&(t.scaleIndex=0);agent.storage.set("scale",t.scaleIndex)};this.ZoomIn=function(){t.scaleIndex++;t.scaleIndex>t.scales.length-1&&(t.scaleIndex=t.scales.length-1);agent.storage.set("scale",t.scaleIndex)};this.render=function(){if(e){var a=agent.sizes.topBar-
C;x=[];var b=t.scales[t.scaleIndex],c=b.padding,d;if(I)if((d=I.image)&&d.loaded)box=ca(d.height/d.width),e.drawImage(d,box.x,box.y,box.w2,box.h2);else{if(e.fillText("...",e.canvas.width/2,e.canvas.height/2),!d){d=new Image;d.loaded=!1;d.onload=function(){this.loaded=!0};I.image=d;var k={type:"grabimage",filename:I.filename};comms.api.request(I,k,"resource",function(P,Q){P.image.src=Q})}}else{var r=agent.server;d=!0;var n=15*agent.sizes.font;e.beginPath();for(var H=0,y=0;y<r.objectList.length;y++){var p=
r.objectList[y];if(0<p.grabs.length){var m=0;d=0<a&&a<e.canvas.height;var E=!0;for(var L=p.grabs.length,z=0;z<L;z++){var h=p.grabs[z];if(!agent.search.apply||!h.filtered){H=1;if(E){a+=4;e.fillStyle=agent.theme.bars;p.selected&&u&&(e.fillStyle=agent.theme.selected);var v=agent.sizes.font+agent.sizes.padding/2;e.fillRect(0,a,e.canvas.width,v);e.fillStyle=agent.theme.foreground;e.font=agent.sizes.font+"px "+agent.theme.font;E=e.measureText(p.name);e.fillText(p.name,e.canvas.width/2-E.width/2,a+v-agent.sizes.padding/
3);e.font=agent.FontAwesome(agent.sizes.font);e.fillText(p.minimized?"\uf2d0":"\uf2d1",5,a+v-agent.sizes.padding/2);x.push({x:-1,y:a-1,x2:agent.sizes.font+agent.sizes.padding/2,y2:a+agent.sizes.font+agent.sizes.padding/2,obj:p,cmd:"minmax"});x.push({x:agent.sizes.icon+agent.sizes.padding,y:a-1,x2:e.canvas.width,y2:a+agent.sizes.font+agent.sizes.padding/2,obj:p});a+=v+2;E=!1}if(p.minimized)break;v=m+b.w+2*c;var A=a+b.h+2*c;if(d=0<A&&a<e.canvas.height){h.selected&&u&&(e.fillStyle=agent.theme.selected,
e.fillRect(m,a,v-m,A-a));e.fillStyle=agent.theme.foreground;d=h.thumb;d||G||(h.thumb=new Image,h.thumb.loaded=!1,h.thumb.onload=function(){this.loaded=!0},k={type:"grabthumb",filename:h.filename},comms.api.request(h,k,"resource",function(P,Q){P.thumb.src=Q}));d&&!1!==d.loaded?e.drawImage(h.thumb,m+c,a+c,b.w,b.h):e.fillText("...",m+c,a+c,b.w);x.push({x:m,y:a,x2:v+n,y2:A,obj:h,cmd:"image"});m=h.summary.split("|");""!==h.tags&&m.push(h.tags);e.fillStyle=agent.theme.foreground;e.font=agent.sizes.font+
"px "+agent.theme.font;for(h=0;h<m.length&&(e.fillText(m[h].trim(),v+4,a+2+agent.sizes.font*(h+1)),h+1!==b.lines);h++);m=v+4+n;m+b.w+2*c+4+n>e.canvas.width&&(m=0,a=A+4)}0<b.lines?(m=v+4+n,m+b.w+2*c+4+n>e.canvas.width&&(m=0,a=A+4)):(a=A+agent.sizes.padding,m=0)}}0<m&&(a=a+b.h+2*c+4)}}e.stroke();0===H&&(c=agent.helpers.translate,agent.helpers.centerText(e,c("NothingToDisplay")));G&&!D&&!J&&u&&agent.isDesktop&&(e.beginPath(),c=e.lineWidth,e.lineWidth=2,e.strokeStyle="rgba(115,185,255,1.0)",e.moveTo(l.x,
l.y),e.lineTo(g.x,l.y),e.lineTo(g.x,g.y),e.lineTo(l.x,g.y),e.lineTo(l.x,l.y),e.stroke(),e.lineWidth=c);B=a=C+a+b.h+2*agent.sizes.padding+4+agent.sizes.bottomBar+agent.sizes.topBar;M(0);if(U=B-agent.sizes.topBar-agent.sizes.bottomBar>f[0].height)e.beginPath(),e.fillStyle=agent.theme.scrollbar,a=Math.max(agent.scrollbars.minHeight,f[0].height/B*f[0].height),e.fillRect(f[0].width-agent.scrollbars.width,w,agent.scrollbars.width,a),q=[f[0].width-agent.scrollbars.width,w,f[0].width-1,w+a];ba(e)}}};this.resize=
function(){};this.init=function(){f=agent.mainCanvas;e=agent.ctx;$(document.body).on("mousemove touchmove",V);agent.isAndroidApp||($(window).on("mouseup",O),f.on("mousedown",N));f.on("keydown",R);f.on("touchstart",Z);f.on("touchend",aa);f.on("wheel",T);for(var a=agent.server,b=0;b<a.objectList.length;b++){var c=a.objectList[b];2===c.typeID&&agent.eventManager.loadPhotos(c)}agent.server.Permissions&&agent.server.Permissions.readOnly&&(u=!1)};this.deinit=function(){f&&($(document.body).off("mousemove touchmove",
V),agent.isAndroidApp||($(window).off("mouseup",O),f.off("mousedown",N)),f.off("keydown",R),f.off("touchstart",Z),f.off("touchend",aa),f.off("wheel",T))}};

//playback.js
function playback(){function I(a){function b(m){for(var e=0;e<m.length;e++){var k=m[e];if(k.bounds.x<a.x&&k.bounds.x2>a.x&&k.bounds.y<a.y&&k.bounds.y2>a.y)return m[e]}}var c=b(n.toolbar);if(c)return c;n.menu.open&&(c=b(n.menu.list));return!c&&a.x>z-30&&a.y<agent.sizes.topBar?{cmd:"close",keyCode:27,bounds:{x:z-30,y:0,x2:z,y2:agent.sizes.topBar}}:c}function A(a){switch(a){case "next":g.skip(1);break;case "previous":g.skip(-1);break;case "toggleMenu":n.menu.open=!n.menu.open;break;case "faster":h.index++;
h.index=Math.min(h.options.length-1,h.index);comms.api.command(t,"setplayspeed&rate="+h.options[h.index]);editing.helpers.setStatus("x "+h.options[h.index],1E3);break;case "slower":h.index--;h.index=Math.max(0,h.index);comms.api.command(t,"setplayspeed&rate="+h.options[h.index]);editing.helpers.setStatus("x "+h.options[h.index],1E3);break;case "playall":g.playAll=!g.playAll;break;case "play":comms.api.command(t,"playpause&state=play");g.playing=!0;break;case "pause":comms.api.command(t,"playpause&state=pause");
g.playing=!1;break;case "photo":a=document.createElement("canvas");var b=agent.videoPlayer;a.width=b.videoWidth;a.height=b.videoHeight;a.getContext("2d").drawImage(agent.videoPlayer,0,0);a={name:"uploadframe",base64:a.toDataURL("image/jpeg")};comms.api.saveJSON(t,a,function(c,m){var e=agent.helpers.translate;editing.helpers.setStatus(e("PhotoSaved"))});break;case "mute":agent.videoPlayer.muted=!0;break;case "sound":agent.videoPlayer.muted=!1;break;case "close":comms.api.command(t,"stopplayback");
g.deinit();g.playing=!1;agent.screen.init();break;case "tags":a=agent.helpers.translate,a={page:"render",data:{header:a("EditTags"),okResult:"UpdateTags",name:"UpdateTags",sections:[{header:a("EditTags"),displayType:"Form",tabActive:!0,items:[{text:a("Tags"),value:v.tags,type:"String"}]}]}},a=ko.mapping.fromJS(a),a.file=v,editing.renderObjects.push(a),editing.helpers.renderPage("sm")}}function J(a,b){b.error?editing.helpers.setStatus(b.error):(g.playing=!0,agent.videoPlayer.playing||(agent.videoPlayer.load(),
agent.videoPlayer.play()),""!==v.tags&&editing.helpers.setStatus(v.tags),g.resize())}function K(a){a=a.toISOString().substr(11,8).split(":");var b=parseInt(a[0]);return 0<b?b+":"+a[1]+":"+a[2]:parseInt(a[1])+":"+a[2]}var g=this,z,F,d,D;this.nativeSize=null;this.fps=20;this.playAll=this.active=this.playing=!1;this.cmd=null;var n={menu:{open:!1,maxWidth:0,maxHeight:0,list:[]},toolbar:[]},E=null,w=null,B=0,G=0,t=null,p,u={},H={width:0,height:0},l=null,v=null,h={index:2,options:[.25,.5,1,2,4,8,16]};this.getArea=
function(){var a=agent.mainCanvas[0].width,b=agent.mainCanvas[0].height;0!==a%2&&a++;0!==b%2&&b++;return{width:a,height:b}};this.resize=function(){H=g.getArea()};this.close=function(){A("close")};this.init=function(a){l=agent.mainCanvas;d=agent.ctx;Array.isArray(a)?(E=a,g.playAll=!0,a=v=a[a.length-1]):(a=v=a,E=null);t=a.parent;srv=t.parent;B=a.duration;comms.api.command(a.parent,"getgraph&fn="+a.filename,function(m,e){w=e});var b=$(window),c=b.width();b=b.height();l.on("click",q.click);l.on("mousedown touchstart",
q.mousedown);l.on("mousemove touchmove",q.mousemove);l.on("mouseout",q.mouseout);l.on("wheel",q.wheel);l.on("keydown",q.keydown);l.on("mouseup touchend",q.touchend);g.active=!0;comms.api.command(a.parent,"playback&filename="+a.filename+"&maxWidth="+c+"&maxHeight="+b+"&rate="+h.options[h.index],J)};this.deinit=function(){l&&(l.off("click",q.click),l.off("mousedown touchstart",q.mousedown),l.off("mousemove touchmove",q.mousemove),l.off("mouseout",q.mouseout),l.off("wheel",q.wheel),l.off("keydown",q.keydown),
l.off("mouseup touchend",q.touchend),g.active=!1)};var q={click:function(a){var b=agent.helpers.mouseXY(a),c=I(b);c?A(c.cmd):(b.y>F-agent.sizes.bottomBar&&(b=parseInt((b.x-30)/((agent.size.w-D)/B)),comms.api.command(t,"seek&time="+b),A("play")),agent.helpers.stopEvent(a))},mousedown:function(a){l.focus()},mousemove:function(a){var b=a.originalEvent;if(b&&b.touches&&2===b.touches.length){var c={x:b.touches[0].pageX,y:b.touches[0].pageY};b={x:b.touches[1].pageX,y:b.touches[1].pageY};u.object||(u.object=
t,u.zoomStart=agent.helpers.calcDist(c,b));u.zoomEnd=agent.helpers.calcDist(c,b);u.current={p1:c,p2:b};agent.helpers.stopEvent(a)}else c=agent.helpers.mouseXY(a),playback.cmd=I(c),playback.cmd&&agent.helpers.hoverCommand(a,playback.cmd),c=agent.helpers.mouseXY(a),c.y>F-agent.sizes.bottomBar&&agent.helpers.setCursor(a,"pointer")},mouseout:function(a){},wheel:function(a){if(null!==t){a=a.originalEvent;var b=-.2;0>a.deltaY&&(b=.2);agent.helpers.stopEvent(a);comms.api.command(t,"digifilezoom&x="+Math.max(0,
(a.pageX-p.x)/p.w2)+"&y="+Math.max(0,(a.pageY-p.y)/p.h2)+"&z="+b,null,null)}},keydown:function(a){if(27===a.which)A("close");else if(agent.shortcutKeys)for(var b=0;b<n.menu.list.length;b++){var c=n.menu.list[b];if(c.keyCode===a.which){A(c.cmd);break}}},touchend:function(a){if(u.object){var b=u.zoomEnd-u.zoomStart,c=domElement.offset().left,m=domElement.offset().top,e=u.current.p1,k=u.current.p2;comms.api.command(u.object,"digifilezoom&x="+Math.max(0,((e.x+k.x)/2-c-p.x)/p.w2)+"&y="+Math.max(0,((e.y+
k.y)/2-m-p.y)/p.h2)+"&z="+b/15*.2,null,null);u.object=null;a.preventDefault()}}};this.timeupdate=function(a){G=a};this.playend=function(){g.playAll&&g.skip(1)};this.skip=function(a){if(g.active&&v){var b=v,c=b.parent.events;E&&(c=E);b=c.indexOf(b);-1<b&&(b-=a,-1<b&&b<c.length?(v=b=c[b],B=b.duration,comms.api.command(b.parent,"getgraph&fn="+b.filename,function(m,e){w=e}),comms.api.command(b.parent,"playback&filename="+b.filename+"&rate="+h.options[h.index],J)):(a=agent.helpers.translate,editing.helpers.setStatus(a("NoMoreRecordings"))))}};
this.render=function(){z=agent.size.w;F=agent.size.h;try{if(0<agent.videoPlayer.videoWidth){var a=agent.videoPlayer.videoHeight/agent.videoPlayer.videoWidth,b=H.width,c=H.height-agent.sizes.bottomBar;if(null!==a){var m=b,e=parseInt(Math.floor(b*a));e>c&&(e=c,m=parseInt(Math.floor(c/a)));p={w:b,h:c,x:(b-m)/2,y:(c-e)/2,w2:m,h2:e}}else p={w:b,h:c};d.drawImage(agent.videoPlayer,p.x,p.y,p.w2,p.h2)}a=d;n.menu.list=[];n.toolbar=[];b=!1;var k=agent.server.Permissions;k&&(b=k.readOnly,ptz=k.ptz);a.font=agent.sizes.font+
"px "+agent.theme.font;var f=n.toolbar;f.push({icon:"\uf142",cmd:"toggleMenu",right:!0});b||2===v.parent.typeID&&f.push({icon:"\uf03e",cmd:"photo",text:"TakePhoto",keyCode:67,right:!0});agent.videoPlayer.muted?f.push({icon:"\uf026",cmd:"sound",text:"Audio",keyCode:65,right:!0}):f.push({icon:"\uf028",cmd:"mute",text:"Audio",keyCode:65,right:!0});g.playing?f.push({icon:"\uf04c",cmd:"pause",text:"Playing",keyCode:80,right:!0}):f.push({icon:"\uf04b",cmd:"play",text:"Playing",keyCode:80,right:!0});f=n.menu.list;
g.playAll?f.push({icon:"\uf14a",cmd:"playall",text:"PlayAll"}):f.push({icon:"\uf00d",cmd:"playall",text:"PlayAll"});b||f.push({icon:"\uf03a",cmd:"tags",text:"Tags",keyCode:84});f.push({icon:"\uf105",cmd:"next",text:"Next",keyCode:188});f.push({icon:"\uf104",cmd:"previous",text:"Previous",keyCode:190});f.push({icon:"\uf067",cmd:"faster",text:"SpeedUp",keyCode:107});f.push({icon:"\uf068",cmd:"slower",text:"SlowDown",keyCode:109});for(b=k=0;b<f.length;b++){var r=f[b];r.translated=agent.helpers.translate(r.text);
r.key="";r.isMenu=!0;r.keyCode&&!agent.isMobile&&(r.key=agent.helpers.getChar(r.keyCode));r.textWidth=a.measureText(r.translated+" ("+r.key+")").width;r.textWidth>k&&(k=r.textWidth)}n.menu.maxWidth=parseInt(k);D=agent.size.w-agent.helpers.drawToolbar(d,n.toolbar,playback.cmd).right;d.fillStyle=agent.theme.overlay;var x=agent.sizes.bottomBar,y=agent.size.h-x;d.fillRect(0,y,agent.size.w-D,x);var C=w.raw;f=z-D;r=f/B;a=k=0;d.strokeStyle=agent.theme.foreground;d.lineWidth=.5;var M=w.triggerLevelMax<w.triggerLevel?
100:w.triggerLevelMax;if(null!==C&&0<C.length){var N=f/C.length;for(m=c=b=0;m<C.length-1;m++)c=Math.max(c,C[m]/100),b+=N,5<b&&(e=x*c,d.fillStyle=100*c>=w.triggerLevel&&100*c<=M?agent.theme.alertbar:agent.theme.foreground,d.fillRect(k,y+x-e,b,e),k+=b,c=b=0);d.beginPath();a=y+x-w.triggerLevel*x/100;d.moveTo(0,a);d.lineTo(f,a);a=x-w.triggerLevelMax*x/100;d.moveTo(0,y+a);d.lineTo(f,y+a);d.stroke()}d.beginPath();d.strokeStyle=agent.theme.highlightButton;d.lineWidth=2;a=Math.min(B,G/1E3)*r;d.moveTo(a,y);
d.lineTo(a,y+x);d.stroke();d.font=agent.sizes.font+"px "+agent.theme.font;var O=K(new Date(1E3*w.duration)),L=K(new Date(G))+" / "+O,P=d.measureText(L).width+agent.sizes.padding/2;d.fillStyle=agent.theme.overlay;d.fillRect(0,y+agent.sizes.padding/2,P,agent.sizes.font+4);d.fillStyle=agent.theme.foreground;d.fillText(L,2,y+agent.sizes.font+agent.sizes.padding/2);d.font=agent.FontAwesome(agent.sizes.icon);d.fillStyle=playback.cmd&&"close"===playback.cmd.cmd?agent.theme.highlightButton:agent.theme.controlForeground;
d.fillText("\uf00d",z-agent.sizes.icon-agent.sizes.padding/3,agent.sizes.topBar/2+agent.sizes.font/2);n.menu.open&&agent.helpers.drawCommandMenu(d,n.menu,playback.cmd)}catch(Q){}}};

//vr.js
function vr(){function oa(){null===pa?(agent.state="loading",agent.helpers.loadScript("script/webxr-polyfill.js",!0,function(a,c){pa=new WebXRPolyfill;qa()},function(a,c,d){agent.state="loadScriptFailed"})):qa()}function qa(){navigator.xr?navigator.xr.isSessionSupported("immersive-vr").then(function(a){C.supported.vr=a;navigator.xr.isSessionSupported("inline").then(function(c){C.supported.inline=c&&!agent.isMobile;C.supported.vr||C.supported.inline?za():agent.state="startVR"})}):agent.state="startVR"}
function za(){ra?agent.state="startVR":agent.helpers.loadScript("script/three.min.js?v=1",!0,function(a,c){agent.state="startVR";ra=!0;THREE.PointerLockControls=function(d,f){function b(q){if(!1!==h.isLocked){var ha=q.movementX||q.mozMovementX||q.webkitMovementX||0;q=q.movementY||q.mozMovementY||q.webkitMovementY||0;y.setFromQuaternion(d.quaternion);y.y-=.002*ha;y.x-=.002*q;y.x=Math.max(-O,Math.min(O,y.x));d.quaternion.setFromEuler(y);h.dispatchEvent(g)}}function e(){document.pointerLockElement===
h.domElement?(h.dispatchEvent(r),h.isLocked=!0):(h.dispatchEvent(V),h.isLocked=!1)}function n(){console.error("THREE.PointerLockControls: Unable to use Pointer Lock API")}void 0===f&&(console.warn('THREE.PointerLockControls: The second parameter "domElement" is now mandatory.'),f=document.body);this.domElement=f;this.isLocked=!1;var h=this,g={type:"change"},r={type:"lock"},V={type:"unlock"},y=new THREE.Euler(0,0,0,"YXZ"),O=Math.PI/2,G=new THREE.Vector3;this.connect=function(){document.addEventListener("mousemove",
b,!1);document.addEventListener("pointerlockchange",e,!1);document.addEventListener("pointerlockerror",n,!1)};this.disconnect=function(){document.removeEventListener("mousemove",b,!1);document.removeEventListener("pointerlockchange",e,!1);document.removeEventListener("pointerlockerror",n,!1)};this.dispose=function(){this.disconnect()};this.getObject=function(){return d};this.getDirection=function(){var q=new THREE.Vector3(0,0,-1);return function(ha){return ha.copy(q).applyQuaternion(d.quaternion)}}();
this.moveForward=function(q){G.setFromMatrixColumn(d.matrix,0);G.crossVectors(d.up,G);d.position.addScaledVector(G,q)};this.moveRight=function(q){G.setFromMatrixColumn(d.matrix,0);d.position.addScaledVector(G,q)};this.lock=function(){this.domElement.requestPointerLock()};this.unlock=function(){document.exitPointerLock()};this.connect()};THREE.PointerLockControls.prototype=Object.create(THREE.EventDispatcher.prototype);THREE.PointerLockControls.prototype.constructor=THREE.PointerLockControls},function(a,
c,d){agent.state="loadScriptFailed"})}function z(a,c,d,f,b){a.add(c);var e=c.position.clone();e.x+=d;e.y+=f;e.z+=b;c.position.copy(a.worldToLocal(e));d=new THREE.Quaternion;a.getWorldQuaternion(d);c.applyQuaternion(d.inverse())}function ia(){var a=JSON.parse(JSON.stringify(agent.server.views[agent.viewIndex]));a.maxWidth=A.x;a.maxHeight=A.y;a.backColor=agent.theme.vr.monitorBox;a.id=-1;a.typeID=-1;a.focused=!1;ja=6<a.objects.length?"2column":"column";a.mode=ja;a.maintainAR=!1;agent.currentObject&&
(a.id=agent.currentObject.id,a.typeID=agent.currentObject.typeID);comms.api.loadJSON(agent.server,"stream",a,function(c,d){Aa(d.array,d.width,d.height);if(!agent.videoPlayer.playing){var f=agent.videoPlayer.play();null!==f&&(f.then(function(b){}),f["catch"](function(b){console.error(b)}))}})}function ka(a,c,d){var f=-7;x=null;for(var b=0;b<a.length;b++){var e=a[b];if(e.object.canClick&&e.object.visible){f=-e.distance+.01;x=e.object;la=e;break}if(e.object.stopRay){f=-e.distance+.01;break}}B&&(a=new THREE.Vector3,
c.ray.intersectSphere(sa,a),a&&(a.x=P(a.x),a.y=Math.max(.8,P(a.y)),a.z=P(a.z),B.position.set(a.x,a.y,a.z)));D.visible=null!==x;D.visible?(c=new THREE.Vector3,d.multiply((new THREE.Matrix4).makeTranslation(0,0,f)),d.decompose(c,new THREE.Quaternion,new THREE.Vector3),D.position.copy(c),d=new THREE.Quaternion,x.getWorldQuaternion(d),c=new THREE.Euler,c.setFromQuaternion(d),D.rotation.set(c.x,c.y,c.z)):L.visible=!p;return f}function ta(a,c,d){var f=document.createElement("canvas");f.width=parseInt(120*
c);f.height=parseInt(120*d);c=parseInt(.6*f.height);d=f.getContext("2d");d.font=c+"px Verdana";d.fillStyle=agent.theme.vr.monitorBox;d.fillRect(0,0,f.width,f.height);d.fillStyle=agent.theme.vr.text;d.fillText(a,5,3+c);a=new THREE.CanvasTexture(f);a.minFilter=a.magFilter=THREE.LinearFilter;return a}function ua(a,c,d,f){var b=new THREE.PlaneBufferGeometry(f.w,f.h);b.attributes.uv.setXY(0,c.x,c.y+c.h);b.attributes.uv.setXY(1,c.x+c.w,c.y+c.h);b.attributes.uv.setXY(2,c.x,c.y);b.attributes.uv.setXY(3,c.x+
c.w,c.y);c=new THREE.MeshBasicMaterial({color:16777215,map:S,side:THREE.DoubleSide});b=new THREE.Mesh(b,c);b.name="monitor";m.add(b);c=new THREE.PlaneBufferGeometry(1.1*f.w,1.1*(f.h+.2));var e=new THREE.MeshBasicMaterial({color:16711680,side:THREE.DoubleSide});c=new THREE.Mesh(c,e);b.alpan=c;z(b,c,0,-.1,-.01);c=va.clone();b.recFlag=c;b.obj=a;z(b,c,f.w/2-.08,f.h/2-.08,.01);c=new THREE.MeshBasicMaterial({color:agent.theme.vr.monitorBox,side:THREE.DoubleSide});c=new THREE.Mesh(new THREE.BoxBufferGeometry(f.w,
f.h+.2,.05),c);z(b,c,0,-.1,-(.025+.001));c=f.w;new THREE.PlaneBufferGeometry(c,.2);a=ta(null!==a?a.name:"",c,.2);a=new THREE.MeshBasicMaterial({map:a,side:THREE.DoubleSide});a=new THREE.Mesh(new THREE.PlaneGeometry(c,.2),a);b.label=a;z(b,b.label,0,-(f.h/2)-.1,0);b.position.set(d.x,d.y,d.z);m.add(b);return b}function P(a){return parseFloat(parseInt(5*a)/5)}function M(a,c,d,f,b,e,n,h){var g=document.createElement("canvas");g.width=64;g.height=64;var r=g.getContext("2d");r.font=agent.FontAwesome(50);
r.fillStyle=agent.theme.vr.controlBox;r.fillRect(0,0,g.width,g.height);r.fillStyle=h;r.fillText(a,n,50);a=new THREE.CanvasTexture(g);a.minFilter=a.magFilter=THREE.LinearFilter;a=new THREE.MeshBasicMaterial({map:a,side:THREE.DoubleSide});b=new THREE.Mesh(new THREE.PlaneGeometry(b,b),a);b.position.x=c;b.position.y=d;b.position.z=f;b.click=e;b.canClick=!0;b.name="button";return b}function Aa(a,c,d){array=a;a=null;for(c=0;c<array.length;c++){d=array[c];var f=agent.helpers.findObject(d.ot,d.oid);null===
f?(array.splice(c,1),c--):(d.obj=f,f===agent.currentObject&&(a=f))}null===a&&0<array.length&&(a=array[0].obj);null!==a&&(agent.currentObject=a,comms.api.command(agent.currentObject,"setaudio",null));for(c=0;c<H.length;c++)d=H[c],m.remove(d),d.geometry.dispose(),d.material.dispose(),d.alpan&&(m.remove(d.alpan),d.alpan.geometry.dispose(),d.alpan.material.dispose());H=[];f=0;var b=-(Math.PI/2),e=Math.PI/6,n=Math.PI/12,h=0,g=!0,r=!0,V=agent.server.views[agent.viewIndex];for(c=0;c<array.length;c++){d=
array[c];if(0===c)switch(ja){case "2column":f=2*d.w;break;default:f=d.w}var y=d.obj;if(null!==y){var O={x:d.x/A.x,y:(A.y-d.y)/A.y-d.h/A.y,w:d.w/A.x,h:d.h/A.y};c<V.objects.length&&(d.vr=V.objects[c].vr);d.vr||(d.vr={x:P(7*Math.cos(b+(g?e:0-e))),y:P(r?3.3:1.8),z:P(7*Math.sin(b+(g?e:0-e)))});d=ua(y,O,d.vr,{w:1.4,h:1.1});d.arrayIndex=c;d.canMove=d.canClick=!0;H.push(d);switch(h){case 0:g=!1;r=!0;break;case 1:g=!0;r=!1;break;case 2:r=g=!1;break;case 3:r=g=!0}h++;h%=4;0===h&&(e+=n)}}O={x:f/A.x,y:0,w:(A.x-
f)/A.x,h:1};agent.currentObject=a;I=ua(agent.currentObject,O,{x:0,y:2.5,z:-7},{w:6,h:4});I.stopRay=!0;I.updateLabel=function(){var G=agent.server.views[agent.viewIndex].name+": "+(null!==agent.currentObject?agent.currentObject.name:"None");0===H.length&&(G=agent.server.views[agent.viewIndex].name+": no monitors");I.label.material.map=ta(G,6,.2);I.label.material.needsUpdate=!0};I.updateLabel();H.push(I)}function E(a){N="ispydir_"+a}this.name="VR";this.shortcutKey=53;this.action="goVR";this.fps=1;this.icon=
"\uf21d";this.iconName="fa-street-view";this.supported={vr:!1,inline:!0};var ja="2column",F=null,C=this,t=null,J=null,ra=!1,pa=null,k,m,K,S,W,p,x,B,sa,D,L,va,I,wa,Q,la,N,H=[],A={x:1024,y:768},u="immersive-vr",T=null,X=null,Y=null,Z,aa,xa,ya,ba=null,v=null,ma=null,U=null,w=null,R=null,ca=!1,da=!1,ea=!1,fa=!1,na=!1;this.checkPTZ=function(){N&&(comms.api.command(agent.currentObject,"ptzcommand&field=ptz&value="+encodeURIComponent(N)),"ispydir_11"===N&&(N=null))};this.init=function(){window.isLocal&&
"https:"!==location.protocol?agent.state="vrRemoteOnly":2780>agent.server.versionNumeric?agent.state="vrUpgradeRequired":agent.isIOS&&"undefined"!==typeof DeviceMotionEvent&&"function"===typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then(function(a){"granted"===a&&oa()}):oa()};this.deinit=function(){null!==F&&F.end();if("inline"===u)l.onSessionEnd();agent.state="ok"};this.resize=function(){};this.render=function(){};this.start=function(a){u=a;t=document.createElement("canvas");
J=t.getContext("webgl",{xrCompatible:!0});K=new THREE.WebGLRenderer({canvas:t});switch(u){case "inline":$("#mainApp").hide();aspect=$(window).width()/$(window)[0].innerHeight;k=new THREE.PerspectiveCamera(90,aspect,.1,100);K.xr.enabled=!1;document.body.appendChild(t);na=!0;break;default:K.xr.enabled=!0,k=new THREE.PerspectiveCamera(90,2,.1,100)}K.setClearColor(agent.theme.vr.background,1);m=new THREE.Scene;(function(b,e){for(var n=0;n<b.length;n++){var h=b[n],g=new THREE.GridHelper(e,10,agent.theme.vr.grid,
agent.theme.vr.grid);m.add(g);g.position.set(h.pos.x,h.pos.y,h.pos.z);g.rotation.x=h.rot.x;g.rotation.y=h.rot.y;g.rotation.z=h.rot.z}})([{pos:{x:0,y:0,z:0},rot:{x:0,y:Math.PI/2,z:0}}],16);a=new THREE.PlaneBufferGeometry(16,16);var c=new THREE.MeshBasicMaterial({side:THREE.DoubleSide});c.opacity=0;c.transparent=!0;a=new THREE.Mesh(a,c);a.position.x=0;a.position.y=-.01;a.position.z=0;a.canClick="immersive-vr"===u;a.rotation.x=Math.PI/2;a.name="floor";m.add(a);var d=new THREE.CubeTexture([]);d.format=
THREE.RGBFormat;(new THREE.ImageLoader).load("images/vr/"+agent.theme.vr.skybox,function(b){var e=function(n,h){var g=document.createElement("canvas");g.width=256;g.height=256;g.getContext("2d").drawImage(b,256*-n,256*-h);return g};d.images[0]=e(2,1);d.images[1]=e(0,1);d.images[2]=e(1,0);d.images[3]=e(1,2);d.images[4]=e(1,1);d.images[5]=e(3,1);d.needsUpdate=!0});m.background=d;wa=new THREE.Vector3(0,1.6,0);a=new THREE.AmbientLight(16777215,1);m.add(a);agent.videoPlayer.playing||(a=agent.videoPlayer.play(),
null!==a&&(a.then(function(b){}),a["catch"](function(b){console.error(b)})));S=new THREE.VideoTexture(agent.videoPlayer);S.minFilter=THREE.LinearFilter;S.magFilter=THREE.LinearFilter;S.format=THREE.RGBFormat;switch(u){case "inline":l.onResize();ba=new THREE.Vector3(0,1.6,0);K.setPixelRatio(window.devicePixelRatio);v=new THREE.PointerLockControls(k,t);v.lock();k.position.set(0,1.6,0);m.add(v.getObject());$(t).on("click",function(){v.isLocked||v.lock()});break;default:ba=k.position.clone(),Q=new THREE.Object3D,
Q.add(k),k.position.set(0,1.6,0),m.add(Q)}a=new THREE.CircleGeometry(.05,30);c=new THREE.MeshBasicMaterial({color:agent.theme.vr.cursor,transparent:!0,opacity:.5,side:THREE.DoubleSide});D=new THREE.Mesh(a,c);m.add(D);D.visible=!1;a=new THREE.CircleGeometry(.01,30);c=new THREE.MeshBasicMaterial({color:agent.theme.vr.reticule,transparent:!0,opacity:.5,side:THREE.DoubleSide});L=new THREE.Mesh(a,c);L.visible=!1;L.position.z=-2;k.add(L);a=new THREE.PlaneBufferGeometry(.1,.1);c=new THREE.MeshBasicMaterial({color:agent.theme.vr.alert,
transparent:!0,opacity:.9,side:THREE.DoubleSide});va=new THREE.Mesh(a,c);sa=new THREE.Sphere(new THREE.Vector3(0,1.6,0),7);a=new THREE.MeshBasicMaterial({color:agent.theme.vr.controlBox,side:THREE.DoubleSide});a=new THREE.Mesh(new THREE.BoxBufferGeometry(1.35,.8,.1),a);T=M("\uf011",0,0,0,.2,function(){var b=agent.currentObject;b&&(b.data.online?comms.api.command(agent.currentObject,"switchoff"):comms.api.command(agent.currentObject,"switchon"))},10,agent.theme.vr.buttons);X=M("\uf192",0,0,0,.2,function(){var b=
agent.currentObject;b&&(b.data.recording?comms.api.command(agent.currentObject,"recordstop"):comms.api.command(agent.currentObject,"record"))},10,agent.theme.vr.buttons);Y=M("\uf071",0,0,0,.2,function(){var b=agent.currentObject;b&&b.data.online&&comms.api.command(agent.currentObject,"manualalert")},8,agent.theme.vr.buttons);Z=M("\uf047",0,0,0,.45,function(){var b=la.uv;if(b){b=Math.atan2(b.y-.5,b.x-.5);var e=Math.PI;if(b<=e/8&&b>=-(e/8))return E(5);if(b>e/8&&b<=3*e/8)return E(4);if(b>3*e/8&&b<=5*
e/8)return E(3);if(b>5*e/8&&b<=7*e/8)return E(2);if(b>7*e/8||b<=-(7*e/8))return E(1);if(b<-(e/8)&&b>=-(3*e/8))return E(6);if(b<-(3*e/8)&&b>=-(5*e/8))return E(7);if(b<-(5*e/8)&&b>=-(7*e/8))return E(8)}},6,agent.theme.vr.ptz);aa=M("\uf07d",0,0,0,.45,function(){var b=la.uv;b&&(.5<b.y?E(9):E(10))},20,agent.theme.vr.ptz);xa=M("\uf053",0,0,0,.2,function(){agent.viewIndex--;0>agent.viewIndex&&(agent.viewIndex=agent.server.views.length-1);ia()},10,agent.theme.vr.buttons);ya=M("\uf054",0,0,0,.2,function(){agent.viewIndex++;
agent.viewIndex===agent.server.views.length&&(agent.viewIndex=0);ia()},18,agent.theme.vr.buttons);z(a,T,-.5,.25,.051);z(a,X,-.5,0,.051);z(a,Y,-.5,-.25,.051);z(a,Z,-.1,.13,.051);z(a,aa,.4,.13,.051);z(a,xa,.27,-.25,.051);z(a,ya,.52,-.25,.051);a.position.set(0,.3,-2);a.rotation.x=-(Math.PI/4);a.stopRay=!0;m.add(a);ia();U=null;w=new THREE.Vector3;R=new THREE.Vector3;K.setAnimationLoop(C.renderXR);var f="inline"===u?"viewer":"local-floor";navigator.xr.requestSession(u,{optionalFeatures:["local-floor"]}).then(function(b){b.updateRenderState({baseLayer:new XRWebGLLayer(b,
J)});F=b;b.requestReferenceSpace(f).then(function(e){W=e;"inline"!==u?K.xr.setSession(b):b.requestAnimationFrame(C.renderXR)});"inline"===u?($(t).show(),$("#mainApp").hide(),$(document).on("mousedown",l.onSelectStart),$(document).on("mouseup",l.onSelectEnd),$(window).on("resize orientationchange",l.onResize)):(b.addEventListener("selectstart",l.onSelectStart),b.addEventListener("selectend",l.onSelectEnd),b.addEventListener("select",l.onSelect));$(document).on("keydown",l.onKeyDown);$(document).on("keyup",
l.onKeyUp);b.addEventListener("end",l.onSessionEnd);agent.state="stopVR";ma=window.setInterval(C.checkPTZ,100);agent.vrRunning=!0})};this.renderXR=function(a,c){if(c){var d=c.session;c&&C.updateInput(c);U||(U=a);if(v&&v.isLocked){var f=(a-U)/1E3;w.x-=5*w.x*f;w.z-=5*w.z*f;R.z=Number(ca)-Number(da);R.x=Number(fa)-Number(ea);R.normalize();if(ca||da)w.z-=50*R.z*f;if(ea||fa)w.x-=50*R.x*f;v.moveRight(-w.x*f);v.moveForward(-w.z*f);-8>k.position.x&&(k.position.x=-8);8<k.position.x&&(k.position.x=8);8<k.position.z&&
(k.position.z=8);-8>k.position.z&&(k.position.z=-8);U=a}for(f=0;f<H.length;f++){var b=H[f];b.lookAt(wa);b.obj?(b.alpan.visible=b.obj.data.alerted,b.recFlag.visible=b.obj.data.recording):b.recFlag.visible=b.alpan.visible=!1}T.visible=Y.visible=X.visible=Z.visible=aa.visible=!1;if(agent.currentObject&&0<H.length){f=!0;b=!1;var e=agent.server.Permissions;e&&(b=e.readOnly,f=e.ptz);T&&!b&&(T.visible=!0,Y.visible=X.visible=agent.currentObject.data.online,Z.visible=aa.visible=f&&agent.currentObject.data.online&&
2===agent.currentObject.typeID)}K.render(m,k);"inline"===u&&d.requestAnimationFrame(C.renderXR)}};this.updateInput=function(a){if(W&&F){var c=F.inputSources;if(0===c.length||"inline"===u){if("immersive-vr"===u){c=a.getViewerPose(W);a=new THREE.Matrix4;a.fromArray(c.transform.matrix);(new THREE.Vector3).setFromMatrixPosition(a);c=new THREE.Raycaster;var d=new THREE.Vector3,f=new THREE.Vector3(0,0,-1);d.setFromMatrixPosition(a);f.transformDirection(a).normalize();c.set(d,f);d=c.intersectObjects(m.children,
!0);ka(d,c,a)}else a=new THREE.Raycaster,c=new THREE.Vector3,d=new THREE.Vector3(0,0,-1),c.setFromMatrixPosition(k.matrix),a.set(c,d.transformDirection(k.matrix).normalize()),c=a.intersectObjects(m.children,!0),ka(c,a,k.matrix);L.visible=!D.visible;p&&(p.visible=!1)}else for(d=0;d<c.length;d++){var b=c[d],e=a.getPose(b.targetRaySpace,W);if(e){f=new THREE.Matrix4;f.fromArray(e.transform.matrix);e=new THREE.Vector3;e.setFromMatrixPosition(f);e.add(ba);f.setPosition(e.x,e.y,e.z);e=new THREE.Raycaster;
var n=new THREE.Vector3,h=new THREE.Vector3(0,0,-1);n.setFromMatrixPosition(f);e.set(n,h.transformDirection(f).normalize());try{var g=e.intersectObjects(m.children,!0)}catch(r){g=[]}e=ka(g,e,f.clone());"tracked-pointer"===b.targetRayMode&&(b=new Float32Array(6),b[5]=e,p||(e=new THREE.MeshBasicMaterial({color:agent.theme.vr.laser}),n=new THREE.BufferGeometry,p=new THREE.Line(n,e),p.name="laser",p.frustumCulled=!1,m.add(p)),p.geometry.setAttribute("position",new THREE.BufferAttribute(b,3)),p.geometry.attributes.position.array=
b,p.geometry.verticesNeedUpdate=!0,p.visible=!0,p.matrixAutoUpdate=!1,p.matrix.copy(f),p.updateMatrixWorld(!0),L.visible=!1)}}}};this.stop=function(){if(null!==F&&(F.end(),"inline"===u))l.onSessionEnd()};var l={onResize:function(a){a=$(window);t.width=a.width();t.height=$(window)[0].innerHeight;t.style.width=t.width+"px";t.style.height=t.height+"px";J.viewport(0,0,J.canvas.width,J.canvas.height);k.aspect=J.canvas.width/J.canvas.height;K.setSize(J.canvas.width,J.canvas.height);k.updateProjectionMatrix()},
onKeyDown:function(a){switch(a.key){case "Escape":v&&v.unlock(),C.stop()}if(v)switch(event.keyCode){case 38:case 87:ca=!0;break;case 37:case 65:ea=!0;break;case 40:case 83:da=!0;break;case 39:case 68:fa=!0}switch(event.keyCode){case 32:l.onSelectStart()}},onKeyUp:function(a){if(v)switch(event.keyCode){case 38:case 87:ca=!1;break;case 37:case 65:ea=!1;break;case 40:case 83:da=!1;break;case 39:case 68:fa=!1}switch(event.keyCode){case 32:l.onSelectEnd()}},onSelectStart:function(a){B=null;if(null!==x)switch(agent.currentObject===
x.obj&&x.canMove&&(B=x),x.name){case "monitor":agent.currentObject=x.obj;comms.api.command(agent.currentObject,"setaudio");I.obj=agent.currentObject;I.updateLabel();break;case "button":x.click&&x.click();break;case "floor":ba=a=new THREE.Vector3(D.position.x,Q.position.y,D.position.z);var c=new THREE.Vector3;c.copy(k.position);c.applyQuaternion(Q.quaternion);c.y=0;Q.position.subVectors(a,c)}},onSelectEnd:function(a){B&&"monitor"===B.name&&(agent.server.views[agent.viewIndex].objects[B.arrayIndex].vr=
{x:B.position.x,y:B.position.y,z:B.position.z},comms.api.loadJSON(agent.server,"saveviews",agent.server.views));B=null;null!==N&&(N="ispydir_11")},onSelect:function(a){},onSessionEnd:function(){F&&F.removeEventListener("end",l.onSessionEnd);"inline"===u&&($(document).off("mousedown",l.onSelectStart),$(document).off("mouseup",l.onSelectEnd),$(window).off("resize orientationchange",l.onResize));$(document).off("keydown",l.onKeyDown);$(document).off("keyup",l.onKeyUp);F=null;agent.state="startVR";$("#mainApp").show();
agent.vrRunning=!1;na&&(na=!1,document.body.removeChild(t));if(agent.videoPlayer){try{agent.videoPlayer.pause()}catch(a){console.error(a)}try{comms.api.command(agent.currentObject,"streamstop")}catch(a){console.error(a)}}ma&&window.clearInterval(ma);window.requestAnimationFrame(agent.canvas.render)}}};

//recordings.js
function recordings(){function Q(a){if(agent.shortcutKeys)for(var b=0;b<H.length;b++){var d=H[b];if(d.keyCode===a.which){R(d.cmd);break}}}function ca(a){var b=[];w&&(b.push({icon:"\uf1f8",cmd:"massdelete",keyCode:46}),b.push({icon:"\uf093",cmd:"uploadcloud",keyCode:85}),agent.isIOSApp||agent.isIOS||b.push({icon:"\uf019",cmd:"download",keyCode:68}),b.push({icon:"\uf04b",cmd:"playmulti",keyCode:81}));b.push({icon:"\uf002",cmd:"filter",keyCode:70,right:!0,highlight:agent.search.apply});b.push({icon:"\uf067",
cmd:"zoomin",keyCode:107,right:!0});b.push({icon:"\uf068",cmd:"zoomout",keyCode:109,right:!0});agent.server.Permissions&&agent.server.Permissions.readOnly||b.push({icon:"\uf044",cmd:"editMode",keyCode:69,right:!0,highlight:w});H=b;agent.helpers.drawToolbar(a,H,recordings.cmd)}function S(a){a=a.originalEvent;var b=0>a.deltaY?Math.max(a.deltaY,-20):Math.min(a.deltaY,20);agent.helpers.stopEvent(a);N(b/(E/(g[0].height-agent.sizes.topBar-agent.sizes.bottomBar)))}function N(a){T?(y+=a,y<agent.sizes.topBar&&
(y=agent.sizes.topBar),y>g[0].height-agent.sizes.bottomBar-(r[3]-r[1])&&(y=g[0].height-agent.sizes.bottomBar-(r[3]-r[1])),F=(y-agent.sizes.topBar)/(g[0].height-agent.sizes.topBar-agent.sizes.bottomBar)*E,F-a>E&&(F=E),0>F-a&&(F=0)):F=y=0}function U(a){l=agent.helpers.mouseXY(a);if(!(l.y<agent.sizes.topBar)){recordings.cmd=V(l);recordings.cmd&&agent.helpers.hoverCommand(a,recordings.cmd);var b=l.x,d=l.y;itemover=-1;var e,h;agent.isDesktop||!I||G||(K=!0);(e=a.originalEvent)&&e.changedTouches&&1<e.changedTouches.length&&
(K=!0);if(I&&K)agent.helpers.setCursor(a,"pointer"),e=d-L,console.log(d+","+L+","+e),0!==e&&(N((0-e)/(E/(g[0].height-agent.sizes.topBar-agent.sizes.bottomBar))),L=d);else if(a.target===g[0]){for(h=0;h<z.length;h++)if(e=z[h],b>e.x&&d>e.y&&b<e.x2&&d<e.y2){agent.helpers.setCursor(a,"pointer");break}G&&(agent.helpers.setCursor(a,"pointer"),e=d-L,0!==e&&(N(e),L=d));0<r.length&&b>r[0]&&d>r[1]&&b<r[2]&&d<r[3]&&agent.helpers.setCursor(a,"pointer")}}}function O(a){a.target===g[0]&&2!==a.button&&(g[0].focus(),
a.preventDefault(),n=agent.helpers.mouseXY(a),I=!0,K=!1,L=n.y,0<r.length&&n.x>r[0]&&n.y>r[1]&&n.x<r[2]&&n.y<r[3]&&(G=!0))}function W(a){for(var b=a.events.length,d=0;d<b;d++){var e=a.events[d];agent.search.apply&&e.filtered||(e.selected=a.selected)}}function V(a){for(var b=0;b<H.length;b++){var d=H[b];if(d.bounds.x<a.x&&d.bounds.x2>a.x&&d.bounds.y<a.y&&d.bounds.y2>a.y)return H[b]}return null}function da(){for(var a=[],b=0;b<agent.server.objectList.length;b++){var d=agent.server.objectList[b];if(0<
d.events.length)for(var e=d.events.length,h=0;h<e;h++){var m=d.events[h];if(!agent.search.apply||!m.filtered)if(m.selected&&a.push({device:d.name,summary:m.summary,filename:m.filename,typeID:d.typeID,id:d.id}),10<a.length)break}}0<a.length?(b={page:"download",data:{okResult:"",items:[]}},b.data.items=a,a=ko.mapping.fromJS(b),a.translate=function(q){return agent.helpers.translate(q)},editing.renderObjects.push(a),editing.helpers.renderPage()):(a=agent.helpers.translate,editing.helpers.setStatus(a("NoFilesSelected")))}
function R(a){function b(M,B){return M.time<B.time?1:-1}function d(){var M=0;A=agent.server;for(h=0;h<A.objectList.length;h++)if(p=A.objectList[h],0<p.events.length){k=p.events.length;var B=[],f=0;for(m=0;m<k;m++)if(t=p.events[m],!agent.search.apply||!t.filtered){if(t.selected){if("uploadyoutube"===a&&2!==t.parent.typeID)break;B.push({name:t.filename});M++;q?(p.events.splice(m,1),k--,m--):t.selected=!1;f++}if(f===e)break}0<f&&0<B.length&&(comms.api.load("loadjson",p,a,JSON.stringify({files:B}),function(x,
C){J||(J=!0,C.success?editing.helpers.setStatus(D("OK")):editing.helpers.setStatus(D("Error")+": "+C.status))}),h--)}0===M&&editing.helpers.setStatus(D("NoFilesSelected"))}var e=1,h=0,m,q=!1,J=!1,D=agent.helpers.translate,A=agent.server,u=null;switch(a){case "massdelete":e=agent.maxFileOperations;q=!0;u="DeleteFiles";break;case "archive":e=agent.maxFileOperations;q=!0;u="ArchiveFiles";break;case "uploadcloud":u="UploadFiles";break;case "editMode":w=!w;return;case "filter":editing.showFilter();return;
case "zoomin":v.ZoomIn();return;case "zoomout":v.ZoomOut();return;case "download":da();return;case "playmulti":u=[];for(h=0;h<A.objectList.length;h++){var p=A.objectList[h];if(0<p.events.length){var k=p.events.length;for(m=0;m<k;m++){var t=p.events[m];agent.search.apply&&t.filtered||t.selected&&u.push(t)}}}0===u.length?editing.helpers.setStatus(D("NoFilesSelected")):(u.sort(b),agent.screen.deinit(),agent.playback.init(u));return}u?editing.helpers.confirm(D(u),d):d()}function X(a){I=!1;if(!(a.target!==
g[0]||G||2===a.button||(l=agent.helpers.mouseXY(a),l.y<agent.sizes.topBar||Math.sqrt(Math.pow(l.x-n.x,2)+Math.pow(l.y-n.y,2))>agent.touchClickRadius)))if(a=V(l))R(a.cmd);else{var b=l.x,d=l.y,e;for(e=0;e<z.length;e++)if(a=z[e],b>a.x&&d>a.y&&b<a.x2&&d<a.y2){if("image"===a.cmd)if(w)a.obj.selected=!a.obj.selected;else{agent.helpers.playback(a.obj);break}if("minmax"===a.cmd){a.obj.minimized=!a.obj.minimized;break}if(w)switch(a.obj.type){case "Server":a.obj.selected=!a.obj.selected;for(b=0;b<a.obj.objectList.length;b++)d=
a.obj.objectList[b],d.selected=a.obj.selected,W(d);return;case "Device":a.obj.selected=!a.obj.selected;W(a.obj);return}}}}function P(a){I=!1;if(a.target!==g[0]||G||K)G=!1;else{l=agent.helpers.mouseXY(a);2===a.button&&(n=l);var b=Math.sqrt(Math.pow(l.x-n.x,2)+Math.pow(l.y-n.y,2));if((2===a.button||b>agent.touchClickRadius)&&!G&&agent.isDesktop&&w){b=Math.min(l.x,n.x);for(var d=Math.min(l.y,n.y),e=Math.max(l.x,n.x),h=Math.max(l.y,n.y),m=0;m<z.length;m++){var q=z[m];if("image"===q.cmd){var J=q.y,D=q.x2,
A=q.y2;q.x>e||D<b||J>h||A<d||(q.obj.selected=2===a.button||!q.obj.selected)}}}else X(a)}}function Y(a){touchstarttime=new Date;O(a)}function Z(a){agent.helpers.calcDist(n,l)<agent.touchClickRadius?X(a):P(a)}this.name="Recordings";this.action="goRecordings";this.shortcutKey=51;this.fps=10;this.icon="\uf1c8";this.iconName="fa-file-video-o";this.cmd=null;var v=this,g=null,r=[],z=[],H=[],c=null,I=!1,G=!1,y=0,F=0,E=0,l={x:0,y:0},L=0,n={x:0,y:0},w=!1,T=!1;this.scales=[{w:24,h:18,padding:4,isBig:!1,lines:1},
{w:47,h:36,padding:4,isBig:!1,lines:3},{w:72,h:54,padding:4,isBig:!1,lines:3},{w:96,h:72,padding:4,isBig:!1,lines:4},{w:144,h:108,padding:4,isBig:!1,lines:5},{w:180,h:135,padding:6,isBig:!0,lines:6},{w:216,h:162,padding:6,isBig:!0,lines:6},{w:270,h:203,padding:6,isBig:!0,lines:6},{w:320,h:240,padding:6,isBig:!0,lines:6}];this.scaleIndex=parseInt(agent.storage.get("scale",3));var K=!1;this.ZoomOut=function(){v.scaleIndex--;0>v.scaleIndex&&(v.scaleIndex=0);agent.storage.set("scale",v.scaleIndex)};this.ZoomIn=
function(){v.scaleIndex++;v.scaleIndex>v.scales.length-1&&(v.scaleIndex=v.scales.length-1);agent.storage.set("scale",v.scaleIndex)};this.render=function(){if(c){var a=agent.sizes.topBar-F;z=[];var b=v.scales[v.scaleIndex],d=b.padding,e=agent.server,h=!0,m=15*agent.sizes.font,q=agent.helpers.translate,J=q("Audio");c.font=agent.sizes.fixed+"px "+agent.theme.font;var D=c.measureText(J).width;c.beginPath();for(var A=0,u=0;u<e.objectList.length;u++){var p=e.objectList[u];if(0<p.events.length){var k=0;
h=0<a&&a<c.canvas.height;var t=!0;for(var M=p.events.length,B=0;B<M;B++){var f=p.events[B];if(!agent.search.apply||!f.filtered){A=1;if(t){a+=4;c.fillStyle=agent.theme.bars;p.selected&&w&&(c.fillStyle=agent.theme.selected);var x=agent.sizes.font+agent.sizes.padding/2;c.fillRect(0,a,c.canvas.width,x);c.fillStyle=agent.theme.foreground;c.font=agent.sizes.font+"px "+agent.theme.font;t=c.measureText(p.name);c.fillText(p.name,c.canvas.width/2-t.width/2,a+x-agent.sizes.padding/3);c.font=agent.FontAwesome(agent.sizes.font);
c.fillText(p.minimized?"\uf2d0":"\uf2d1",5,a+x-agent.sizes.padding/2);z.push({x:-1,y:a-1,x2:agent.sizes.font+agent.sizes.padding/2,y2:a+agent.sizes.font+agent.sizes.padding/2,obj:p,cmd:"minmax"});z.push({x:agent.sizes.icon+agent.sizes.padding,y:a-1,x2:c.canvas.width,y2:a+agent.sizes.font+agent.sizes.padding/2,obj:p});a+=x+2;t=!1}if(p.minimized)break;x=k+b.w+2*d;var C=a+b.h+2*d;if(h=0<C&&a<c.canvas.height){f.selected&&w&&(c.fillStyle=agent.theme.selected,c.fillRect(k,a,x-k,C-a));c.fillStyle=agent.theme.foreground;
switch(p.typeID){case 1:c.font=agent.sizes.fixed+"px "+agent.theme.font;c.fillText(J,k+d+b.w/2-D/2,a+d+b.h/2,b.w);c.beginPath();c.strokeStyle=agent.theme.grid;c.rect(k+d,a+d,b.w,b.h);c.stroke();break;case 2:h=f.thumb;b.isBig&&(h=f.bigThumb);if(!h&&!I){b.isBig?(f.bigThumb=new Image,f.bigThumb.loaded=!1,f.bigThumb.onload=function(){this.loaded=!0}):(f.thumb=new Image,f.thumb.loaded=!1,f.thumb.onload=function(){this.loaded=!0});var ea={type:"filethumb",filename:f.filename.substring(0,f.filename.lastIndexOf("."))+
(b.isBig?"_large.jpg":".jpg")};comms.api.request(f,ea,"resource",function(aa,ba){b.isBig?aa.bigThumb.src=ba:aa.thumb.src=ba})}h&&!1!==h.loaded?b.isBig?c.drawImage(f.bigThumb,k+d,a+d,b.w,b.h):c.drawImage(f.thumb,k+d,a+d,b.w,b.h):c.fillText("...",k+d,a+d,b.w);f.timelapse&&(c.fillStyle="#fff",c.fillRect(k,a,17,17),c.fillStyle="#222",c.fillText("TL",k,a+15))}z.push({x:k,y:a,x2:x+m,y2:C,obj:f,cmd:"image"});k=f.summary.split("|");""!==f.tags&&k.push(f.tags);c.fillStyle=agent.theme.foreground;c.font=agent.sizes.font+
"px "+agent.theme.font;for(f=0;f<k.length&&(c.fillText(k[f].trim(),x+4,a+2+agent.sizes.font*(f+1)),f+1!==b.lines);f++);k=x+4+m;k+b.w+2*d+4+m>c.canvas.width&&(k=0,a=C+4)}0<b.lines?(k=x+4+m,k+b.w+2*d+4+m>c.canvas.width&&(k=0,a=C+4)):(a=C+agent.sizes.padding,k=0)}}0<k&&(a=a+b.h+2*d+4)}}c.stroke();0===A&&agent.helpers.centerText(c,q("NothingToDisplay"));I&&!G&&!K&&w&&agent.isDesktop&&(c.beginPath(),e=c.lineWidth,c.lineWidth=2,c.strokeStyle="rgba(115,185,255,1.0)",c.moveTo(n.x,n.y),c.lineTo(l.x,n.y),c.lineTo(l.x,
l.y),c.lineTo(n.x,l.y),c.lineTo(n.x,n.y),c.stroke(),c.lineWidth=e);E=F+a+b.h+2*d+4+agent.sizes.bottomBar+agent.sizes.topBar;N(0);if(T=E-agent.sizes.topBar-agent.sizes.bottomBar>g[0].height)c.beginPath(),c.fillStyle=agent.theme.scrollbar,a=Math.max(agent.scrollbars.minHeight,g[0].height/E*g[0].height),c.fillRect(g[0].width-agent.scrollbars.width,y,agent.scrollbars.width,a),r=[g[0].width-agent.scrollbars.width,y,g[0].width-1,y+a];ca(c)}};this.resize=function(){};this.deinit=function(){g&&($(document.body).off("mousemove touchmove",
U),agent.isAndroidApp||($(window).off("mouseup",P),g.off("mousedown",O)),g.off("keydown",Q),g.off("touchstart",Y),g.off("touchend",Z),g.off("wheel",S))};this.init=function(){g=agent.mainCanvas;c=agent.ctx;$(document.body).on("mousemove touchmove",U);agent.isAndroidApp||($(window).on("mouseup",P),g.on("mousedown",O));g.on("keydown",Q);g.on("touchstart",Y);g.on("touchend",Z);g.on("wheel",S);agent.server.Permissions&&agent.server.Permissions.readOnly&&(w=!1)}};

//timeline.js
function timeline(){function aa(){for(var a=agent.server.objectList,c=0;c<a.length;c++){var d=a[c];2===d.typeID&&d.data.online&&comms.api.request(d,{type:"liveimage",width:96,height:72},"resource",function(f,n){f.nextThumb||(f.nextThumb=new Image,f.nextThumb.obj=f,f.nextThumb.onload=function(){var r=this.obj;r.thumb=r.nextThumb});f.nextThumb.src=n})}}function D(){b.preventFuture&&b.endDate>new Date&&(b.endDate=new Date);b.endDate<=b.startDate&&(b.startDate=new Date,b.startDate.setTime(b.endDate.getTime()),
b.startDate=b.startDate.addHours(-8));u=b.startDate.getTime();U=b.endDate.getTime();x=(U-u)/(g[0].width-b.colWidth);I=(U-u)/1E3;y="seconds";60<I&&(y="minutes");3600<I&&(y="hours");129600<I&&(y="days");2592E3<I&&(y="months");47304E3<I&&(y="years")}function oa(a){return function(c,d){return c[a]>d[a]?1:c[a]<d[a]?-1:0}}function ba(a){for(var c=0;c<E.length;c++){var d=E[c];if(d.bounds.x<a.x&&d.bounds.x2>a.x&&d.bounds.y<a.y&&d.bounds.y2>a.y)return E[c]}return null}function pa(a){var c=[];c.push({icon:"\uf002",
cmd:"filter",keyCode:70,right:!0,highlight:agent.search.apply});c.push({icon:"\uf067",cmd:"zoomin",keyCode:107,right:!0});c.push({icon:"\uf068",cmd:"zoomout",keyCode:109,right:!0});E=c;agent.helpers.drawToolbar(a,E,timeline.cmd)}function qa(){e.clearRect(0,agent.sizes.topBar,w,L);e.beginPath();var a=agent.sizes.topBar+agent.sizes.font+2*agent.sizes.padding;e.lineWidth=.5;e.moveTo(b.colWidth+5,a);e.lineTo(w,a);e.font=agent.sizes.font+"px "+agent.theme.font;e.fillText(b.startDate.formatDate(b.timeFormatSmall),
b.colWidth+3,a-agent.sizes.padding);var c=b.endDate.formatDate(b.timeFormatSmall);textWidth=e.measureText(c);e.fillText(c,w-textWidth.width-3,a-agent.sizes.padding);var d=null;c=-60;for(i=b.colWidth+c;i<w;i+=b.accuracy){var f=new Date;f.setTime(u+x*(i-b.colWidth));d||(d=f);var n=!1;switch(y){case "seconds":n=f.getSeconds()!==d.getSeconds();break;case "minutes":n=f.getMinutes()!==d.getMinutes();break;case "hours":n=f.getHours()!==d.getHours();break;case "days":n=f.getDay()!==d.getDay();break;case "months":n=
f.getMonth()!==d.getMonth();break;case "years":n=f.getYear()!==d.getYear()}if(n){var r=30>i-c;r||(c=i);n=i;var m=f,A=a,q=d;d=r;r=5;var p="";e.fillStyle=agent.theme.foreground;e.lineWidth=.5;e.font=agent.sizes.font+"px "+agent.theme.font;switch(y){case "seconds":p=m.getSeconds();m.getMinutes()!==q.getMinutes()&&(q=m.getHours()+":",m=m.getMinutes(),p=q+(10>m?"0"+m:m),r=agent.sizes.font);break;case "minutes":p=m.getMinutes();m.getHours()!==q.getHours()&&(p=m.getHours(),r=agent.sizes.font);break;case "hours":p=
m.getHours();m.getDay()!==q.getDay()&&(p=dayNames[m.getDay()],r=agent.sizes.font);break;case "days":p=m.getDate();m.getMonth()!==q.getMonth()&&(p=monthNames[m.getMonth()],r=agent.sizes.font);break;case "months":p=monthNames[m.getMonth()];m.getFullYear()!==q.getFullYear()&&(p=m.getFullYear(),r=agent.sizes.font);break;case "years":p=m.getFullYear()}r===agent.sizes.font&&(d=!1,e.font=agent.theme.fontLarge);d||(e.moveTo(n,A),e.lineTo(n,A+r),e.fillText(p,n,A+r+agent.sizes.font))}d=f}e.stroke()}function V(a){ca?
(B+=a,B<agent.sizes.topBar&&(B=agent.sizes.topBar),B>g[0].height-agent.sizes.bottomBar-(t[3]-t[1])&&(B=g[0].height-agent.sizes.bottomBar-(t[3]-t[1])),C=(B-agent.sizes.topBar)/(g[0].height-agent.sizes.topBar-agent.sizes.bottomBar)*F,C-a>F&&(C=F),0>C-a&&(C=0)):C=B=0}function da(a){a=a||(g[0].width-b.colWidth)/2;if(y!==b.maxScale){var c=g[0].width-b.colWidth;a/=c;var d=1-a;b.startDate=new Date;b.startDate.setTime(u+a/2*c*x);b.endDate=new Date;b.endDate.setTime(u+(c-d/2*c)*x);D()}}function ea(a){a=a||
(g[0].width-b.colWidth)/2;if(y!==b.minScale){var c=g[0].width-b.colWidth;a/=c;var d=1-a;b.startDate=new Date;b.startDate.setTime(u-a*c*x);b.endDate=new Date;b.endDate.setTime(u+(c+d*c)*x);D()}}function fa(a){if(!G){agent.helpers.stopEvent(a);var c=a.pageX-g.offset().left;a=a.originalEvent;0>a.deltaY?da(c-b.colWidth):ea(c-b.colWidth)}}function W(a){if(!(G||(k=agent.helpers.mouseXY(a),k.y<agent.sizes.topBar))){timeline.cmd=ba(k);timeline.cmd&&agent.helpers.hoverCommand(a,timeline.cmd);var c=k.y;M=!1;
J&&agent.helpers.calcDist({x:H.x,y:H.y},{x:H.x,y:k.y})>2*agent.touchClickRadius&&!N&&(M=!0);if(a.target===g[0]){if(J&&M){agent.helpers.setCursor(a,"pointer");var d=c-X;0!==d&&(V((0-d)/(F/(g[0].height-agent.sizes.topBar-agent.sizes.bottomBar))),X=c)}k.x>b.colWidth&&k.y<agent.sizes.bottomBar&&agent.helpers.setCursor(a,"w-resize");N&&k.y>L?(agent.helpers.setCursor(a,"pointer"),d=k.y-Q.y,0!==d&&(V(d),agent.helpers.setCursor(a,"default"))):J&&(d=k.x-Q.x,0!==d&&(c=g[0].width-b.colWidth-d,b.startDate=new Date,
b.startDate.setTime(u+x*(0-d)),b.endDate=new Date,b.endDate.setTime(u+x*c),D()));Q={x:k.x,y:k.y};0<t.length&&k.x>t[0]&&k.y>t[1]&&k.x<t[2]&&k.y<t[3]?agent.helpers.setCursor(a,"pointer"):!J&&!N&&!a.originalEvent.touches&&agent.isDesktop&&k.x>b.colWidth&&(d=ha(R,k.x,k.y),null!==d&&agent.helpers.setCursor(a,"pointer"))}}}function ia(a){switch(a){case "filter":editing.showFilter();break;case "zoomin":da();break;case "zoomout":ea()}}function Y(a){k=agent.helpers.mouseXY(a);2===a.button&&(H=k);var c=k.x,
d=k.y;if(!(agent.helpers.calcDist(H,k)>agent.touchClickRadius)){var f=ba(k);f?ia(f.cmd):c>b.colWidth&&2!==a.button&&(f=ha(R,c,d),null!==f&&agent.helpers.playback(f.obj))}}function ha(a,c,d){for(var f=0;f<a.length;f++){var n=a[f];if(!(c<n.x||c>n.x2||d<n.y||d>n.y2))return n}return null}function Z(a){if(a.target===g[0]&&2!==a.button){g[0].focus();a.preventDefault();k=agent.helpers.mouseXY(a);a=k.x;var c=k.y;X=k.y;H={x:a,y:c};Q={x:k.x,y:k.y};M=!1;0<t.length&&a>t[0]&&c>t[1]&&a<t[2]&&c<t[3]?N=!0:J=!0}}
function ja(a){var c=a.originalEvent;c&&c.touches&&2===c.touches.length?(G=!0,O=agent.helpers.calcDist({x:c.touches[0].pageX,y:c.touches[0].pageY},{x:c.touches[1].pageX,y:c.touches[1].pageY}),P=0):(touchstarttime=new Date,Z(a))}function ka(a){var c=a.originalEvent;if(c&&c.touches&&2===c.touches.length){if(a=agent.helpers.calcDist({x:c.touches[0].pageX,y:c.touches[0].pageY},{x:c.touches[1].pageX,y:c.touches[1].pageY}),G||(G=!0,O=a),0<O){P=a/O-1;if(0<P){if(y===b.maxScale)return}else if(y===b.minScale)return;
O=a;var d=g.offset().left;a=g[0].width-b.colWidth;c=((c.touches[0].pageX+c.touches[1].pageX)/2-b.colWidth-d)/a;d=1-c;b.startDate=new Date;b.startDate.setTime(u+c*P*a*x);b.endDate=new Date;b.endDate.setTime(u+(a-d*P*a)*x);D()}}else W(a)}function S(){M=N=J=!1}function la(a){G?(G=!1,S(a)):agent.helpers.calcDist(H,k)<agent.touchClickRadius?Y(a):S(a)}function ma(a){if(agent.shortcutKeys)for(var c=0;c<E.length;c++){var d=E[c];if(d.keyCode===a.which){ia(d.cmd);break}}}this.name="TimeLine";this.action="goTimeline";
this.shortcutKey=50;this.icon="\uf133";this.iconName="fa-calendar-o";this.fps=10;var g=null;this.cmd=null;var b={preventFuture:!1,maxScale:"seconds",minScale:"years",rulerLines:!0,thumbWidth:96,thumbHeight:72,minEventWidth:25,accuracy:3,colWidth:100,hideNoEvents:!1,endDate:null,showThumbs:!1,startDate:null,timeFormat:"MMM dd yyyy hh:mm:ss t",timeFormatSmall:"MMM dd HH:mm:ss"},na=null,e;this.playfile=null;var R=[],E=[],J=!1,N=!1,B=0,C=0,F=0,L=0,t=[],k={x:0,y:0},Q={x:0,y:0},H={x:0,y:0},G=!1,O=0,P=0,
M=!1,X=0,ca=!1,u,U,I,y,x;this.FocusTime=function(a){b.startDate=new Date;b.startDate.setTime(a);b.endDate=new Date;b.endDate.setTime(a);b.endDate=b.endDate.addMinutes(30);D()};this.render=function(){if(e){w=agent.size.w;h=agent.size.h;var a=agent.helpers.translate;e.strokeStyle=agent.theme.foreground;e.fillStyle=agent.theme.foreground;e.font=agent.sizes.font+"px "+agent.theme.font;L=2*agent.sizes.fontLarge+4*agent.sizes.padding;var c=L+agent.sizes.topBar+agent.sizes.padding-C;R=[];var d=agent.server;
var f=!0;var n=a("Off");a=a("On");for(var r=e.measureText(n).width,m=e.measureText(a).width,A=0;A<d.objectList.length;A++){var q=d.objectList[A];if(!(1===q.typeID&&-1<q.data.pairid)){var p=q.events.length;if(0!==p||!b.hideNoEvents){if(f=c>L-b.thumbHeight-agent.sizes.padding&&c<h){e.lineWidth=1;if(b.showThumbs){f=null;if(q.data.online)switch(q.typeID){case 1:e.fillText(a,b.thumbWidth/2-m/2,b.thumbHeight/2+c);break;case 2:f=q.thumb}else e.fillText(n,b.thumbWidth/2-r/2,b.thumbHeight/2+c);f&&e.drawImage(f,
2,c,b.thumbWidth,b.thumbHeight)}e.strokeStyle=agent.theme.grid;f=[];var l=b.thumbHeight/2,T=null;for(--p;-1<p;p--){var v=d.objectList[A].events[p];if(!agent.search.apply||!v.filtered){var z=parseInt(b.colWidth+(v.timeEnd-u)/x);if(z+b.minEventWidth>b.colWidth){var K=parseInt(b.colWidth+(v.time-u)/x);if(K<w){z=Math.max(b.colWidth,Math.max(z,K+b.minEventWidth));var ra=z>T||v.timelapse;K=Math.max(K,b.colWidth);ra?(v.x=K,v.y=c,v.timelapse||(T=z),f.push({v:v.maxalarm,x:K,y:c+6+(v.timelapse?l:0),x2:z,y2:c+
b.thumbHeight,ev:v})):0<f.length&&(z=f[f.length-1],!z.ev.timelapse&&z.v<v.maxalarm&&(z.v=v.maxalarm,z.ev=v))}else break}}}f.sort(oa("v"));for(p=0;p<f.length;p++)l=f[p],e.fillStyle=l.ev.color,e.fillRect(l.x,l.y,l.x2-l.x,l.y2-l.y),R.push({x:l.x,y:l.y,x2:l.x2,y2:l.y2,obj:l.ev}),2===l.ev.ot&&l.x2-l.x>b.thumbWidth&&!l.ev.timelapse&&(l.ev.thumb?l.ev.thumb.loaded&&e.drawImage(l.ev.thumb,l.x,l.y,b.thumbWidth,b.thumbHeight):(l.ev.thumb=new Image,l.ev.thumb.loaded=!1,l.ev.thumb.onload=function(){this.loaded=
!0},T={type:"filethumb",filename:l.ev.filename.substring(0,v.filename.lastIndexOf("."))+".jpg"},comms.api.request(l.ev,T,"resource",function(sa,ta){sa.thumb.src=ta})));q=d.objectList[A].events.length+": "+q.name;f=e.measureText(q);e.fillStyle=agent.theme.bars;e.fillRect(b.colWidth,c-1,f.width+2*agent.sizes.padding,agent.sizes.font+4);e.fillStyle=agent.theme.foreground;e.fillText(q,b.colWidth+agent.sizes.padding,c+agent.sizes.font-1);b.rulerLines&&A<d.objectList.length&&(q=c,e.beginPath(),e.lineWidth=
.5,e.moveTo(b.colWidth,q),e.lineTo(w-2,q),e.stroke())}c+=b.thumbHeight+agent.sizes.padding}}}e.stroke();qa();F=c+C+agent.sizes.bottomBar+agent.sizes.topBar+b.thumbHeight;V(0);if(ca=F-agent.sizes.topBar-agent.sizes.bottomBar>g[0].height)e.beginPath(),e.fillStyle=agent.theme.scrollbar,c=Math.max(agent.scrollbars.minHeight,g[0].height/F*g[0].height),e.fillRect(g[0].width-agent.scrollbars.width,B,agent.scrollbars.width,c),t=[g[0].width-agent.scrollbars.width,B,g[0].width-1,B+c];pa(e)}};this.resize=function(){agent.server&&
(b.showThumbs&&(b.colWidth=b.thumbWidth+5),D())};this.init=function(){g=agent.mainCanvas;e=agent.ctx;b.endDate||(b.endDate=new Date,b.startDate=(new Date).addHours(-8));$(document.body).on("mousemove touchmove",W);$(window).on("mouseup",S);g.on("mousedown",Z);g.on("touchstart",ja);g.on("touchend",la);g.on("touchmove",ka);g.on("wheel",fa);g.on("click",Y);g.on("keydown",ma);b.showThumbs?(aa(),na=window.setInterval(aa,2E3)):b.colWidth=0;D()};this.deinit=function(){g&&($(document.body).off("mousemove touchmove",
W),$(window).off("mouseup",S),g.off("mousedown",Z),g.off("touchstart",ja),g.off("touchend",la),g.off("touchmove",ka),g.off("wheel",fa),g.off("click",Y),g.off("keydown",ma),window.clearInterval(na))}};

//wizard.js
var wizard={make:"",step:0,username:"",password:"",channel:0,editObject:null,decoder:"",ipaddress:"",networkDevices:[],scanActive:!1,networkScanActive:!1,connections:[],lastConnections:0,pollDevice:null,load:function(){var a=agent.helpers.translate;editing.helpers.setStatus(a("Loading"));comms.api.command(agent.server,"getscannetworkresults",function(c,b){editing.helpers.setStatus("");b.results&&(wizard.networkDevices=b.results);wizard.step=0;wizard.show()})},next:function(){var a=ko.toJS(editing.currentRenderObject().data).sections[0].items;
switch(wizard.step){case 0:wizard.username=a[1].value;wizard.password=a[2].value;wizard.channel=a[3].value;wizard.decoder=a[4].value;wizard.step=1;break;case 1:wizard.ipaddress=a[2].value,wizard.step=2,wizard.scanDevice()}if((a=editing.renderObjects.pop())&&a.onclose)a.onclose();wizard.show()},back:function(){wizard.step=Math.max(0,wizard.step-1);var a=editing.renderObjects.pop();if(a&&a.onclose)a.onclose();wizard.show()},show:function(){wizard.lastConnections=0;var a=agent.helpers.translate,c={page:"render",
sz:"md",cancelOnly:!0,data:{header:a("Wizard"),okResult:"",sections:[{header:a("CameraDetails"),displayType:"Form",tabActive:!0}]}},b=[];switch(wizard.step){case 0:b=[{text:a("Make"),value:wizard.make,type:"TypeAheadServer",help:a("Make_help")},{text:a("CameraUsername"),value:wizard.username,type:"String"},{text:a("CameraPassword"),value:wizard.password,type:"Password"},{text:a("Channel"),value:wizard.channel,type:"Int32",help:a("Channel_help"),min:0,max:9999999},{text:a("Decoder"),value:wizard.decoder,
type:"Select",options:[{text:"FFMPEG",value:""},{text:"VLC",value:"vlc"},{text:"GPU",value:"gpu"}]},{value:a("Next"),type:"Button",action:"wizNext"}];break;case 1:c.data.header=a("IPAddress");wizard.connections=[];b=wizard.ipaddress;""===b&&(b="http://192.168.0.0");b=[{type:"HTML",value:wizard.makeList()},{text:a("Or"),value:b,type:"Header"},{text:a("IPAddress"),value:b,type:"String",help:a("IPAddress_help")},{value:a("Next"),type:"Button",action:"wizNext"}];break;case 2:c.data.header=a("Connections"),
b=[{type:"HTML",value:'<span style="position:absolute;right:20px;top:-55px" class="spinner-grow spinner-grow-sm" id="spinnerScanDevice" role="status" aria-hidden="true"></span>'},{text:"",type:"PlaceHolder",id:"connections"}]}0===wizard.step&&0<wizard.connections.length&&(c.extraFooter='<input type="button" class="btn btn-primary" value="'+a("PreviousResults")+'" onclick="wizard.showResults()"/>');0<wizard.step&&(c.extraFooter='<input type="button" class="btn btn-primary" value="'+a("Back")+'" onclick="wizard.back()"/>');
c.data.sections[0].items=b;a=ko.mapping.fromJS(c);2===wizard.step&&(a.onclose=wizard.stopScanDevice);editing.renderObjects.push(a);editing.helpers.renderPage("md");$(".typeahead-ctrl").typeahead({minLength:3,highlight:!0,autoselect:!0,items:35,sortResults:!1,matcher:function(e){return!0},source:function(e,f){comms.api.command(agent.server,"loadmakesmodels&search="+encodeURIComponent(e),function(d,g){return f(g.makes)})},updater:function(e){return wizard.make=e}});2===wizard.step&&wizard.renderConnections()},
showResults:function(){editing.renderObjects.pop();wizard.step=2;wizard.show();$("#spinnerScanDevice").hide()},getResults:function(){comms.api.command(agent.server,"getscannetworkresults",function(a,c){wizard.networkDevices=c.results;var b=wizard.makeList();wizard.lastResults!==b&&($("#pnlScanNetworkResults").parent().html(b),wizard.lastResults=b);c.finished?wizard.networkScanActive=!1:(wizard.networkScanActive=!0,setTimeout(wizard.getResults,1E3))})},setAddr:function(a){wizard.ipaddress=a;wizard.step=
2;editing.renderObjects.pop();wizard.scanDevice();wizard.show()},makeList:function(){for(var a=wizard.networkDevices,c="",b=agent.helpers.translate,e=0;e<a.length;e++){var f=a[e],d=f.IPAddress+":"+f.port,g=f.deviceName;"Unknown"===g&&(g="");""!==f.webServer&&(g+=" "+f.webServer);g=agent.helpers.shorten(g,80);""===g&&(g="Unknown");d=443===f.port?"https://"+d:"http://"+d;window.isLocal&&(g='<a href="'+d+'" target="_blank">'+g+"</a>");g+="<br/>"+f.IPAddress+":"+f.port;""!==a[e]&&(c+='<tr><td class="wordbreak">'+
g+'</td><td><button type="button" class="btn btn-primary btn-sm" onclick="wizard.setAddr(\''+d+"')\">"+b("Use")+"</button></td></tr>")}return'<span style="position:absolute;right:20px;top:-55px"><button type="button" class="btn btn-primary btn-sm" onclick="wizard.scanNetwork() " title="Reload"><i class="fa fa-refresh fa-sm"> </i></button></span><div class="scrollDiv" id="pnlScanNetworkResults"><table class="table table-bordered table-striped agentTable"><tbody>'+(c+"</tbody></table></div>")},scanNetwork:function(){wizard.lastResults=
"";wizard.networkScanActive?comms.api.command(agent.server,"scannetwork",function(){wizard.networkScanActive=!1;$("#btnScanNetwork").html(t("ScanNetwork"))}):comms.api.command(agent.server,"scannetwork",function(a,c){var b=agent.helpers.translate;editing.helpers.setStatus(b("ScanningNetwork"));wizard.networkScanActive=!0;wizard.getResults()})},scanDevice:function(){if(wizard.scanActive)wizard.stopScanDevice();else{-1===wizard.ipaddress.indexOf("://")&&(wizard.ipaddress="http://"+wizard.ipaddress);
var a="scandevice&makemodel="+encodeURIComponent(wizard.make);a+="&username="+encodeURIComponent(wizard.username);a+="&password="+encodeURIComponent(wizard.password);a+="&channel="+encodeURIComponent(wizard.channel);a+="&decoder="+encodeURIComponent(wizard.decoder);a+="&url="+encodeURIComponent(wizard.ipaddress);wizard.connections=[];wizard.lastConnections=0;comms.api.command(agent.server,a,function(c,b){b.running?(wizard.pollDevice&&(clearInterval(wizard.pollDevice),wizard.pollDevice=null),wizard.pollDevice=
setInterval(wizard.refresh,1E3),wizard.scanActive=!0):($("#spinnerScanDevice").hide(),b.error&&(editing.helpers.setStatus(b.error),wizard.step=0,editing.renderObjects.pop(),wizard.show()))})}},refresh:function(){comms.api.command(agent.server,"getscandeviceresults",function(a,c){wizard.connections=c.results;var b=agent.helpers.translate;if(c.finished&&(wizard.stopScanDevice(),0===wizard.connections.length)){$("#connections").html(b("NothingFound"));return}wizard.renderConnections()})},renderConnections:function(){var a=
agent.helpers.translate;if(wizard.lastConnections!==wizard.connections.length){wizard.lastConnections=wizard.connections.length;var c='<tr><th>{0}</th><th title="{1}">{2}</th><td><button type="button" class="btn btn-sm btn-info" title="Use" onclick="wizard.choose({3})">'+a("Use")+"</button></td></tr>",b=$("#connections");if(0<b.length){var e="";if(0<wizard.connections.length){e=e+'<table class="table table-bordered table-striped agentTable"><thead><tr><th>'+(a("Type")+"</th><th>"+a("URL")+"</th><th></th></tr></thead><tbody>");
for(a=0;a<wizard.connections.length;a++){var f=wizard.connections[a];e+=c.f(f.type,f.URL,agent.helpers.shortenURL(f.URL,30),a)}e+="</tbody></table>"}b.html(e)}}},stopScanDevice:function(){wizard.pollDevice&&(clearInterval(wizard.pollDevice),wizard.pollDevice=null);comms.api.command(agent.server,"stopscandevice");wizard.scanActive=!1},choose:function(a){a=wizard.connections[a];editing.ui.teardown(!0,!1);if(2480>agent.server.versionNumeric){var c=$("#txtVideoURL");if(c.length){c.val(a.URL).change();
return}}c=editing.newDevice.alerts?1:0;var b=editing.newDevice.record?1:0,e=editing.newDevice.resize?1:0,f=editing.newDevice.raw?1:0,d="createfromwizard&ot=2&channel="+wizard.channel;d+="&mmid="+a.mmid;d+="&url="+encodeURIComponent(a.URL);d+="&username="+encodeURIComponent(wizard.username);d+="&password="+encodeURIComponent(wizard.password);d+="&makemodel="+encodeURIComponent(wizard.make);d=d+("&alerts="+c)+("&record="+b)+("&resize="+e);d+="&raw="+f;d+="&decoder="+encodeURIComponent(wizard.decoder);
null!==wizard.editObject&&(d+="&oid="+wizard.editObject.id);var g=agent.helpers.translate;editing.helpers.setStatus(g("Loading"));$("body").css("pointer-events","none");comms.api.command(agent.server,d,function(k,h){wizard.editObject?(editing.helpers.setStatus(g("Loading")),setTimeout(editing.editObject,3E3,wizard.editObject)):editing.openDevice={ot:h.typeID,id:h.id,wait:!0}})}};

//# sourceURL=script/monitor.min.js